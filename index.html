<!-- ============================================================
  IGELPFLEGESTATION PRO — v1.8.42
  Stand: Februar 2026 | Entwickler: Denis (Deutschland)
  Deployment: https://dstindl.github.io/IGEL/ (GitHub Pages)
  Datei: index.html (Single-File React + Firebase PWA)
  ─────────────────────────────────────────────────────────────
  TECH-STACK:
    React 18 (Babel/JSX via CDN) · Tailwind CSS (CDN)
    Firebase 10.7.1 (Auth + Firestore) · QRCode.js · jsQR
    Lucide Icons · Nominatim API (Adress-Autocomplete)
  ─────────────────────────────────────────────────────────────
  DESIGN-SYSTEM (KRITISCH):
    Schwarz/Weiß minimalistisch · Kein Farb-Noise außer Navbar
    Felder:  border-gray-200 rounded-xl px-4 py-3 text-sm
    Buttons: bg-gray-900 text-white rounded-xl py-3 text-sm
    Labels:  text-xs uppercase tracking-wide text-gray-500
    Dialog:  p-5 border-b rounded-2xl
    NIEMALS: bg-gradient · prompt()/confirm() · Emojis als Icons
  ─────────────────────────────────────────────────────────────
  FIREBASE COLLECTIONS:
    users · hedgehogs · invites · auditLog
  ─────────────────────────────────────────────────────────────
  STATUS-WERTE:
    aufnahme · pflege · ueberwinterung
    auswilderung_bereit · ausgewildert · verstorben
  ─────────────────────────────────────────────────────────────
  LETZTES UPDATE: v1.8.42 — E-Mail-Bug (InviteRegistration) behoben:
    direktes Passwort-Formular statt zweiter E-Mail;
    actionCodeSettings; Versionsnummer überall konsistent
  ============================================================ -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Igelpflegestation Pro</title>
  <link rel="manifest" href="manifest.json">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #64748b;
      --success: #2563eb;
      --danger: #ef4444;
      --warning: #2563eb;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-600: #475569;
      --gray-900: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    * { 
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    body { 
      overscroll-behavior-y: contain;
      background: var(--gray-50);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    input, textarea, select { 
      font-size: 16px !important;
      transition: all 0.2s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .card {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .card:active {
      transform: translateY(0);
    }
    
    .btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      border-radius: 8px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    
    .stat-card:hover {
      box-shadow: var(--shadow-md);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .slide-in {
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .input-error {
      border-color: var(--danger) !important;
      background-color: #fef2f2 !important;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    
    /* Sidebar CSS */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 240px;
      height: 100vh;
      background: white;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.25s ease;
      z-index: 1000;
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 999;
    }
    
    .sidebar-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #64748b;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .sidebar-item:hover {
      background: #f8fafc;
      color: #2563eb;
    }
    
    .sidebar-item svg {
      flex-shrink: 0;
    }
  </style>
  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    /* Print styles for QR Code */
    @media print {
      body * { visibility: hidden; }
      #qr-print-area, #qr-print-area * { visibility: visible; }
      #qr-print-area {
        position: fixed;
        left: 0; top: 0;
        width: 7cm;
        padding: 0.4cm;
        background: white;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      #qr-print-area .qr-print-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      #qr-print-area #qrcode-container {
        width: 2.5cm !important;
        height: 2.5cm !important;
        margin: 0 auto;
        flex-shrink: 0;
      }
      #qr-print-area #qrcode-container img,
      #qr-print-area #qrcode-container canvas {
        width: 2.5cm !important;
        height: 2.5cm !important;
        display: block;
      }
      .no-print { display: none !important; }
    }

    /* Toggle Switch */
    .toggle-track {
      position: relative;
      display: inline-flex;
      align-items: center;
      width: 44px;
      height: 24px;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s;
      background: #d1d5db;
      flex-shrink: 0;
    }
    .toggle-track.on { background: #111827; }
    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 9999px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .toggle-track.on .toggle-thumb { transform: translateX(20px); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyD1LbzZGypzSYvRC-RRNvT2JUTpPRMM8E4",
      authDomain: "igelstation-3c3db.firebaseapp.com",
      projectId: "igelstation-3c3db",
      storageBucket: "igelstation-3c3db.firebasestorage.app",
      messagingSenderId: "695889743897",
      appId: "1:695889743897:web:6ca27f35d25639c66b9a88"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();


    // ===========================================
    // PHASE 1.4 - UTILITY FUNCTIONS
    // ===========================================
    
    // Input Validation (Punkt 3 & 4)
    const validateInput = {
      weight: (value) => {
        if (!value) return { valid: true, value: '', error: '' };
        const cleaned = value.replace(/[^\d.]/g, '');
        const parts = cleaned.split('.');
        if (parts.length > 2) return { valid: false, value, error: 'Ungültiges Format' };
        const final = parts.length === 2 ? parts[0] + '.' + parts[1] : parts[0];
        const num = parseFloat(final);
        if (num > 9999) return { valid: false, value, error: 'Max 9999g' };
        return { valid: true, value: final, error: '' };
      },
      
      phone: (value) => {
        if (!value) return { valid: true, value, error: '' };
        const cleaned = value.replace(/[^\d+\-/() ]/g, '');
        return { valid: true, value: cleaned, error: '' };
      },
      
      text: (value) => {
        if (!value) return { valid: true, value, error: '' };
        const cleaned = value.replace(/[^a-zA-ZäöüÄÖÜß0-9\-,.\\/ ]/g, '');
        return { valid: true, value: cleaned, error: '' };
      }
    };
    
    // CSV Export (Punkt 7)
    
    // CSV Import Parser (Punkt 8)
    const parseCSV = (csvText) => {
      const lines = csvText.split('\n').filter(line => line.trim());
      if (lines.length < 2) return { success: false, error: 'CSV-Datei ist leer', data: [] };
      
      const headerLine = lines[0];
      const headers = headerLine.split(',').map(h => h.replace(/^"|"$/g, '').trim());
      
      const expectedHeaders = ['Igel-ID', 'Name', 'Status', 'Aufnahmedatum', 'Geschlecht'];
      const hasRequired = expectedHeaders.every(h => headers.includes(h));
      
      if (!hasRequired) {
        return { success: false, error: 'Fehlende Pflichtfelder: ' + expectedHeaders.join(', '), data: [] };
      }
      
      const data = [];
      const errors = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        const fields = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            fields.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        fields.push(current);
        
        const row = {};
        headers.forEach((header, index) => {
          row[header] = fields[index] ? fields[index].trim() : '';
        });
        
        const igelId = row['Igel-ID'] || '';
        const name = row['Name'] || '';
        const status = row['Status'] || '';
        const aufnahmedatum = row['Aufnahmedatum'] || '';
        const geschlecht = row['Geschlecht'] || '';
        
        if (!igelId || !name || !status || !aufnahmedatum || !geschlecht) {
          errors.push(`Zeile ${i + 1}: Pflichtfelder fehlen`);
          continue;
        }
        
        const validStatuses = ['aufnahme', 'pflege', 'ueberwinterung', 'auswilderung_bereit', 'ausgewildert', 'verstorben'];
        if (!validStatuses.includes(status)) {
          errors.push(`Zeile ${i + 1}: Ungültiger Status`);
          continue;
        }
        
        data.push({
          igelId, name, status, aufnahmedatum, geschlecht,
          alterSchaetzung: row['Alter'] || '',
          gewichtAktuell: row['Gewicht (g)'] || '',
          betreuer: row['Betreuer'] || '',
          fundort: row['Fundort'] || '',
          finderName: row['Finder Name'] || '',
          finderKontakt: row['Finder Kontakt'] || '',
          notizen: row['Notizen'] || '',
          gewichtsverlauf: [],
          diagnosen: [],
          behandlungen: [],
          statusHistory: [{
            status, datum: new Date().toISOString(), geaendertVon: 'CSV Import'
          }]
        });
      }
      
      if (errors.length > 0 && data.length === 0) {
        return { success: false, error: errors.join('\n'), data: [] };
      }
      
      return { success: true, error: errors.length > 0 ? errors.join('\n') : '', data };
    };

    // exportToCSV function
    const exportToCSV = (hedgehogs) => {
      const headers = ['Igel-ID', 'Name', 'Status', 'Aufnahmedatum', 'Geschlecht', 'Alter', 'Gewicht (g)', 'Betreuer', 'Fundort', 'Finder Name', 'Finder Kontakt', 'Notizen'];
      const rows = hedgehogs.map(h => {
        return [
          h.igelId || '', h.name || '', h.status || '', h.aufnahmedatum || '', h.geschlecht || '',
          h.alterSchaetzung || '', h.gewichtAktuell || '', h.betreuer || '', h.fundort || '',
          h.finderName || '', h.finderKontakt || '',
          (h.notizen || '').replace(/[\n\r]/g, ' ').replace(/"/g, '""')
        ].map(field => `"${field}"`).join(',');
      });
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `igel-export-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    };

    // Settings helpers (localStorage)
    const loadSettings = () => {
      try { return JSON.parse(localStorage.getItem('igel_settings') || '{}'); } catch { return {}; }
    };
    const saveSettings = (s) => {
      try { localStorage.setItem('igel_settings', JSON.stringify(s)); } catch {}
    };

    // Main App
    const App = () => {
      const [user, setUser] = useState(null);
      const [userData, setUserData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [needsSetup, setNeedsSetup] = useState(null);

      useEffect(() => {
        const init = async () => {
          // First check if admin exists
          try {
            const snapshot = await db.collection('users').where('role', '==', 'admin').get();
            setNeedsSetup(snapshot.empty);
          } catch (err) {
            console.error('Admin check error:', err);
            setNeedsSetup(false);
          }

          // Then check auth state
          auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
              const doc = await db.collection('users').doc(authUser.uid).get();
              const data = doc.exists ? doc.data() : null;
              
              if (doc.exists && data && !data.deleted) {
                // Normal login - user doc exists and is not deleted
                
                // Check if user is suspended
                if (!data.active) {
                  await auth.signOut();
                  alert('Dein Account wurde gesperrt. Bitte kontaktiere den Administrator.');
                  window.location.reload();
                  return;
                }
                
                setUser(authUser);
                setUserData(data);
                
                // Check for notifications
                if (data.notification) {
                  // Show notification
                  setTimeout(() => {
                    alert(data.notification.message);
                    // Clear notification after showing
                    db.collection('users').doc(authUser.uid).update({
                      notification: firebase.firestore.FieldValue.delete()
                    });
                  }, 500);
                }
              } else {
                // User has Auth account but NO Firestore doc.
                // This means either:
                //   A) A newly invited user logging in for the first time
                //   B) A deleted user trying to sneak back in
                //
                // RULE: Auto-create ONLY if a valid unused invite exists for this email.
                // Deleted users have no new invite → they are blocked.

                let validInvite = null;
                try {
                  const inviteSnap = await db.collection('invites')
                    .where('email', '==', authUser.email)
                    .where('used', '==', false)
                    .get();

                  if (!inviteSnap.empty) {
                    // Sort by newest invite
                    const sorted = inviteSnap.docs
                      .map(d => ({ id: d.id, ...d.data() }))
                      .sort((a, b) =>
                        (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)
                      );
                    validInvite = sorted[0];
                  }
                } catch (err) {
                  console.error('Invite check failed:', err);
                }

                if (!validInvite) {
                  // No valid invite → either deleted user or unknown → block
                  await auth.signOut();
                  alert('Kein Zugang. Bitte wende dich an den Administrator.');
                  setLoading(false);
                  return;
                }

                // Valid invite found → create user doc with name & role from invite
                const newUserData = {
                  name: validInvite.userName || authUser.email.split('@')[0],
                  email: authUser.email,
                  role: validInvite.role || 'mitarbeiter',
                  active: true,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                  // Force token refresh to ensure Firestore security rules accept the write
                  await authUser.getIdToken(true);
                  await db.collection('users').doc(authUser.uid).set(newUserData);

                  // Mark invite as used
                  await db.collection('invites').doc(validInvite.id).update({
                    used: true,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    usedBy: authUser.uid
                  });

                  setUser(authUser);
                  setUserData(newUserData);
                } catch (err) {
                  // Retry once after short delay (token propagation race condition)
                  try {
                    await new Promise(r => setTimeout(r, 800));
                    await authUser.getIdToken(true);
                    await db.collection('users').doc(authUser.uid).set(newUserData);
                    await db.collection('invites').doc(validInvite.id).update({
                      used: true,
                      usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                      usedBy: authUser.uid
                    });
                    setUser(authUser);
                    setUserData(newUserData);
                  } catch (retryErr) {
                    console.error('Error creating user doc:', retryErr);
                    await auth.signOut();
                    alert('Fehler beim Erstellen des Accounts. Bitte kontaktiere den Administrator.');
                  }
                }
              }
            } else {
              setUser(null);
              setUserData(null);
            }
            setLoading(false);
          });
        };
        
        init();
      }, []);

      if (loading || needsSetup === null) {
        return <LoadingScreen />;
      }

      // Invite flow: Users go directly to login page, no special invite page
      // They use "Passwort vergessen oder Einladung erhalten" to set password

      // Show admin setup if no admin exists
      if (needsSetup && !user) {
        return <AdminSetup />;
      }

      if (!user) {
        return <LoginScreen />;
      }

      return <MainApp user={user} userData={userData} />;
    };

    // Loading Screen
    const LoadingScreen = () => (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-10 h-10 border-2 border-gray-200 border-t-gray-900 rounded-full animate-spin mx-auto mb-4"></div>
          <div className="text-sm text-gray-500">Lädt...</div>
        </div>
      </div>
    );

    // Login Screen
    const LoginScreen = () => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPasswordSetup, setShowPasswordSetup] = useState(false);
      const [showPasswordReset, setShowPasswordReset] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          if (err.code === 'auth/user-not-found') {
            setError('Kein Account gefunden. Bitte "Passwort einrichten" nutzen.');
          } else if (err.code === 'auth/wrong-password') {
            setError('Falsches Passwort');
          } else {
            setError('Login fehlgeschlagen. Bitte Zugangsdaten prüfen.');
          }
        }
        setLoading(false);
      };

      if (showPasswordSetup) {
        return <PasswordSetup onBack={() => setShowPasswordSetup(false)} />;
      }

      if (showPasswordReset) {
        return <PasswordReset onBack={() => setShowPasswordReset(false)} />;
      }

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full">

            {/* Logo / Titel */}
            <div className="mb-8">
              <div className="w-10 h-10 bg-gray-900 rounded-xl flex items-center justify-center mb-4">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
              </div>
              <h1 className="text-base font-semibold text-gray-900">Igelpflegestation Pro</h1>
              <p className="text-sm text-gray-400 mt-0.5">Anmelden um fortzufahren</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-3">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="E-Mail"
                required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Passwort"
                required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
              />
              {error && <div className="text-red-500 text-xs px-1">{error}</div>}
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
              >
                {loading ? 'Anmelden...' : 'Anmelden'}
              </button>
            </form>

            <div className="mt-5 text-center">
              <button
                onClick={() => setShowPasswordReset(true)}
                className="text-xs text-gray-500 hover:text-gray-700 underline"
              >
                Passwort vergessen oder Einladung erhalten?
              </button>
            </div>

          </div>
        </div>
      );
    };

    // Password Setup Component
    const PasswordSetup = ({ onBack }) => {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [inviteFound, setInviteFound] = useState(null);
      const [inviteData, setInviteData] = useState(null);

      const checkInvite = async () => {
        if (!email) {
          setError('Bitte E-Mail eingeben');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const snapshot = await db.collection('invites')
            .where('email', '==', email)
            .where('used', '==', false)
            .limit(1)
            .get();

          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            setInviteData({ ...data, docId: snapshot.docs[0].id });
            setInviteFound(true);
          } else {
            setInviteFound(false);
            setError('Keine Einladung für diese E-Mail gefunden. Bitte kontaktiere deinen Administrator.');
          }
        } catch (err) {
          setError('Fehler beim Prüfen: ' + err.message);
        }
        setLoading(false);
      };

      const handleRegister = async (e) => {
        e.preventDefault();

        if (!name.trim()) {
          setError('Bitte Namen eingeben');
          return;
        }

        if (password !== confirm) {
          setError('Passwörter stimmen nicht überein');
          return;
        }

        if (password.length < 6) {
          setError('Passwort muss mindestens 6 Zeichen haben');
          return;
        }

        setLoading(true);
        setError('');

        try {
          // Check if user was previously deleted
          const existingUserQuery = await db.collection('users').where('email', '==', email).get();
          
          if (!existingUserQuery.empty) {
            const existingUserDoc = existingUserQuery.docs[0];
            const existingUserData = existingUserDoc.data();
            
            // If user was deleted, reactivate them
            if (existingUserData.deleted) {
              // Try to create auth account (might already exist)
              try {
                await auth.createUserWithEmailAndPassword(email, password);
              } catch (authErr) {
                // If account exists, that's fine - user will login with new password
                if (authErr.code !== 'auth/email-already-in-use') {
                  throw authErr;
                }
              }
              
              // Reactivate user
              await db.collection('users').doc(existingUserDoc.id).update({
                name: name.trim(),
                role: inviteData.role,
                active: true,
                deleted: firebase.firestore.FieldValue.delete(),
                deletedAt: firebase.firestore.FieldValue.delete(),
                notification: firebase.firestore.FieldValue.delete()
              });
              
              await db.collection('invites').doc(inviteData.docId).update({ 
                used: true,
                usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                usedBy: existingUserDoc.id
              });
              
              window.location.href = window.location.origin + window.location.pathname;
              return;
            }
          }
          
          // Normal registration for new user
          const userCred = await auth.createUserWithEmailAndPassword(email, password);
          
          await db.collection('users').doc(userCred.user.uid).set({
            name: name.trim(),
            email: email,
            role: inviteData.role,
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          await db.collection('invites').doc(inviteData.docId).update({ 
            used: true,
            usedAt: firebase.firestore.FieldValue.serverTimestamp(),
            usedBy: userCred.user.uid
          });

          // Clean redirect to homepage without invite code
          window.location.href = window.location.origin + window.location.pathname;
        } catch (err) {
          if (err.code === 'auth/email-already-in-use') {
            setError('Diese E-Mail ist bereits registriert. Nutze "Passwort vergessen" zum Zurücksetzen.');
          } else {
            setError('Registrierung fehlgeschlagen: ' + err.message);
          }
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <div className="flex items-center gap-3 mb-6">
              <button onClick={onBack} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <h2 className="text-base font-semibold text-gray-900">Passwort einrichten</h2>
            </div>

            {!inviteFound ? (
              <div className="space-y-4">
                <div className="bg-gray-50 rounded-xl p-4">
                  <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Einladung prüfen</p>
                  <p className="text-xs text-gray-400">Gib die E-Mail-Adresse ein, die dein Administrator verwendet hat.</p>
                </div>

                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="E-Mail-Adresse"
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                />

                {error && <div className="text-red-500 text-xs px-1">{error}</div>}

                <button
                  onClick={checkInvite}
                  disabled={loading}
                  className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
                >
                  {loading ? 'Prüfe...' : 'E-Mail prüfen'}
                </button>
              </div>
            ) : (
              <form onSubmit={handleRegister} className="space-y-3">
                <div className="bg-gray-50 rounded-xl p-4">
                  <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Einladung gefunden</p>
                  <p className="text-xs text-gray-600">E-Mail: {email}</p>
                  <p className="text-xs text-gray-600">Rolle: {inviteData.role === 'admin' ? 'Administrator' : inviteData.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}</p>
                </div>

                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Vor- und Nachname"
                  required
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Passwort (mind. 6 Zeichen)"
                  required
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                />
                <input
                  type="password"
                  value={confirm}
                  onChange={(e) => setConfirm(e.target.value)}
                  placeholder="Passwort wiederholen"
                  required
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                />

                {error && <div className="text-red-500 text-xs px-1">{error}</div>}

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
                >
                  {loading ? 'Erstelle Account...' : 'Account erstellen'}
                </button>
              </form>
            )}
          </div>
        </div>
      );
    };

    // Password Reset Component
    const PasswordReset = ({ onBack }) => {
      const [email, setEmail] = useState('');
      const [sent, setSent] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleReset = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await auth.sendPasswordResetEmail(email);
          setSent(true);
        } catch (err) {
          if (err.code === 'auth/user-not-found') {
            setError('Keine Account mit dieser E-Mail gefunden');
          } else {
            setError('Fehler: ' + err.message);
          }
        }
        setLoading(false);
      };

      if (sent) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full text-center">
              <div className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
              </div>
              <h2 className="text-base font-semibold text-gray-900 mb-2">E-Mail gesendet</h2>
              <p className="text-sm text-gray-500 mb-4">
                Ein Link zum Passwort-Setzen wurde an <span className="font-medium text-gray-900">{email}</span> gesendet.
              </p>
              <div className="bg-gray-50 rounded-xl p-4 mb-3 text-left space-y-1.5">
                <p className="text-xs text-gray-500">1. E-Mail öffnen</p>
                <p className="text-xs text-gray-500">2. Link klicken &amp; Passwort festlegen</p>
                <p className="text-xs text-gray-500">3. Zurück zur App &amp; einloggen</p>
              </div>
              <div className="bg-gray-100 rounded-xl p-3 mb-4 text-left space-y-1">
                <p className="text-xs font-semibold text-gray-700">Keine E-Mail erhalten?</p>
                <p className="text-xs text-gray-500">Prüfe den <span className="font-semibold text-gray-700">Spam- / Junk-Ordner</span>.</p>
                <p className="text-xs text-gray-500">Absender: <span className="font-medium text-gray-700">noreply@igelstation-3c3db.firebaseapp.com</span></p>
                <p className="text-xs text-gray-500">Betreff enthält: <span className="font-medium text-gray-700">Igelpflegestation</span></p>
              </div>
              <button
                onClick={onBack}
                className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all"
              >
                Zurück zum Login
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <div className="flex items-center gap-3 mb-6">
              <button onClick={onBack} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <h2 className="text-base font-semibold text-gray-900">Passwort zurücksetzen</h2>
            </div>

            <div className="bg-gray-50 rounded-xl p-4 mb-4">
              <p className="text-xs text-gray-500">Gib deine E-Mail-Adresse ein. Du erhältst einen Link zum Zurücksetzen des Passworts.</p>
            </div>

            <form onSubmit={handleReset} className="space-y-3">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="E-Mail-Adresse"
                required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
              />

              {error && <div className="text-red-500 text-xs px-1">{error}</div>}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
              >
                {loading ? 'Sende E-Mail...' : 'Link senden'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // Admin Setup
    const AdminSetup = () => {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');

      const handleSetup = async (e) => {
        e.preventDefault();
        if (password !== confirm) {
          setError('Passwörter stimmen nicht überein');
          return;
        }
        if (password.length < 6) {
          setError('Passwort muss mind. 6 Zeichen haben');
          return;
        }

        try {
          const userCred = await auth.createUserWithEmailAndPassword(email, password);
          await db.collection('users').doc(userCred.user.uid).set({
            name, email,
            role: 'admin',
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          window.location.reload();
        } catch (err) {
          setError(err.message);
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <div className="mb-6">
              <div className="w-10 h-10 bg-gray-900 rounded-xl flex items-center justify-center mb-4">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
              </div>
              <h1 className="text-base font-semibold text-gray-900">Admin-Setup</h1>
              <p className="text-sm text-gray-400 mt-0.5">Ersten Administrator erstellen</p>
            </div>

            <form onSubmit={handleSetup} className="space-y-3">
              <input type="text" value={name} onChange={(e) => setName(e.target.value)}
                placeholder="Name" required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
              <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                placeholder="E-Mail" required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
              <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                placeholder="Passwort (mind. 6 Zeichen)" required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
              <input type="password" value={confirm} onChange={(e) => setConfirm(e.target.value)}
                placeholder="Passwort bestätigen" required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
              {error && <div className="text-red-500 text-xs px-1">{error}</div>}
              <button type="submit"
                className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">
                Admin erstellen
              </button>
            </form>
          </div>
        </div>
      );
    };

    // Invite Registration
    const InviteRegistration = ({ inviteCode }) => {
      const [inviteData, setInviteData] = useState(null);
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(true);
      const [registering, setRegistering] = useState(false);

      useEffect(() => {
        const loadInvite = async () => {
          try {
            const snapshot = await db.collection('invites')
              .where('code', '==', inviteCode)
              .where('used', '==', false)
              .limit(1)
              .get();
            
            if (!snapshot.empty) {
              const data = snapshot.docs[0].data();
              setInviteData({ ...data, docId: snapshot.docs[0].id });
            } else {
              setError('Einladung ungültig oder bereits verwendet');
            }
          } catch (err) {
            console.error('Invite load error:', err);
            setError('Fehler beim Laden der Einladung: ' + err.message);
          }
          setLoading(false);
        };
        loadInvite();
      }, [inviteCode]);

      const handleRegister = async (e) => {
        e.preventDefault();

        if (!name.trim()) { setError('Bitte gib deinen Namen ein'); return; }
        if (password.length < 6) { setError('Passwort muss mindestens 6 Zeichen haben'); return; }
        if (password !== confirm) { setError('Passwörter stimmen nicht überein'); return; }

        setRegistering(true);
        setError('');

        try {
          // Create Firebase Auth account directly — no email needed
          const userCred = await auth.createUserWithEmailAndPassword(inviteData.email, password);

          // Create Firestore user doc
          const newUserData = {
            name: name.trim(),
            email: inviteData.email,
            role: inviteData.role || 'mitarbeiter',
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            erstelltVon: inviteData.createdBy || 'invite',
          };

          // Force token refresh to satisfy Firestore rules
          await userCred.user.getIdToken(true);
          await db.collection('users').doc(userCred.user.uid).set(newUserData);

          // Mark invite as used
          await db.collection('invites').doc(inviteData.docId).update({
            used: true,
            usedAt: firebase.firestore.FieldValue.serverTimestamp(),
            usedBy: userCred.user.uid,
          });

          // Auth listener takes over from here — no redirect needed
        } catch (err) {
          console.error('Registration error:', err);
          if (err.code === 'auth/email-already-in-use') {
            setError('Diese E-Mail ist bereits registriert. Bitte melde dich direkt an.');
          } else {
            setError('Fehler: ' + err.message);
          }
          setRegistering(false);
        }
      };

      if (loading) {
        return <LoadingScreen />;
      }

      if (error && !inviteData) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
              <div className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-500">
                  <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
              </div>
              <h2 className="text-base font-semibold text-gray-900 mb-2">Einladung ungültig</h2>
              <p className="text-sm text-gray-500 mb-4">{error}</p>
              <a href={window.location.origin + window.location.pathname}
                className="inline-block w-full bg-gray-900 text-white px-6 py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">
                Zur Startseite
              </a>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <div className="mb-6">
              <h1 className="text-base font-semibold text-gray-900">Willkommen!</h1>
              <p className="text-sm text-gray-400 mt-0.5">Du wurdest zur Igelpflegestation eingeladen</p>
            </div>

            <div className="bg-gray-50 rounded-xl p-4 mb-4 space-y-1">
              <div className="flex justify-between">
                <span className="text-xs text-gray-400">E-Mail</span>
                <span className="text-xs font-medium text-gray-900">{inviteData?.email}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-xs text-gray-400">Rolle</span>
                <span className="text-xs font-medium text-gray-900">{
                  inviteData?.role === 'admin' ? 'Administrator' :
                  inviteData?.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast (nur lesen)'
                }</span>
              </div>
            </div>

            <form onSubmit={handleRegister} className="space-y-3">
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Dein Name</p>
                <input
                  type="text"
                  placeholder="Vor- und Nachname"
                  value={name}
                  onChange={e => setName(e.target.value)}
                  required
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
                />
              </div>
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Passwort wählen</p>
                <input
                  type="password"
                  placeholder="Mindestens 6 Zeichen"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  required
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
                />
              </div>
              <input
                type="password"
                placeholder="Passwort bestätigen"
                value={confirm}
                onChange={e => setConfirm(e.target.value)}
                required
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
              />
              {error && <div className="text-red-500 text-xs px-1">{error}</div>}
              <button
                type="submit"
                disabled={registering}
                className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                {registering ? 'Account wird erstellt…' : 'Account erstellen'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // ── Donut-Chart Komponente ────────────────────────────────────────────────
    const STATUS_CHART_CONFIG = [
      { value: 'aufnahme',            label: 'Aufnahme',            color: '#3B82F6', light: '#EFF6FF' }, // blue-500
      { value: 'pflege',              label: 'In Pflege',           color: '#111827', light: '#F3F4F6' }, // gray-900
      { value: 'ueberwinterung',      label: 'Überwinterung',       color: '#6366F1', light: '#EEF2FF' }, // indigo-500
      { value: 'auswilderung_bereit', label: 'Auswilderungsbereit', color: '#6B7280', light: '#F9FAFB' }, // gray-500
      { value: 'ausgewildert',        label: 'Ausgewildert',        color: '#9CA3AF', light: '#F9FAFB' }, // gray-400
      { value: 'verstorben',          label: 'Verstorben',          color: '#D1D5DB', light: '#F9FAFB' }, // gray-300
    ];

    const DashboardDonut = ({ hedgehogs, activeFilter, onSegmentClick, onClearFilter }) => {
      const [hovered, setHovered] = React.useState(null);
      const total = hedgehogs.length;

      const counts = {};
      STATUS_CHART_CONFIG.forEach(s => counts[s.value] = 0);
      hedgehogs.forEach(h => { if (counts[h.status] !== undefined) counts[h.status]++; });

      const cx = 80, cy = 80, r = 60, strokeW = 20;
      const circ = 2 * Math.PI * r;
      const GAP_DEG = total > 0 ? 2.5 : 0;

      let offset = -90;
      const segments = total === 0
        ? [{ value: '__empty', color: '#E5E7EB', dashLen: circ, rotation: 0, count: 0, label: '' }]
        : STATUS_CHART_CONFIG.filter(s => counts[s.value] > 0).map(s => {
            const deg = (counts[s.value] / total) * 360;
            const dashLen = Math.max(0, (deg - GAP_DEG) / 360 * circ);
            const rot = offset;
            offset += deg;
            return { ...s, count: counts[s.value], dashLen, rotation: rot };
          });

      return (
        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
          {/* SVG Donut */}
          <div style={{ flexShrink: 0, position: 'relative' }}>
            <svg viewBox="0 0 160 160" width="148" height="148">
              <circle cx={cx} cy={cy} r={r} fill="none" stroke="#F3F4F6" strokeWidth={strokeW} />
              {segments.map((seg, i) => {
                if (seg.value === '__empty') return (
                  <circle key="empty" cx={cx} cy={cy} r={r} fill="none" stroke="#E5E7EB" strokeWidth={strokeW} />
                );
                const isActive = activeFilter.includes(seg.value);
                const isHov = hovered === seg.value;
                const hasFilter = activeFilter.length > 0;
                const isDim = hasFilter && !isActive && !isHov;
                return (
                  <circle
                    key={seg.value}
                    cx={cx} cy={cy} r={r}
                    fill="none"
                    stroke={seg.color}
                    strokeWidth={isHov || isActive ? strokeW + 4 : strokeW}
                    strokeDasharray={`${seg.dashLen} ${circ - seg.dashLen}`}
                    strokeDashoffset={circ * 0.25}
                    transform={`rotate(${seg.rotation} ${cx} ${cy})`}
                    strokeLinecap="butt"
                    style={{
                      opacity: isDim ? 0.22 : 1,
                      transition: 'stroke-width 0.18s ease, opacity 0.18s ease',
                      cursor: 'pointer',
                    }}
                    onMouseEnter={() => setHovered(seg.value)}
                    onMouseLeave={() => setHovered(null)}
                    onClick={() => onSegmentClick(seg.value)}
                  />
                );
              })}
              {/* Clickable center — clears filter */}
              <circle
                cx={cx} cy={cy} r={r - strokeW / 2 - 2}
                fill="transparent"
                style={{ cursor: activeFilter.length > 0 ? 'pointer' : 'default' }}
                onClick={() => activeFilter.length > 0 && onClearFilter()}
              />
              {/* Perfectly centered total */}
              <text
                x={cx} y={cy}
                textAnchor="middle"
                dominantBaseline="central"
                fontSize="28"
                fontWeight="700"
                fill={activeFilter.length > 0 ? '#2563EB' : '#111827'}
                style={{ cursor: activeFilter.length > 0 ? 'pointer' : 'default' }}
                onClick={() => activeFilter.length > 0 && onClearFilter()}
              >{total}</text>
              <text
                x={cx} y={cy + 18}
                textAnchor="middle"
                dominantBaseline="central"
                fontSize="8"
                fontWeight="600"
                fill={activeFilter.length > 0 ? '#2563EB' : '#9CA3AF'}
                letterSpacing="0.08em"
                style={{ cursor: activeFilter.length > 0 ? 'pointer' : 'default' }}
                onClick={() => activeFilter.length > 0 && onClearFilter()}
              >{activeFilter.length > 0 ? 'ALLE' : 'GESAMT'}</text>
            </svg>
          </div>

          {/* Legende */}
          <div style={{ flex: 1, minWidth: 0 }}>
            {STATUS_CHART_CONFIG.map(s => {
              const count = counts[s.value];
              const isActive = activeFilter.includes(s.value);
              const isHov = hovered === s.value;
              const isDim = (activeFilter.length > 0 && !isActive);

              return (
                <div
                  key={s.value}
                  onMouseEnter={() => setHovered(s.value)}
                  onMouseLeave={() => setHovered(null)}
                  onClick={() => onSegmentClick(s.value)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '4px 8px',
                    borderRadius: 8,
                    background: (isHov || isActive) ? s.light : 'transparent',
                    opacity: isDim ? 0.35 : 1,
                    transition: 'all 0.15s ease',
                    cursor: 'pointer',
                    marginBottom: 1,
                    outline: isActive ? `1.5px solid ${s.color}33` : 'none',
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, minWidth: 0 }}>
                    <div style={{
                      width: 8, height: 8, borderRadius: '50%',
                      background: count > 0 ? s.color : '#E5E7EB',
                      flexShrink: 0,
                    }}/>
                    <span style={{
                      fontSize: 12,
                      fontWeight: count > 0 ? 500 : 400,
                      color: count > 0 ? '#374151' : '#9CA3AF',
                      whiteSpace: 'nowrap',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                    }}>{s.label}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: 4, flexShrink: 0, marginLeft: 6 }}>
                    <span style={{
                      fontSize: 12, fontWeight: 700,
                      color: count > 0 ? '#111827' : '#D1D5DB',
                      minWidth: 16, textAlign: 'right',
                    }}>{count}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ── Medikation Stammdaten ────────────────────────────────────────────────
    const MedikationDatenbank = ({ userData, onClose }) => {
      const isAdmin = userData?.role === 'admin';
      const [activeTab, setActiveTab] = useState('gruppen');
      const [allData, setAllData] = useState({ gruppen: [], behandlungen: [], arten: [], haeufigkeiten: [] });
      const [loadingData, setLoadingData] = useState(true);
      const [showForm, setShowForm] = useState(null);     // { mode:'create'|'edit', item:{} }
      const [formVals, setFormVals] = useState({});
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(null); // { item, canDelete, reason, usageCount }
      const [showCascadeDialog, setShowCascadeDialog] = useState(null); // { item, newVals, usageCount, nameField, queryField }
      const [saving, setSaving] = useState(false);
      const [checking, setChecking] = useState(false);
      const [formError, setFormError] = useState('');
      const [showDuplicateWarning, setShowDuplicateWarning] = useState(null); // { name, existsIn: [{parentName}], proceedFn }

      const TABS = [
        { key: 'gruppen',       label: 'Gruppe',      col: 'med_gruppen',       singular: 'Gruppe',      queryField: 'gruppeId',      nameField: 'gruppeName',      parentKey: null,      parentIdField: null,       parentNameField: null          },
        { key: 'behandlungen',  label: 'Behandlung',  col: 'med_behandlungen',  singular: 'Behandlung',  queryField: 'behandlungId',  nameField: 'behandlungName',  parentKey: 'gruppen', parentIdField: 'gruppeId', parentNameField: 'gruppeName'    },
        { key: 'arten',         label: 'Art',         col: 'med_arten',         singular: 'Art',         queryField: 'artId',         nameField: 'artName',         parentKey: null,      parentIdField: null,       parentNameField: null            },
        { key: 'haeufigkeiten', label: 'Häufigkeit',  col: 'med_haeufigkeiten', singular: 'Häufigkeit',  queryField: 'haeufigkeitId', nameField: 'haeufigkeitName', parentKey: null,      parentIdField: null,       parentNameField: null            },
      ];
      const tab = TABS.find(t => t.key === activeTab);

      // Load all 4 collections — individual handlers to survive partial permission errors
      useEffect(() => {
        const config = [
          { key: 'gruppen',       col: 'med_gruppen',       sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'behandlungen',  col: 'med_behandlungen',  sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'arten',         col: 'med_arten',         sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'haeufigkeiten', col: 'med_haeufigkeiten', sort: (a,b) => (a.sortOrder||0)-(b.sortOrder||0) },
        ];

        const localData = { gruppen: [], behandlungen: [], arten: [], haeufigkeiten: [] };
        const loaded = { gruppen: false, behandlungen: false, arten: false, haeufigkeiten: false };

        const tryFinish = () => {
          if (Object.values(loaded).every(Boolean)) {
            setAllData({ ...localData });
            setLoadingData(false);
          }
        };

        const unsubs = config.map(({ key, col, sort }) =>
          db.collection(col).onSnapshot(
            snap => {
              const docs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort(sort);
              localData[key] = docs;
              loaded[key] = true;
              setAllData(prev => ({ ...prev, [key]: docs }));
              tryFinish();
            },
            err => {
              console.warn(`Med Stammdaten ${col}:`, err.code);
              loaded[key] = true; // mark as done even on error
              tryFinish();
            }
          )
        );

        // Timeout fallback — force-stop spinner after 6s
        const timeout = setTimeout(() => setLoadingData(false), 6000);
        return () => { unsubs.forEach(u => u()); clearTimeout(timeout); };
      }, []);

      // Check usage before delete
      const checkUsage = async (item) => {
        setChecking(true);
        try {
          // Gruppe: prüfe ob noch Behandlungen referenzieren
          if (activeTab === 'gruppen') {
            const bSnap = await db.collection('med_behandlungen').where('gruppeId', '==', item.id).get();
            if (!bSnap.empty) {
              setChecking(false);
              return { canDelete: false, reason: `${bSnap.size} Behandlung${bSnap.size > 1 ? 'en' : ''} ${bSnap.size > 1 ? 'verwenden' : 'verwendet'} diese Gruppe. Zuerst diese Behandlungen löschen oder umbenennen.`, usageCount: bSnap.size };
            }
          }
          // Alle: prüfe Nutzung in Igelkarten
          const mSnap = await db.collection('medikationen').where(tab.queryField, '==', item.id).get();
          setChecking(false);
          return { canDelete: mSnap.empty, usageCount: mSnap.size, reason: mSnap.empty ? null : `${mSnap.size} Igelkarte${mSnap.size > 1 ? 'n verwenden' : ' verwendet'} diesen Eintrag. Zuerst die Medikationen aus den Igelkarten entfernen.` };
        } catch (e) {
          setChecking(false);
          return { canDelete: true, usageCount: 0 };
        }
      };

      const handleDeleteClick = async (item) => {
        const result = await checkUsage(item);
        setShowDeleteConfirm({ item, ...result });
      };

      const confirmDelete = async () => {
        setSaving(true);
        try {
          await db.collection(tab.col).doc(showDeleteConfirm.item.id).delete();
          await db.collection('auditLog').add({ action: 'delete', timestamp: firebase.firestore.FieldValue.serverTimestamp(), userId: userData.uid || '', userName: userData.name, details: `Stammdaten gelöscht: ${tab.singular} "${showDeleteConfirm.item.name}"` });
          setShowDeleteConfirm(null);
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      const openForm = (mode, item = {}) => {
        setFormError('');
        const base = { name: item.name || '' };
        // Behandlung: Eltern-Gruppe ist Pflicht
        if (tab.parentIdField) {
          base[tab.parentIdField] = item[tab.parentIdField] || '';
          base[tab.parentNameField] = item[tab.parentNameField] || '';
        }
        if (activeTab === 'haeufigkeiten') {
          base.sortOrder = item.sortOrder ?? ((allData.haeufigkeiten.length + 1) * 10);
        }
        setFormVals(base);
        setShowForm({ mode, item });
      };

      const handleFormSave = async () => {
        if (!formVals.name?.trim()) { setFormError('Name ist erforderlich'); return; }
        if (tab.parentIdField && !formVals[tab.parentIdField]) {
          const parentTab = TABS.find(t => t.key === tab.parentKey);
          setFormError(`Bitte ${parentTab?.singular || 'übergeordneten Eintrag'} auswählen`); return;
        }

        // ── Duplicate check within same scope ──
        const newName = formVals.name.trim().toLowerCase();
        const list = allData[activeTab] || [];
        const isDuplicate = list.some(existing => {
          // Skip self when editing
          if (showForm.mode === 'edit' && existing.id === showForm.item.id) return false;
          // Name must match
          if (existing.name.trim().toLowerCase() !== newName) return false;
          // For top-level (Gruppe): global uniqueness
          if (!tab.parentIdField) return true;
          // For child levels: only duplicate within same parent
          return existing[tab.parentIdField] === formVals[tab.parentIdField];
        });
        if (isDuplicate) {
          const scope = tab.parentIdField
            ? ` in dieser ${TABS.find(t => t.key === tab.parentKey)?.singular}`
            : '';
          setFormError(`„${formVals.name.trim()}" existiert bereits${scope}.`);
          return;
        }

        setFormError('');

        // ── Actual save logic (called directly or after warning confirmed) ──
        const doActualSave = async () => {
          setShowDuplicateWarning(null);
          // Edit: check cascade
          if (showForm.mode === 'edit') {
            const nameChanged = formVals.name.trim() !== showForm.item.name;
            if (nameChanged) {
              const mSnap = await db.collection('medikationen').where(tab.queryField, '==', showForm.item.id).get();
              if (mSnap.size > 0) {
                setShowCascadeDialog({ item: showForm.item, newVals: { ...formVals, name: formVals.name.trim() }, usageCount: mSnap.size });
                return;
              }
            }
            await saveEdit(false, { item: showForm.item, newVals: { ...formVals, name: formVals.name.trim() }, usageCount: 0 });
            return;
          }
          // Create new
          setSaving(true);
          try {
            const payload = { ...formVals, name: formVals.name.trim(), erstelltVon: userData.name, erstelltAm: firebase.firestore.FieldValue.serverTimestamp() };
            if (tab.parentIdField) {
              const parentList = allData[tab.parentKey] || [];
              const parentItem = parentList.find(p => p.id === formVals[tab.parentIdField]);
              payload[tab.parentNameField] = parentItem?.name || '';
            }
            await db.collection(tab.col).add(payload);
            await db.collection('auditLog').add({ action: 'create', timestamp: firebase.firestore.FieldValue.serverTimestamp(), userId: userData.uid || '', userName: userData.name, details: `Stammdaten angelegt: ${tab.singular} "${payload.name}"` });
            setShowForm(null);
          } catch (e) { setFormError('Fehler: ' + e.message); }
          setSaving(false);
        };

        await doActualSave();
      };

      const saveEdit = async (cascade, ctx) => {
        const { item, newVals } = ctx || showCascadeDialog;
        setSaving(true);
        try {
          const payload = { ...newVals, geaendertVon: userData.name, geaendertAm: firebase.firestore.FieldValue.serverTimestamp() };
          // Resolve parent display name
          if (tab.parentIdField) {
            const parentList = allData[tab.parentKey] || [];
            const parentItem = parentList.find(p => p.id === newVals[tab.parentIdField]);
            payload[tab.parentNameField] = parentItem?.name || '';
          }
          await db.collection(tab.col).doc(item.id).update(payload);

          // Cascade to Igelkarten
          if (cascade && (ctx || showCascadeDialog).usageCount > 0) {
            const snap = await db.collection('medikationen').where(tab.queryField, '==', item.id).get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.update(doc.ref, { [tab.nameField]: payload.name }));
            await batch.commit();
          }
          // Propagate name change: Gruppe → Behandlungen (nur diese Kette bleibt)
          if (activeTab === 'gruppen' && newVals.name !== item.name) {
            const bSnap = await db.collection('med_behandlungen').where('gruppeId', '==', item.id).get();
            if (!bSnap.empty) {
              const batch3 = db.batch();
              bSnap.docs.forEach(doc => batch3.update(doc.ref, { gruppeName: payload.name }));
              await batch3.commit();
            }
          }

          await db.collection('auditLog').add({ action: 'update', timestamp: firebase.firestore.FieldValue.serverTimestamp(), userId: userData.uid || '', userName: userData.name, details: `Stammdaten bearbeitet: ${tab.singular} "${payload.name}"${cascade ? ' (inkl. Igelkarten)' : ''}` });
          setShowCascadeDialog(null);
          setShowForm(null);
        } catch (e) { setFormError('Fehler: ' + e.message); }
        setSaving(false);
      };

      const currentList = allData[activeTab] || [];
      // Tree view state for Gruppe tab
      const [expandedGruppen, setExpandedGruppen] = React.useState({});
      const toggleGruppe = (id) => setExpandedGruppen(prev => ({ ...prev, [id]: !prev[id] }));
      const behandlungenFuerGruppe = (gruppeId) => (allData.behandlungen || []).filter(b => b.gruppeId === gruppeId);

      const ItemRow = ({ item, indent = false }) => (
        <div className={`flex items-center justify-between border border-gray-100 rounded-xl px-4 py-3 bg-white hover:border-gray-200 transition-all ${indent ? 'ml-4 border-l-2 border-l-gray-100' : ''}`}>
          <div className="min-w-0">
            <p className="text-sm font-medium text-gray-900 truncate">{item.name}</p>
            {item.gruppeName && <p className="text-xs text-gray-400 mt-0.5">{item.gruppeName}</p>}
            {activeTab === 'haeufigkeiten' && item.sortOrder !== undefined && (
              <p className="text-xs text-gray-300 mt-0.5">Reihenfolge: {item.sortOrder}</p>
            )}
          </div>
          {isAdmin && (
            <div className="flex items-center gap-1 ml-3 flex-shrink-0">
              <button onClick={() => openForm('edit', item)} className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button onClick={() => handleDeleteClick(item)} className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-500 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
              </button>
            </div>
          )}
        </div>
      );

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl w-full max-w-md shadow-xl flex flex-col" style={{ maxHeight: '92vh' }}>

            {/* Header */}
            <div className="flex items-center justify-between p-5 border-b border-gray-100 flex-shrink-0">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Medikation Stammdaten</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            {/* Tabs */}
            <div className="flex border-b border-gray-100 flex-shrink-0 px-2">
              {TABS.map(t => (
                <button key={t.key} onClick={() => setActiveTab(t.key)}
                  className={`flex-1 py-3 text-xs font-medium transition-all border-b-2 ${activeTab === t.key ? 'border-gray-900 text-gray-900' : 'border-transparent text-gray-400 hover:text-gray-600'}`}>
                  {t.label}
                  {allData[t.key]?.length > 0 && <span className="ml-1 text-[10px] text-gray-300">({allData[t.key].length})</span>}
                </button>
              ))}
            </div>

            {/* Read-only notice */}
            {!isAdmin && (
              <div className="mx-5 mt-4 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 flex items-center gap-3 flex-shrink-0">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400 flex-shrink-0">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <p className="text-xs text-gray-500">Nur Ansicht — Bearbeiten ist auf Administratoren beschränkt.</p>
              </div>
            )}

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-5">
              {loadingData ? (
                <div className="flex flex-col items-center justify-center py-12 gap-3">
                  <div className="w-6 h-6 border-2 border-gray-900 border-t-transparent rounded-full animate-spin"/>
                  <p className="text-xs text-gray-400">Stammdaten werden geladen…</p>
                </div>
              ) : allData.gruppen === undefined ? (
                <div className="bg-red-50 rounded-xl p-4">
                  <p className="text-xs font-semibold text-red-700 mb-1">Zugriff verweigert</p>
                  <p className="text-xs text-red-600">Firestore Security Rules müssen die med_* Collections abdecken.</p>
                </div>
              ) : (
                <>
                  {/* Description */}
                  <div className="mb-4">
                    {activeTab === 'gruppen' && <p className="text-xs text-gray-400">Gruppe → Behandlung: Baumstruktur. Aufklappen zeigt zugehörige Behandlungen.</p>}
                    {activeTab === 'behandlungen' && <p className="text-xs text-gray-400">Konkrete Behandlungen, jeweils einer Gruppe zugewiesen (z. B. Entwurmung → Antiparasitika).</p>}
                    {activeTab === 'arten' && <p className="text-xs text-gray-400">Globale Applikationsformen — unabhängig nutzbar (z. B. Pille, Spritze, Shampoo).</p>}
                    {activeTab === 'haeufigkeiten' && <p className="text-xs text-gray-400">Globale Häufigkeiten — unabhängig nutzbar (z. B. 1x täglich, nach Bedarf).</p>}
                  </div>

                  {/* Gruppe: Baumansicht */}
                  {activeTab === 'gruppen' && (
                    <div className="space-y-2 mb-4">
                      {allData.gruppen.length === 0 && <div className="text-center py-8 text-sm text-gray-400">Noch keine Gruppen vorhanden</div>}
                      {allData.gruppen.map(gruppe => {
                        const children = behandlungenFuerGruppe(gruppe.id);
                        const expanded = expandedGruppen[gruppe.id];
                        return (
                          <div key={gruppe.id}>
                            <div className="flex items-center justify-between border border-gray-200 rounded-xl px-4 py-3 bg-white hover:border-gray-300 transition-all">
                              <button onClick={() => toggleGruppe(gruppe.id)} className="flex items-center gap-2 min-w-0 flex-1 text-left">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className={`text-gray-400 flex-shrink-0 transition-transform ${expanded ? 'rotate-90' : ''}`}><polyline points="9 18 15 12 9 6"/></svg>
                                <div>
                                  <p className="text-sm font-semibold text-gray-900">{gruppe.name}</p>
                                  <p className="text-xs text-gray-400">{children.length} Behandlung{children.length !== 1 ? 'en' : ''}</p>
                                </div>
                              </button>
                              {isAdmin && (
                                <div className="flex items-center gap-1 ml-3 flex-shrink-0">
                                  <button onClick={() => openForm('edit', gruppe)} className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition-all">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                  </button>
                                  <button onClick={() => handleDeleteClick(gruppe)} className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-500 transition-all">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                                  </button>
                                </div>
                              )}
                            </div>
                            {/* Kinder-Behandlungen */}
                            {expanded && (
                              <div className="mt-1 ml-4 space-y-1">
                                {children.length === 0 && <p className="text-xs text-gray-400 px-4 py-2">Keine Behandlungen in dieser Gruppe.</p>}
                                {children.map(b => (
                                  <div key={b.id} className="flex items-center justify-between border border-gray-100 rounded-xl px-4 py-2.5 bg-gray-50">
                                    <p className="text-sm text-gray-700">{b.name}</p>
                                    {isAdmin && (
                                      <div className="flex items-center gap-1">
                                        <button onClick={() => { setActiveTab('behandlungen'); openForm('edit', b); }} className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-200 text-gray-400 hover:text-gray-700 transition-all">
                                          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                        </button>
                                        <button onClick={() => { setActiveTab('behandlungen'); handleDeleteClick(b); }} className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-500 transition-all">
                                          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                                        </button>
                                      </div>
                                    )}
                                  </div>
                                ))}
                                {isAdmin && (
                                  <button onClick={() => { setActiveTab('behandlungen'); openForm('create', { gruppeId: gruppe.id, gruppeName: gruppe.name }); }}
                                    className="w-full flex items-center gap-2 px-4 py-2 text-xs text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-xl transition-all">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14"/></svg>
                                    Behandlung hinzufügen
                                  </button>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {/* Behandlung, Art, Häufigkeit: flache Liste */}
                  {activeTab !== 'gruppen' && (
                    <div className="space-y-2 mb-4">
                      {currentList.length === 0 && <div className="text-center py-8 text-sm text-gray-400">Noch keine Einträge vorhanden</div>}
                      {currentList.map(item => <ItemRow key={item.id} item={item} />)}
                    </div>
                  )}

                  {/* Add button */}
                  {isAdmin && (
                    <button onClick={() => openForm('create')}
                      className="w-full border-2 border-dashed border-gray-200 text-gray-400 hover:border-gray-900 hover:text-gray-900 py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14"/></svg>
                      {tab.singular} hinzufügen
                    </button>
                  )}
                </>
              )}
            </div>

            {/* Footer */}
            <div className="p-5 pt-0 flex-shrink-0">
              <button onClick={onClose} className="w-full border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                Schließen
              </button>
            </div>
          </div>

          {/* ── Form Modal (Create / Edit) ── */}
          {showForm && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4" onClick={() => setShowForm(null)}>
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      {showForm.mode === 'create' ? <><path d="M12 5v14M5 12h14"/></> : <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>}
                    </svg>
                    <h3 className="text-base font-semibold text-gray-900">
                      {showForm.mode === 'create' ? `${tab.singular} anlegen` : `${tab.singular} bearbeiten`}
                    </h3>
                  </div>
                  <button onClick={() => setShowForm(null)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>

                <div className="p-5 space-y-4">
                  {/* Gruppe-Selector nur für Behandlung */}
                  {activeTab === 'behandlungen' && (() => {
                    const parentList = allData.gruppen || [];
                    return (
                      <div>
                        <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Gruppe *</p>
                        {parentList.length === 0 ? (
                          <p className="text-xs text-red-500 px-1">Zuerst eine Gruppe anlegen.</p>
                        ) : (
                          <select value={formVals.gruppeId || ''} onChange={e => setFormVals({ ...formVals, gruppeId: e.target.value })}
                            className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white">
                            <option value="">Gruppe wählen…</option>
                            {parentList.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                          </select>
                        )}
                      </div>
                    );
                  })()}

                  {/* Name */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Bezeichnung *</p>
                    <input type="text"
                      placeholder={activeTab === 'gruppen' ? 'z. B. Antiparasitika' : activeTab === 'behandlungen' ? 'z. B. Entwurmung' : activeTab === 'arten' ? 'z. B. Pille' : 'z. B. 1x täglich'}
                      value={formVals.name || ''}
                      onChange={e => setFormVals({ ...formVals, name: e.target.value })}
                      className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
                      autoFocus
                    />
                  </div>

                  {/* Reihenfolge nur für Häufigkeit */}
                  {activeTab === 'haeufigkeiten' && (
                    <div>
                      <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Reihenfolge</p>
                      <input type="number" placeholder="z. B. 10, 20, 30 …"
                        value={formVals.sortOrder ?? ''}
                        onChange={e => setFormVals({ ...formVals, sortOrder: parseInt(e.target.value) || 0 })}
                        className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
                      />
                      <p className="text-xs text-gray-400 mt-1 px-1">Niedrigere Zahl = weiter oben in der Liste</p>
                    </div>
                  )}

                  {formError && <p className="text-xs text-red-500 px-1">{formError}</p>}

                  <div className="grid grid-cols-2 gap-3 pt-1">
                    <button onClick={() => setShowForm(null)} className="py-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                    <button onClick={handleFormSave} disabled={saving}
                      className="py-3 bg-gray-900 text-white rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      {saving ? 'Speichern…' : 'Speichern'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ── Duplicate Warning Modal ── */}
          {showDuplicateWarning && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
                <div className="p-5">
                  {/* Icon + Titel */}
                  <div className="flex items-start gap-3 mb-4">
                    <div className="w-9 h-9 rounded-xl bg-amber-50 flex items-center justify-center flex-shrink-0">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-amber-500">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                      </svg>
                    </div>
                    <div>
                      <p className="text-sm font-semibold text-gray-900">Name bereits vorhanden</p>
                      <p className="text-xs text-gray-500 mt-0.5">
                        „{showDuplicateWarning.name}" existiert bereits in {showDuplicateWarning.existsIn.length === 1 ? 'einer anderen' : `${showDuplicateWarning.existsIn.length} anderen`} {TABS.find(t => t.key === tab?.parentKey)?.singular || 'Kategorie'}:
                      </p>
                    </div>
                  </div>

                  {/* Übersicht wo vorhanden */}
                  <div className="bg-gray-50 rounded-xl p-3 mb-4 space-y-1 max-h-36 overflow-y-auto">
                    {showDuplicateWarning.existsIn.map((entry, i) => (
                      <div key={i} className="flex items-center gap-2">
                        <div className="w-1.5 h-1.5 rounded-full bg-gray-400 flex-shrink-0"/>
                        <span className="text-xs text-gray-700 font-medium">{entry.parentName}</span>
                      </div>
                    ))}
                  </div>

                  <p className="text-xs text-gray-500 mb-4">Möchtest du den Eintrag trotzdem neu hinzufügen? Beide Einträge bestehen dann nebeneinander.</p>

                  <div className="space-y-2">
                    <button onClick={showDuplicateWarning.proceedFn} disabled={saving}
                      className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      Trotzdem hinzufügen
                    </button>
                    <button onClick={() => setShowDuplicateWarning(null)}
                      className="w-full border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ── Delete Confirm Modal ── */}
          {showDeleteConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <div className="flex items-start gap-3 mb-4">
                  <div className="w-9 h-9 rounded-xl bg-red-50 flex items-center justify-center flex-shrink-0">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                  </div>
                  <div>
                    <p className="text-sm font-semibold text-gray-900">{tab.singular} löschen</p>
                    <p className="text-xs text-gray-500 mt-0.5">„{showDeleteConfirm.item.name}"</p>
                  </div>
                </div>

                {showDeleteConfirm.canDelete ? (
                  <>
                    <p className="text-sm text-gray-600 mb-5">Dieser Eintrag wird dauerhaft entfernt und kann nicht wiederhergestellt werden.</p>
                    <div className="grid grid-cols-2 gap-3">
                      <button onClick={() => setShowDeleteConfirm(null)} className="py-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">Abbrechen</button>
                      <button onClick={confirmDelete} disabled={saving}
                        className="py-3 bg-red-500 text-white rounded-xl text-sm font-medium hover:bg-red-600 disabled:opacity-50 transition-all">
                        {saving ? 'Löschen…' : 'Löschen'}
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="bg-gray-50 rounded-xl p-4 mb-5">
                      <p className="text-xs font-medium text-gray-700 mb-1">Löschen nicht möglich</p>
                      <p className="text-xs text-gray-500">{showDeleteConfirm.reason}</p>
                    </div>
                    <button onClick={() => setShowDeleteConfirm(null)} className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">Verstanden</button>
                  </>
                )}
              </div>
            </div>
          )}

          {/* ── Cascade Update Dialog ── */}
          {showCascadeDialog && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <div className="flex items-start gap-3 mb-4">
                  <div className="w-9 h-9 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                  </div>
                  <div>
                    <p className="text-sm font-semibold text-gray-900">Verknüpfte Datensätze</p>
                    <p className="text-xs text-gray-500 mt-0.5">{showCascadeDialog.usageCount} Igelkarte{showCascadeDialog.usageCount > 1 ? 'n verwenden' : ' verwendet'} diesen Eintrag</p>
                  </div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 mb-5 space-y-2">
                  <div className="flex justify-between items-baseline">
                    <span className="text-xs text-gray-400">Alter Name</span>
                    <span className="text-xs font-medium text-gray-500">{showCascadeDialog.item.name}</span>
                  </div>
                  <div className="flex justify-between items-baseline">
                    <span className="text-xs text-gray-400">Neuer Name</span>
                    <span className="text-xs font-semibold text-gray-900">{showCascadeDialog.newVals.name}</span>
                  </div>
                </div>
                <p className="text-xs text-gray-500 mb-5">Soll der Name auch in allen verknüpften Igelkarten aktualisiert werden?</p>
                <div className="space-y-2">
                  <button onClick={() => saveEdit(true, showCascadeDialog)} disabled={saving}
                    className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:opacity-50 transition-all">
                    {saving ? 'Aktualisiere…' : `Ja — Stammdaten & ${showCascadeDialog.usageCount} Igelkarte${showCascadeDialog.usageCount > 1 ? 'n' : ''} aktualisieren`}
                  </button>
                  <button onClick={() => saveEdit(false, showCascadeDialog)} disabled={saving}
                    className="w-full border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 disabled:opacity-50 transition-all">
                    Nur Stammdaten aktualisieren
                  </button>
                  <button onClick={() => setShowCascadeDialog(null)}
                    className="w-full text-gray-400 hover:text-gray-600 py-2 text-sm transition-all">
                    Abbrechen
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ── To-Do List ──────────────────────────────────────────────────────────
    const PRIORITY_LABEL = { high: 'Hoch', medium: 'Mittel', low: 'Niedrig' };
    const PRIORITY_KEYS = ['high', 'medium', 'low'];

    const DEFAULT_TODOS = [
      { label: 'Datenschutz', desc: 'Datenschutzerklärung, DSGVO-Konformität, Einwilligungen', priority: 'high', done: false },
      { label: 'Überarbeitung Igelerfassung', desc: 'Felder, Pflichtangaben, Validierungen, Erfassungsflow neu bewerten', priority: 'high', done: false },
      { label: 'Workflow Aufnahme → Überwinterung → Rücknahme', desc: 'Statusübergänge analysieren, Übergabeprozesse optimieren und abbilden', priority: 'medium', done: false },
      { label: 'Filterlisten druckbar', desc: 'Druckbare Listen nach Betreuer, Status, Auswilderung etc.', priority: 'medium', done: false },
    ];

    const TodoList = ({ onClose, userData }) => {
      const isAdmin = userData?.role === 'admin';
      const COL = 'app_todos';

      const [items, setItems] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      // Form state: null = closed, { mode:'create'|'edit', idx }
      const [form, setForm] = useState(null);
      const [formVals, setFormVals] = useState({ label: '', desc: '', priority: 'medium' });
      const [formErr, setFormErr] = useState('');
      const [deleteIdx, setDeleteIdx] = useState(null); // confirm delete

      // ── Load from Firestore ──
      useEffect(() => {
        const unsub = db.collection(COL).doc('main').onSnapshot(snap => {
          if (snap.exists) {
            setItems(snap.data().items || []);
          } else {
            // First run: seed defaults
            db.collection(COL).doc('main').set({ items: DEFAULT_TODOS.map((t,i) => ({ ...t, id: `todo_${Date.now()}_${i}` })) });
          }
          setLoading(false);
        }, () => setLoading(false));
        return () => unsub();
      }, []);

      const save = async (newItems) => {
        setSaving(true);
        try { await db.collection(COL).doc('main').set({ items: newItems }); }
        catch(e) { console.error(e); }
        setSaving(false);
      };

      const toggleDone = async (idx) => {
        const next = items.map((it, i) => i === idx ? { ...it, done: !it.done } : it);
        setItems(next);
        await save(next);
      };

      const openCreate = () => {
        setFormVals({ label: '', desc: '', priority: 'medium' });
        setFormErr('');
        setForm({ mode: 'create' });
      };

      const openEdit = (idx) => {
        setFormVals({ label: items[idx].label, desc: items[idx].desc || '', priority: items[idx].priority || 'medium' });
        setFormErr('');
        setForm({ mode: 'edit', idx });
      };

      const submitForm = async () => {
        if (!formVals.label.trim()) { setFormErr('Bezeichnung ist erforderlich.'); return; }
        setFormErr('');
        let next;
        if (form.mode === 'create') {
          next = [...items, { id: `todo_${Date.now()}`, label: formVals.label.trim(), desc: formVals.desc.trim(), priority: formVals.priority, done: false }];
        } else {
          next = items.map((it, i) => i === form.idx ? { ...it, label: formVals.label.trim(), desc: formVals.desc.trim(), priority: formVals.priority } : it);
        }
        setItems(next);
        setForm(null);
        await save(next);
      };

      const confirmDelete = async () => {
        const next = items.filter((_, i) => i !== deleteIdx);
        setItems(next);
        setDeleteIdx(null);
        await save(next);
      };

      const done = items.filter(t => t.done).length;
      const pct = items.length ? Math.round((done / items.length) * 100) : 0;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl w-full max-w-md shadow-xl flex flex-col" style={{ maxHeight: '90vh' }}>

            {/* Header */}
            <div className="flex items-center justify-between p-5 border-b border-gray-100 flex-shrink-0">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <polyline points="9 11 12 14 22 4"/>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <div>
                  <h2 className="text-base font-semibold text-gray-900">To-Do</h2>
                  <p className="text-[10px] text-gray-400">Entwicklungs-Roadmap</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {isAdmin && !loading && (
                  <button onClick={openCreate}
                    className="flex items-center gap-1.5 text-xs font-medium text-gray-900 border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-50 transition-all">
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14"/></svg>
                    Neu
                  </button>
                )}
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </div>
            </div>

            {/* Progress */}
            {!loading && items.length > 0 && (
              <div className="px-5 pt-4 pb-2 flex-shrink-0">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs text-gray-500">{done} von {items.length} erledigt</p>
                  <p className="text-xs font-semibold text-gray-900">{pct}%</p>
                </div>
                <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                  <div className="h-full bg-gray-900 rounded-full transition-all duration-500" style={{ width: `${pct}%` }}/>
                </div>
              </div>
            )}

            {/* List */}
            <div className="flex-1 overflow-y-auto px-5 pb-3 mt-3 space-y-2">
              {loading ? (
                <div className="flex justify-center py-10">
                  <div className="w-5 h-5 border-2 border-gray-900 border-t-transparent rounded-full animate-spin"/>
                </div>
              ) : items.length === 0 ? (
                <div className="text-center py-10">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-gray-200 mx-auto mb-2">
                    <polyline points="9 11 12 14 22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                  <p className="text-sm text-gray-400">Noch keine Aufgaben vorhanden</p>
                  {isAdmin && <p className="text-xs text-gray-300 mt-1">Klicke auf „Neu" um eine Aufgabe hinzuzufügen</p>}
                </div>
              ) : (
                <>
                  {/* Open items */}
                  {items.filter(t => !t.done).map((item, _) => {
                    const realIdx = items.indexOf(item);
                    return (
                      <div key={item.id || realIdx}
                        className="border border-gray-200 rounded-xl p-3.5 bg-white group transition-all hover:border-gray-300">
                        <div className="flex items-start gap-3">
                          {/* Checkbox */}
                          <button onClick={() => toggleDone(realIdx)} disabled={saving}
                            className="w-5 h-5 rounded border-2 border-gray-300 hover:border-gray-700 flex items-center justify-center flex-shrink-0 mt-0.5 transition-all"/>
                          {/* Text */}
                          <div className="min-w-0 flex-1">
                            <div className="flex items-center gap-2 flex-wrap">
                              <p className="text-sm font-medium text-gray-900">{item.label}</p>
                              <span className={`text-[10px] font-semibold px-1.5 py-0.5 rounded-full ${
                                item.priority === 'high' ? 'bg-gray-900 text-white' :
                                item.priority === 'medium' ? 'bg-gray-100 text-gray-600' : 'bg-gray-50 text-gray-400'
                              }`}>{PRIORITY_LABEL[item.priority] || ''}</span>
                            </div>
                            {item.desc && <p className="text-xs text-gray-500 mt-0.5 leading-relaxed">{item.desc}</p>}
                          </div>
                          {/* Admin actions */}
                          {isAdmin && (
                            <div className="flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                              <button onClick={() => openEdit(realIdx)}
                                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition-all">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                              </button>
                              <button onClick={() => setDeleteIdx(realIdx)}
                                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-500 transition-all">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}

                  {/* Divider between open/done */}
                  {items.some(t => t.done) && items.some(t => !t.done) && (
                    <div className="flex items-center gap-3 py-1">
                      <div className="h-px flex-1 bg-gray-100"/>
                      <span className="text-[10px] text-gray-300 uppercase tracking-wide">erledigt</span>
                      <div className="h-px flex-1 bg-gray-100"/>
                    </div>
                  )}

                  {/* Done items */}
                  {items.filter(t => t.done).map((item) => {
                    const realIdx = items.indexOf(item);
                    return (
                      <div key={item.id || realIdx}
                        className="border border-gray-100 rounded-xl p-3.5 bg-gray-50 opacity-60 group transition-all">
                        <div className="flex items-start gap-3">
                          {/* Checked box */}
                          <button onClick={() => toggleDone(realIdx)} disabled={saving}
                            className="w-5 h-5 rounded bg-gray-900 border-2 border-gray-900 flex items-center justify-center flex-shrink-0 mt-0.5 flex-shrink-0 transition-all hover:bg-gray-700">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>
                          </button>
                          <div className="min-w-0 flex-1">
                            <p className="text-sm font-medium text-gray-400 line-through">{item.label}</p>
                            {item.desc && <p className="text-xs text-gray-300 mt-0.5">{item.desc}</p>}
                          </div>
                          {isAdmin && (
                            <div className="flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                              <button onClick={() => openEdit(realIdx)}
                                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-all">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                              </button>
                              <button onClick={() => setDeleteIdx(realIdx)}
                                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-400 transition-all">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}

                  {/* All done celebration */}
                  {items.length > 0 && done === items.length && (
                    <div className="text-center py-4">
                      <p className="text-xs text-gray-400">Alle Aufgaben abgeschlossen 🎉</p>
                    </div>
                  )}
                </>
              )}
            </div>

            {/* Footer */}
            <div className="p-5 pt-3 flex-shrink-0">
              <button onClick={onClose} className="w-full border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                Schließen
              </button>
            </div>
          </div>

          {/* ── Form Modal (Create / Edit) ── */}
          {form && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <h3 className="text-base font-semibold text-gray-900">
                    {form.mode === 'create' ? 'Aufgabe hinzufügen' : 'Aufgabe bearbeiten'}
                  </h3>
                  <button onClick={() => setForm(null)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-4">
                  {/* Bezeichnung */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Bezeichnung *</p>
                    <input type="text" autoFocus placeholder="z. B. Datenschutz überprüfen"
                      value={formVals.label}
                      onChange={e => setFormVals({ ...formVals, label: e.target.value })}
                      className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"/>
                  </div>
                  {/* Beschreibung */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Beschreibung</p>
                    <textarea placeholder="Details, Kontext, Teilaufgaben…"
                      value={formVals.desc}
                      onChange={e => setFormVals({ ...formVals, desc: e.target.value })}
                      className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white resize-none min-h-16"/>
                  </div>
                  {/* Priorität */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Priorität</p>
                    <div className="grid grid-cols-3 gap-2">
                      {PRIORITY_KEYS.map(p => (
                        <button key={p} onClick={() => setFormVals({ ...formVals, priority: p })}
                          className={`py-2.5 rounded-xl text-xs font-medium border transition-all ${formVals.priority === p ? 'bg-gray-900 text-white border-gray-900' : 'border-gray-200 text-gray-600 hover:border-gray-400'}`}>
                          {PRIORITY_LABEL[p]}
                        </button>
                      ))}
                    </div>
                  </div>
                  {formErr && <p className="text-xs text-red-500">{formErr}</p>}
                  <div className="grid grid-cols-2 gap-3 pt-1">
                    <button onClick={submitForm} disabled={saving}
                      className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      {saving ? 'Speichert…' : 'Speichern'}
                    </button>
                    <button onClick={() => setForm(null)}
                      className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ── Delete Confirm ── */}
          {deleteIdx !== null && (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-xs shadow-xl p-5">
                <p className="text-sm font-semibold text-gray-900 mb-1">Aufgabe löschen?</p>
                <p className="text-xs text-gray-500 mb-5">„{items[deleteIdx]?.label}" wird unwiderruflich gelöscht.</p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={confirmDelete} disabled={saving}
                    className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:opacity-50 transition-all">
                    Löschen
                  </button>
                  <button onClick={() => setDeleteIdx(null)}
                    className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                    Abbrechen
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Main App
    const MainApp = ({ user, userData }) => {
      const [hedgehogs, setHedgehogs] = useState([]);
      const [users, setUsers] = useState([]);
      const [view, setView] = useState('overview');
      const [selected, setSelected] = useState(null);
      const [search, setSearch] = useState('');
      // const [filter, setFilter] = useState('alle'); // Removed - using statusFilter only
      const [showUserMgmt, setShowUserMgmt] = useState(false);
      const [showAddForm, setShowAddForm] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showChangelog, setShowChangelog] = useState(false);
      const [showDesignSpec, setShowDesignSpec] = useState(false);
      const [showTodoList, setShowTodoList] = useState(false);
      const [showCSVImport, setShowCSVImport] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'in_pflege', 'ueberwinterung', 'ausgewildert'
      const [betreuerFilter, setBetreuerFilter] = useState([]); // Array of caretaker names
      const [showBetreuerDialog, setShowBetreuerDialog] = useState(false);
      const [showDatabaseDialog, setShowDatabaseDialog] = useState(false);
      const [showDatenbankHub, setShowDatenbankHub] = useState(false);
      const [showMedDatenbank, setShowMedDatenbank] = useState(false);
      const [dashboardOpen, setDashboardOpen] = useState(true);
      const [verwaltungOpen, setVerwaltungOpen] = useState(true);
      const [bestandOpen, setBestandOpen] = useState(true);
      const [filterOpen, setFilterOpen] = useState(false);
      const [statusFilterPills, setStatusFilterPills] = useState([]);
      const [showStatusFilterDialog, setShowStatusFilterDialog] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [settings, setSettings] = useState(loadSettings);
      const [exportScope, setExportScope] = useState('all'); // 'all' | 'filtered'

      const updateSetting = (key, val) => {
        const next = { ...settings, [key]: val };
        setSettings(next);
        saveSettings(next);
      };

      const isGuest = userData?.role === 'gast';
      const [showQRScanner, setShowQRScanner] = useState(false);

      const isAdmin = userData?.role === 'admin';

      // Browser Back/Forward support (Punkt 9 - simplified)
      useEffect(() => {
        const handleHashChange = () => {
          const hash = window.location.hash;
          if (!hash || hash === '#') {
            setSelected(null);
          }
        };
        
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      // Load hedgehogs
      useEffect(() => {
        const unsubscribe = db.collection('hedgehogs')
          .orderBy('aufnahmedatum', 'desc')
          .onSnapshot(snapshot => {
            setHedgehogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });
        return () => unsubscribe();
      }, []);

      // Load users (admin only)
      useEffect(() => {
        if (!isAdmin) return;
        const unsubscribe = db.collection('users').onSnapshot(snapshot => {
          setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
      }, [isAdmin]);

      const statusOptions = [
        { value: 'aufnahme', label: 'Aufnahme', color: 'bg-red-100 text-red-800' },
        { value: 'pflege', label: 'In Pflege', color: 'bg-blue-100 text-blue-800' },
        { value: 'ueberwinterung', label: 'Überwinterung', color: 'bg-blue-200 text-blue-900' },
        { value: 'auswilderung_bereit', label: 'Auswilderungsbereit', color: 'bg-blue-100 text-blue-800' },
        { value: 'ausgewildert', label: 'Ausgewildert', color: 'bg-gray-100 text-gray-800' },
        { value: 'verstorben', label: 'Verstorben', color: 'bg-black text-white' }
      ];

      const getStatus = (val) => statusOptions.find(s => s.value === val) || {};

      const filteredHedgehogs = hedgehogs.filter(h => {
        // Status filter via pills (multi-select)
        if (statusFilterPills.length > 0 && !statusFilterPills.includes(h.status)) {
          return false;
        }

        // Betreuer filter (multiple select)
        if (betreuerFilter.length > 0 && !betreuerFilter.includes(h.betreuer)) {
          return false;
        }
        
        // Search filter
        if (search.trim()) {
          const s = search.toLowerCase();
          return (
            (h.name || '').toLowerCase().includes(s) ||
            (h.igelId || '').toLowerCase().includes(s) ||
            (h.fundort || '').toLowerCase().includes(s) ||
            (h.finderName || '').toLowerCase().includes(s)
          );
        }
        
        return true;
      });

      if (selected) {
        return <HedgehogDetail 
          hedgehog={selected} 
          userData={userData}
          users={users}
          initialEditMode={!!settings.openInEditMode}
          onBack={() => { 
            setSelected(null); 
            window.history.pushState({}, '', window.location.pathname);
          }}
          onUpdate={(updated) => setSelected(updated)}
        />;
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Sidebar Overlay */}
          <div 
            className={`sidebar-overlay ${sidebarOpen ? 'visible' : ''}`}
            onClick={() => setSidebarOpen(false)}
          ></div>
          
          {/* Sidebar */}
          <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
            {/* Profile Section */}
            <div 
              className="p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition-all"
              onClick={() => { setShowProfile(true); setSidebarOpen(false); }}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                  {userData?.name?.[0] || '?'}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-xs text-gray-900 truncate">
                    {userData?.name || 'Benutzer'}
                  </div>
                  <div className="text-xs text-gray-500">
                    {userData?.role === 'admin' ? 'Administrator' : userData?.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}
                  </div>
                </div>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400 flex-shrink-0">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </div>
            </div>
            
            {/* App Title */}
            <div className="px-3 py-1 text-xs">
              <div className="text-xs font-semibold text-gray-400 uppercase tracking-wide">
                IGELPFLEGE PRO
              </div>
            </div>
            
            {/* Menu Items */}
            <div className="py-2">
              <div className="sidebar-item" onClick={() => { setShowDatenbankHub(true); setSidebarOpen(false); }}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                  </svg>
                  <span>Datenbank</span>
                </div>
              
              <div className="sidebar-item" onClick={() => { setShowUserMgmt(true); setSidebarOpen(false); }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Benutzerverwaltung</span>
              </div>

              <div className="sidebar-item" onClick={() => { setShowSettings(true); setSidebarOpen(false); }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <span>Einstellungen</span>
              </div>

              {isAdmin && (
                <div className="sidebar-item" onClick={() => { setShowDesignSpec(true); setSidebarOpen(false); }}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                    <polyline points="16 18 22 12 16 6"/>
                    <polyline points="8 6 2 12 8 18"/>
                  </svg>
                  <span>App Spezifikation</span>
                </div>
              )}
              
              {isAdmin && (
                <div className="sidebar-item" onClick={() => { setShowTodoList(true); setSidebarOpen(false); }}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                    <polyline points="9 11 12 14 22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                  <span>To-Do</span>
                </div>
              )}

              <div className="sidebar-item" onClick={() => { setShowChangelog(true); setSidebarOpen(false); }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4"/>
                  <path d="M12 8h.01"/>
                </svg>
                <span>Info & Changelog</span>
              </div>
              
              <div className="border-t border-gray-200 my-2"></div>
              
              <div className="sidebar-item text-red-600 hover:text-red-700 hover:bg-red-50" onClick={() => auth.signOut()}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="flex-shrink-0">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <polyline points="16 17 21 12 16 7"/>
                  <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Abmelden</span>
              </div>
            </div>
            
            {/* Version - bottom */}
            <div className="px-3 py-2 border-t border-gray-200 mt-auto">
              <div className="text-[10px] text-gray-400 text-center">
                Version 1.8.42
              </div>
            </div>
          </div>
          
          {/* Header */}
          <div className="bg-blue-600/90 backdrop-blur-sm text-white px-3 py-2.5 sticky top-0 z-40 shadow-sm">
            <div className="flex items-center justify-between">
              {/* Hamburger */}
              <button 
                onClick={() => setSidebarOpen(true)}
                className="p-2 hover:bg-white/10 rounded-lg transition-all"
                title="Menü"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                  <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
              </button>
              
              {/* App Name - Center */}
              <div className="absolute left-1/2 transform -translate-x-1/2">
                <h1 className="text-xs font-semibold tracking-wide">
                  IGELPFLEGE PRO
                </h1>
              </div>
              
              {/* Profile Avatar */}
              <button
                onClick={() => { setShowProfile(true); }}
                className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-xs font-semibold transition-all"
                title="Profil"
              >
                {userData?.name?.[0] || '?'}
              </button>
            </div>
          </div>

          {/* === DASHBOARD SECTION === */}
          <div className="border-b border-gray-100">
            <button
              onClick={() => setDashboardOpen(!dashboardOpen)}
              className="w-full flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-all"
            >
              <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">Dashboard</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" className={`text-gray-400 transition-transform ${dashboardOpen ? '' : '-rotate-90'}`}>
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </button>
            {dashboardOpen && (
              <div className="px-4 pb-4 pt-1">
                {statusFilterPills.length > 0 && (
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xs text-gray-400">Filter aktiv —</span>
                    <button
                      onClick={() => setStatusFilterPills([])}
                      className="text-xs text-gray-500 hover:text-gray-900 underline"
                    >zurücksetzen</button>
                  </div>
                )}
                <DashboardDonut
                  hedgehogs={hedgehogs}
                  activeFilter={statusFilterPills}
                  onSegmentClick={(val) => {
                    setStatusFilterPills(prev =>
                      prev.includes(val) ? prev.filter(v => v !== val) : [...prev, val]
                    );
                    setBestandOpen(true);
                  }}
                  onClearFilter={() => setStatusFilterPills([])}
                />
              </div>
            )}
          </div>

          {/* === VERWALTUNG SECTION === */}
          <div className="border-b border-gray-100">
            <button
              onClick={() => setVerwaltungOpen(!verwaltungOpen)}
              className="w-full flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-all"
            >
              <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">Verwaltung</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" className={`text-gray-400 transition-transform ${verwaltungOpen ? '' : '-rotate-90'}`}>
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </button>
            {verwaltungOpen && (
              <div className="px-4 pb-4 grid grid-cols-2 gap-3">
                <button
                  onClick={() => !isGuest && setShowAddForm(true)}
                  disabled={isGuest}
                  className={`py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2 ${isGuest ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-gray-700'}`}
                >
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                  Igel aufnehmen
                </button>
                <button
                  onClick={() => setShowQRScanner(true)}
                  className="border border-gray-200 text-gray-700 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all flex items-center justify-center gap-2"
                >
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                  </svg>
                  Scan QR-Code
                </button>
              </div>
            )}
          </div>

          {/* === BESTAND SECTION === */}
          <div className="border-b border-gray-100">
            <button
              onClick={() => setBestandOpen(!bestandOpen)}
              className="w-full flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-all"
            >
              <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">
                Bestand {filteredHedgehogs.length !== hedgehogs.length ? `(${filteredHedgehogs.length}/${hedgehogs.length})` : `(${hedgehogs.length})`}
              </span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" className={`text-gray-400 transition-transform ${bestandOpen ? '' : '-rotate-90'}`}>
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </button>
            {bestandOpen && (
              <div className="px-4 pb-3">
                {/* Suchfeld */}
                <div className="relative mb-3">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                  </svg>
                  <input
                    type="text"
                    placeholder="Igelname, ID, Finder, Fundort..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full pl-9 pr-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-gray-400 bg-white"
                  />
                </div>

                {/* Filter Sub-Section */}
                <div className="border border-gray-100 rounded-xl overflow-hidden">
                  <button
                    onClick={() => setFilterOpen(!filterOpen)}
                    className="w-full flex items-center justify-between px-3 py-2.5 hover:bg-gray-50 transition-all"
                  >
                    <div className="flex items-center gap-2">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                      </svg>
                      <span className="text-xs font-medium text-gray-500">Filter</span>
                      {(betreuerFilter.length > 0 || statusFilterPills.length > 0) && (
                        <span className="text-[10px] bg-gray-900 text-white px-1.5 py-0.5 rounded-full">
                          {betreuerFilter.length + statusFilterPills.length}
                        </span>
                      )}
                    </div>
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" className={`text-gray-400 transition-transform ${filterOpen ? '' : '-rotate-90'}`}>
                      <path d="M7 10l5 5 5-5z"/>
                    </svg>
                  </button>
                  {filterOpen && (
                    <div className="border-t border-gray-100 px-3 py-3 flex flex-wrap gap-2">
                      <button
                        onClick={() => setShowBetreuerDialog(true)}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium transition-all ${betreuerFilter.length > 0 ? 'bg-gray-900 text-white border-gray-900' : 'border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        </svg>
                        Betreuer {betreuerFilter.length > 0 && `(${betreuerFilter.length})`}
                      </button>
                      <button
                        onClick={() => setShowStatusFilterDialog(true)}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium transition-all ${statusFilterPills.length > 0 ? 'bg-gray-900 text-white border-gray-900' : 'border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>
                        </svg>
                        Status {statusFilterPills.length > 0 && `(${statusFilterPills.length})`}
                      </button>
                      {(betreuerFilter.length > 0 || statusFilterPills.length > 0) && (
                        <button
                          onClick={() => { setBetreuerFilter([]); setStatusFilterPills([]); }}
                          className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs text-gray-400 hover:text-gray-600 transition-all"
                        >
                          Alle zurücksetzen
                        </button>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* === IGELKARTEN LISTE === */}
          {bestandOpen && (
            <div className="px-4 pt-3 pb-24 space-y-2 fade-in">
              {filteredHedgehogs.map(h => (
                <div key={h.id} onClick={() => {
                  setSelected(h);
                  window.history.pushState({}, '', `#igel-${h.id}`);
                }}
                  className="bg-white border border-gray-100 rounded-xl p-4 cursor-pointer hover:shadow-sm transition-all active:scale-[0.99]">
                  <div className="flex justify-between items-start mb-2">
                    <h3 className="font-semibold text-sm text-gray-900">{h.name || 'Unbenannt'}</h3>
                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                      h.status === 'aufnahme' ? 'bg-amber-100 text-amber-800' :
                      h.status === 'pflege' ? 'bg-blue-100 text-blue-800' :
                      h.status === 'ueberwinterung' ? 'bg-indigo-100 text-indigo-700' :
                      h.status === 'auswilderung_bereit' ? 'bg-emerald-100 text-emerald-800' :
                      h.status === 'ausgewildert' ? 'bg-gray-100 text-gray-500' :
                      'bg-gray-900 text-white'
                    }`}>
                      {h.status === 'aufnahme' ? 'Aufnahme' :
                       h.status === 'pflege' ? 'In Pflege' :
                       h.status === 'ueberwinterung' ? 'Überwinterung' :
                       h.status === 'auswilderung_bereit' ? 'Auswilderungsbereit' :
                       h.status === 'ausgewildert' ? 'Ausgewildert' : 'Verstorben'}
                    </span>
                  </div>
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-xs text-gray-400">Finder</span>
                      <span className="text-xs font-medium text-gray-700">{h.finderName || '–'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-xs text-gray-400">Fundort</span>
                      <span className="text-xs font-medium text-gray-700 truncate ml-4 max-w-[60%] text-right">{h.fundort || '–'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-xs text-gray-400">Betreuer</span>
                      <span className="text-xs font-medium text-gray-700">{h.betreuer || '–'}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-1 mt-2 pt-2 border-t border-gray-50">
                    <span className="text-[10px] font-mono text-gray-300">{h.igelId}</span>
                    {h.gewichtAktuell && (
                      <>
                        <span className="text-[10px] text-gray-200">·</span>
                        <span className="text-[10px] text-gray-400">{h.gewichtAktuell}g</span>
                      </>
                    )}
                    {h.geschlecht && (
                      <>
                        <span className="text-[10px] text-gray-200">·</span>
                        <span className="text-[10px] text-gray-400">{h.geschlecht}</span>
                      </>
                    )}
                  </div>
                </div>
              ))}
              {filteredHedgehogs.length === 0 && (
                <div className="text-center py-16 text-gray-400">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="mx-auto mb-3 text-gray-300">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                  </svg>
                  <p className="text-sm font-medium text-gray-500 mb-1">Keine Igel gefunden</p>
                  <p className="text-xs">Filter anpassen oder Igel erfassen</p>
                </div>
              )}
            </div>
          )}

          {/* User Management Modal */}
          {showUserMgmt && (
            <UserManagement users={users} userData={userData} onClose={() => setShowUserMgmt(false)} />
          )}

          {/* User Profile Modal */}
          {showProfile && (
            <UserProfile userData={userData} onClose={() => setShowProfile(false)} />
          )}

          {/* Changelog Modal */}
          {showTodoList && (
            <TodoList onClose={() => setShowTodoList(false)} userData={userData} />
          )}

          {showChangelog && (
            <Changelog onClose={() => setShowChangelog(false)} />
          )}

          {showDesignSpec && (
            <DesignSpec onClose={() => setShowDesignSpec(false)} />
          )}

          {/* Add Form */}
          {showAddForm && (
            <AddHedgehogForm 
              userData={userData} 
              users={users}
              settings={settings}
              onClose={() => setShowAddForm(false)} 
            />
          )}

          {showCSVImport && (
            <CSVImportDialog 
              userData={userData}
              onClose={() => setShowCSVImport(false)} 
            />
          )}

          {/* Status Filter Dialog */}
          {showStatusFilterDialog && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={() => setShowStatusFilterDialog(false)}>
              <div className="bg-white rounded-2xl w-full max-w-md shadow-xl" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">Status filtern</h2>
                  </div>
                  <button onClick={() => setShowStatusFilterDialog(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-2">
                  <div className="flex items-center justify-between mb-3">
                    <span className="text-xs text-gray-500">{statusFilterPills.length > 0 ? `${statusFilterPills.length} ausgewählt` : 'Alle Status'}</span>
                    {statusFilterPills.length > 0 && (
                      <button onClick={() => setStatusFilterPills([])} className="text-xs text-gray-500 hover:text-gray-700 underline">Alle abwählen</button>
                    )}
                  </div>
                  {[
                    { value: 'aufnahme', label: 'Aufnahme' },
                    { value: 'pflege', label: 'In Pflege' },
                    { value: 'ueberwinterung', label: 'Überwinterung' },
                    { value: 'auswilderung_bereit', label: 'Auswilderungsbereit' },
                    { value: 'ausgewildert', label: 'Ausgewildert' },
                    { value: 'verstorben', label: 'Verstorben' },
                  ].map(s => (
                    <label key={s.value} className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 cursor-pointer transition-all">
                      <input
                        type="checkbox"
                        checked={statusFilterPills.includes(s.value)}
                        onChange={(e) => {
                          if (e.target.checked) setStatusFilterPills([...statusFilterPills, s.value]);
                          else setStatusFilterPills(statusFilterPills.filter(v => v !== s.value));
                        }}
                        className="w-4 h-4"
                      />
                      <div className="flex-1">
                        <span className="text-sm font-medium text-gray-900">{s.label}</span>
                      </div>
                      <span className="text-xs text-gray-400">{hedgehogs.filter(h => h.status === s.value).length}</span>
                    </label>
                  ))}
                </div>
                <div className="p-5 border-t border-gray-100">
                  <button onClick={() => setShowStatusFilterDialog(false)} className="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 rounded-xl text-sm font-medium transition-all">Anwenden</button>
                </div>
              </div>
            </div>
          )}

          {/* QR Scanner Modal - Real camera */}
          {showQRScanner && (
            <QRScannerModal
              hedgehogs={hedgehogs}
              onFound={(h) => { setShowQRScanner(false); setSelected(h); }}
              onClose={() => setShowQRScanner(false)}
            />
          )}

          {/* Settings Modal */}
          {showSettings && (
            <SettingsDialog settings={settings} onUpdate={updateSetting} onClose={() => setShowSettings(false)} />
          )}

          {/* Betreuer Filter Dialog */}
          {showBetreuerDialog && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={() => setShowBetreuerDialog(false)}>
              <div className="bg-white rounded-2xl w-full max-w-md shadow-xl" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                      <circle cx="9" cy="7" r="4"/>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">Betreuer filtern</h2>
                  </div>
                  <button onClick={() => setShowBetreuerDialog(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-2 max-h-80 overflow-y-auto">
                  <div className="flex items-center justify-between mb-3">
                    <span className="text-xs text-gray-500">
                      {betreuerFilter.length > 0 ? `${betreuerFilter.length} ausgewählt` : 'Alle Betreuer'}
                    </span>
                    {betreuerFilter.length > 0 && (
                      <button
                        onClick={() => setBetreuerFilter([])}
                        className="text-xs text-gray-500 hover:text-gray-700 underline">
                        Alle abwählen
                      </button>
                    )}
                  </div>
                  {users.filter(u => u.active && !u.deleted).map(user => (
                    <label
                      key={user.id}
                      className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 cursor-pointer transition-all">
                      <input
                        type="checkbox"
                        checked={betreuerFilter.includes(user.name)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setBetreuerFilter([...betreuerFilter, user.name]);
                          } else {
                            setBetreuerFilter(betreuerFilter.filter(n => n !== user.name));
                          }
                        }}
                        className="w-4 h-4"
                      />
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-900">{user.name}</div>
                        <div className="text-xs text-gray-400">{user.email}</div>
                      </div>
                      <div className="text-xs text-gray-400">
                        {hedgehogs.filter(h => h.betreuer === user.name).length} Igel
                      </div>
                    </label>
                  ))}
                </div>
                <div className="p-5 border-t border-gray-100">
                  <button
                    onClick={() => setShowBetreuerDialog(false)}
                    className="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 rounded-xl text-sm font-medium transition-all">
                    Anwenden
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Database Dialog */}
          {showDatabaseDialog && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={() => setShowDatabaseDialog(false)}>
              <div className="bg-white rounded-2xl w-full max-w-md shadow-xl" onClick={(e) => e.stopPropagation()}>

                {/* Header – same as UserManagement */}
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <ellipse cx="12" cy="5" rx="9" ry="3"/>
                      <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">Datenbank</h2>
                  </div>
                  <button onClick={() => setShowDatabaseDialog(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>

                <div className="p-5 space-y-3">
                  <p className="text-xs text-gray-500">Igeldaten als CSV-Datei exportieren oder importieren.</p>

                  {/* Export scope */}
                  <div className="bg-gray-50 rounded-xl p-4 space-y-2">
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Export-Umfang</p>
                    {[
                      { val: 'all', label: 'Alle Daten', desc: `${hedgehogs.length} Igel` },
                      { val: 'filtered', label: 'Gefilterte Daten', desc: `${filteredHedgehogs.length} Igel (aktuelle Filtereinstellung)` },
                    ].map(opt => (
                      <label key={opt.val} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${exportScope === opt.val ? 'border-gray-900 bg-white' : 'border-gray-200 bg-white hover:bg-gray-50'}`}>
                        <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${exportScope === opt.val ? 'border-gray-900' : 'border-gray-300'}`}>
                          {exportScope === opt.val && <div className="w-2 h-2 rounded-full bg-gray-900"/>}
                        </div>
                        <input type="radio" className="hidden" checked={exportScope === opt.val} onChange={() => setExportScope(opt.val)} />
                        <div>
                          <p className="text-sm font-medium text-gray-900">{opt.label}</p>
                          <p className="text-xs text-gray-400">{opt.desc}</p>
                        </div>
                      </label>
                    ))}
                  </div>

                  <button
                    onClick={() => { exportToCSV(exportScope === 'filtered' ? filteredHedgehogs : hedgehogs); setShowDatabaseDialog(false); }}
                    className="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    CSV exportieren
                  </button>
                  <button
                    onClick={() => { setShowCSVImport(true); setShowDatabaseDialog(false); }}
                    className="w-full border border-gray-200 hover:bg-gray-50 text-gray-700 py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    CSV importieren
                  </button>
                </div>

              </div>
            </div>
          )}

          {/* ── Datenbank Hub ── */}
          {showDatenbankHub && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in" onClick={() => setShowDatenbankHub(false)}>
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <ellipse cx="12" cy="5" rx="9" ry="3"/>
                      <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">Datenbank</h2>
                  </div>
                  <button onClick={() => setShowDatenbankHub(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-3">
                  <p className="text-xs text-gray-400">Wähle einen Bereich:</p>
                  {/* Datensätze */}
                  <button onClick={() => { setShowDatenbankHub(false); setShowDatabaseDialog(true); }}
                    className="w-full flex items-center gap-4 border border-gray-200 rounded-xl p-4 hover:border-gray-900 hover:bg-gray-50 transition-all text-left">
                    <div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                    </div>
                    <div>
                      <p className="text-sm font-semibold text-gray-900">Datensätze</p>
                      <p className="text-xs text-gray-400 mt-0.5">Igeldaten exportieren & importieren</p>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-300 ml-auto flex-shrink-0"><polyline points="9 18 15 12 9 6"/></svg>
                  </button>
                  {/* Medikation Stammdaten */}
                  <button onClick={() => { setShowDatenbankHub(false); setShowMedDatenbank(true); }}
                    className="w-full flex items-center gap-4 border border-gray-200 rounded-xl p-4 hover:border-gray-900 hover:bg-gray-50 transition-all text-left">
                    <div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                      </svg>
                    </div>
                    <div>
                      <p className="text-sm font-semibold text-gray-900">Medikation</p>
                      <p className="text-xs text-gray-400 mt-0.5">{isAdmin ? 'Gruppen, Behandlungen, Arten & Häufigkeiten' : 'Ansicht — Bearbeiten nur für Admins'}</p>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-300 ml-auto flex-shrink-0"><polyline points="9 18 15 12 9 6"/></svg>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ── Medikation Stammdaten ── */}
          {showMedDatenbank && (
            <MedikationDatenbank userData={{ ...userData, uid: user.uid }} onClose={() => setShowMedDatenbank(false)} />
          )}

        </div>
      );
    };


    // CSV Import Dialog (Punkt 8)
    const CSVImportDialog = ({ userData, onClose }) => {
      const [file, setFile] = useState(null);
      const [preview, setPreview] = useState(null);
      const [importing, setImporting] = useState(false);
      const [result, setResult] = useState(null);

      const handleFileSelect = (e) => {
        const selectedFile = e.target.files[0];
        if (!selectedFile) return;
        if (!selectedFile.name.endsWith('.csv')) {
          alert('Bitte CSV-Datei auswählen');
          return;
        }
        setFile(selectedFile);
        const reader = new FileReader();
        reader.onload = (event) => {
          const csvText = event.target.result;
          const parsed = parseCSV(csvText);
          setPreview(parsed);
        };
        reader.readAsText(selectedFile);
      };

      const handleImport = async () => {
        if (!preview || !preview.success) return;

        setImporting(true);
        let imported = 0;
        let errors = 0;

        for (const hedgehog of preview.data) {
          try {
            const existing = await db.collection('hedgehogs').where('igelId', '==', hedgehog.igelId).get();
            const data = {
              ...hedgehog,
              erstelltVon: userData.name,
              erstelltVonId: 'import',
              erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
              zuletztBearbeitetVon: userData.name,
              zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!existing.empty) {
              await db.collection('hedgehogs').doc(existing.docs[0].id).update(data);
            } else {
              await db.collection('hedgehogs').add(data);
            }
            imported++;
          } catch (err) {
            errors++;
          }
        }

        setResult({ imported, errors });
        setImporting(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-xl">

            <div className="flex items-center justify-between p-5 border-b border-gray-100">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">CSV Import</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-4">
              {!result ? (
                <>
                  <div className="bg-gray-50 rounded-xl p-4">
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Format</p>
                    <p className="text-xs text-gray-400">Igel-ID, Name, Status, Aufnahmedatum, Geschlecht (Pflichtfelder)</p>
                  </div>

                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleFileSelect}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm"
                  />

                  {preview && (
                    <div className="border border-gray-100 rounded-xl p-4">
                      {preview.success ? (
                        <div className="space-y-3">
                          <div className="flex items-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-gray-700">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span className="text-sm font-medium text-gray-900">{preview.data.length} Igel bereit</span>
                          </div>
                          {preview.error && (
                            <p className="text-xs text-gray-500">{preview.error}</p>
                          )}
                          <div className="grid grid-cols-2 gap-2">
                            <button
                              onClick={handleImport}
                              disabled={importing}
                              className="bg-gray-900 text-white px-4 py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                              {importing ? 'Importiere...' : 'Importieren'}
                            </button>
                            <button
                              onClick={() => { setFile(null); setPreview(null); }}
                              className="border border-gray-200 text-gray-600 px-4 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                              Abbrechen
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="space-y-3">
                          <p className="text-sm font-medium text-red-500">Fehler in der CSV-Datei</p>
                          <p className="text-xs text-gray-500">{preview.error}</p>
                          <button
                            onClick={() => { setFile(null); setPreview(null); }}
                            className="w-full border border-gray-200 text-gray-600 px-4 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                            Andere Datei wählen
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-8">
                  <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-gray-700">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </div>
                  <h3 className="text-base font-semibold text-gray-900 mb-1">Import abgeschlossen</h3>
                  <p className="text-sm text-gray-500 mb-4">
                    {result.imported} Igel importiert{result.errors > 0 && ` · ${result.errors} Fehler`}
                  </p>
                  <button
                    onClick={onClose}
                    className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">
                    Schließen
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Changelog Component
    const Changelog = ({ onClose }) => {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-xl">

            <div className="flex items-center justify-between p-5 border-b border-gray-100 sticky top-0 bg-white rounded-t-2xl">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Info &amp; Changelog</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-5">

              {/* App Info */}
              <div className="bg-gray-50 rounded-xl p-4">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">App</p>
                <p className="text-sm font-semibold text-gray-900">Igelpflegestation Pro</p>
                <p className="text-xs text-gray-400 mt-0.5">Version 1.8.42 · Cloud-basierte Tierpflege-Software</p>
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Changelog entries */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Änderungsprotokoll</p>
                <div className="space-y-4">

                  {[
                    { version: '1.8.42', label: 'To-Do: editierbar + Admin-only', items: [
                      'To-Do nur noch für Admins sichtbar (Sidebar-Eintrag + Zugriff)',
                      'Todos werden in Firestore (app_todos) gespeichert — geräteübergreifend',
                      'Neue Aufgaben anlegen, bearbeiten, löschen',
                      'Priorität wählbar: Hoch / Mittel / Niedrig',
                      'Löschen mit Bestätigungsdialog (Name der Aufgabe sichtbar)',
                      'Edit/Delete-Buttons erscheinen beim Hover',
                      'Offene und erledigte Aufgaben getrennt dargestellt',
                    ]},
                    { version: '1.8.41', label: 'To-Do Liste in Sidebar', items: [
                      'Neue To-Do Liste in der Sidebar-Navigation',
                      'Einträge: Datenschutz, Igelerfassung, Workflow, Drucklisten',
                      'Checkbox pro Aufgabe — Status wird lokal gespeichert',
                      'Fortschrittsbalken mit Prozentanzeige',
                      'Prioritäts-Badge (Hoch/Mittel) pro Aufgabe',
                    ]},
                    { version: '1.8.40', label: 'Medikation — Vollständige Überarbeitung', items: [
                      'STAMMDATEN: Hierarchie korrigiert — Art & Häufigkeit jetzt global (nicht mehr an Behandlung gebunden)',
                      'STAMMDATEN: Baumansicht Gruppe → Behandlung aufklappbar mit direktem Hinzufügen',
                      'STAMMDATEN: Löschschutz vereinfacht — nur noch Gruppe→Behandlung und Nutzung in Igelkarten',
                      'IGELKARTE: Neue Felder: Präparatname, Menge (Zahl), Einheit (Dropdown), Enddatum',
                      'IGELKARTE: Aktiv/Abgeschlossen-Status + Toggle-Button pro Eintrag',
                      'IGELKARTE: Sortierung: aktive Medikationen zuerst, dann abgeschlossene mit Trenner',
                      'IGELKARTE: Gruppe nur noch als Filter — Behandlung direkt wählbar',
                      'IGELKARTE: Validierung: kein Datum in Zukunft, Enddatum ≥ Startdatum, negative Mengen',
                      'IGELKARTE: deleteMedikation fix — löscht jetzt auch aus medikationen-Collection',
                      'IGELKARTE: Leere Stammdaten zeigen informativen Hinweis statt leere Dropdowns',
                    ]},
                    { version: '1.8.39', label: 'Soft-Duplikat-Warnung & Zugriffssteuerung', items: [
                      'Art & Häufigkeit: weiche Warnung bei gleichem Name in anderer Kategorie (nicht hart geblockt)',
                      'Warnung zeigt Übersicht wo der Name bereits existiert',
                      'User kann trotzdem hinzufügen oder abbrechen',
                      'Datenbank-Sidebar für alle Rollen sichtbar (wie Benutzerverwaltung)',
                      'Medikation Stammdaten: Schloss-Hinweis für Nicht-Admins (nur Ansicht)',
                      'Hub: Medikation-Kachel zeigt Rolle des Benutzers im Untertitel',
                    ]},
                    { version: '1.8.38', label: 'Duplikatschutz Medikation Stammdaten', items: [
                      'Gruppe: Name muss global eindeutig sein',
                      'Behandlung: Name eindeutig innerhalb der gewählten Gruppe',
                      'Art: Name eindeutig innerhalb der gewählten Behandlung',
                      'Häufigkeit: Name eindeutig innerhalb der gewählten Art',
                      'Fehlermeldung zeigt genauen Scope: „X existiert bereits in dieser Gruppe"',
                    ]},
                    { version: '1.8.37', label: 'Medikation: vollständige Hierarchie', items: [
                      'Neue Abhängigkeitskette: Gruppe → Behandlung → Art → Häufigkeit',
                      'Stammdaten-DB: Art bekommt Behandlung als Pflicht-Elternelement, Häufigkeit bekommt Art',
                      'Formular generisch — kein doppelter Code für Parent-Selektoren',
                      'Cascade-Update propagiert Namensänderungen durch die ganze Kette',
                      'Löschschutz für alle 4 Hierarchieebenen',
                      'Igelkarte: Dropdowns sperren bis vorherige Auswahl getroffen (grau + Hinweistext)',
                      'Jeder Dropdown filtert auf die Auswahl der vorherigen Ebene',
                      'Reset nachgelagerter Felder bei Änderung einer übergeordneten Auswahl',
                    ]},
                    { version: '1.8.36', label: 'Bugfix: Med Stammdaten Ladelogik', items: [
                      'Ladelogik auf individuelle onSnapshot-Handler umgestellt — kein geteilter Counter mehr',
                      '6s Timeout-Fallback verhindert ewigen Spinner',
                      'Fehlerbehandlung pro Collection — Permission-Error zeigt klare Meldung statt Freeze',
                      'Hinweis: Firestore Security Rules müssen med_* Collections abdecken',
                    ]},
                    { version: '1.8.35', label: 'Medikation Erfassung in Igelkarte', items: [
                      'Igelkarte: Medikations-Abschnitt ersetzt freie Behandlungsfelder',
                      'Modal: Datum, Gruppe (filtert Behandlungen), Behandlung *, Art, Menge, Häufigkeit, Notiz',
                      'Alle Felder aus Stammdaten (Datenbank → Medikation) befüllt',
                      'Einzel-Löschung per Papierkorb-Icon (nur im Edit-Modus)',
                      'Eintrag wird auch in eigener Firestore-Collection "medikationen" gespeichert (für Nutzungsprüfung)',
                      'Gäste haben keinen Bearbeitungszugriff',
                    ]},
                    { version: '1.8.34', label: 'Medikation Stammdaten-Datenbank', items: [
                      'Neues Modul: Medikation Stammdaten mit 4 Kategorien (Gruppe, Behandlung, Art, Häufigkeit)',
                      'Behandlung wird einer Gruppe zugeordnet — strukturierte Hierarchie',
                      'Löschschutz: Löschen nur möglich wenn kein Igelkarten-Datensatz referenziert',
                      'Cascade-Update: bei Umbenennung Auswahl ob auch alle Igelkarten aktualisiert werden',
                      'Häufigkeiten sortierbar per Reihenfolge-Feld (10, 20, 30 …)',
                      'Sidebar: "Datenbank" öffnet Hub mit Auswahl Datensätze / Medikation',
                      'Audit-Log für alle Stammdaten-Änderungen',
                    ]},
                    { version: '1.8.33', label: 'Bugfix: Passwort-Reset', items: [
                      'actionCodeSettings (continueUrl) entfernt — verursachte auth/unauthorized-continue-uri Fehler da dstindl.github.io nicht in Firebase allowlist',
                      'sendPasswordResetEmail läuft wieder ohne zusätzliche Parameter',
                    ]},
                    { version: '1.8.32', label: 'E-Mail & Einladungs-Fix', items: [
                      'InviteRegistration: direktes Passwort-Formular statt zweiter E-Mail (Bug: sendPasswordResetEmail für nicht-existenten Account wird von Firebase still ignoriert)',
                      'PasswordReset: actionCodeSettings mit continueUrl → Link in E-Mail führt zurück zur App',
                      'Erfolgsseite zeigt Absender-Adresse und Betreff-Hinweis zur Spam-Suche',
                      'Versionsnummer jetzt konsistent in Sidebar und Changelog',
                    ]},
                    { version: '1.8.31', label: 'Dashboard Verbesserungen', items: [
                      'Prozentwerte aus Legende entfernt — klarer, kompakter',
                      'Klick auf Mitte des Donuts löst alle Filter auf',
                      'Mitte zeigt "ALLE" in Blau wenn Filter aktiv, sonst "GESAMT"',
                    ]},
                    { version: '1.8.30', label: 'Dashboard Donut-Chart', items: [
                      'Donut-Chart ersetzt die 4 Stat-Kacheln im Dashboard',
                      'Grau/Blau-Farbsystem: Aufnahme blau, In Pflege schwarz, Überwinterung indigo',
                      'Klick auf Segment oder Legende aktiviert Schnellfilter für Igelbestand',
                      'Gesamtzahl exakt zentriert via dominantBaseline=central',
                      'Kompakte Legende rechts mit Anzahl + Prozent pro Status',
                      'Hover-Interaktion: Segment und Legendenzeile synchronisiert',
                      'Projektstand-Kommentar im HTML-Header für schnellen Chat-Einstieg',
                    ]},
                    { version: '1.8.29', label: 'UX & Stabilität', items: [
                      'Zurück-Button prüft ungespeicherte Änderungen — Modal: Speichern, Verwerfen oder Abbrechen',
                      'Einstellungen: Toggle „QR-Druckabfrage bei Erfassung" + neuer Toggle „Karte im Bearbeitungsmodus öffnen"',
                      'Nach Igel-Erfassen: optionaler QR-Druck-Prompt (Drucken / Überspringen)',
                      'Kopieren-Button durch Clipboard-Icon ersetzt — wechselt zu Checkmark nach Klick',
                      'Einladungstext korrigiert: kein Auto-Login mehr, korrekte Anleitung',
                      'Spam-Hinweis auf E-Mail-Seite fett & grau hervorgehoben',
                      'Erster-Login-Bug: Token-Refresh + Retry (800ms Delay) behebt Race Condition',
                      'Gast: Erfassen-Button ausgegraut, Kontextmenü ausgeblendet',
                      'Admin-Selbstschutz: Warnung + Prüfung ob weiterer Admin existiert → Logout',
                      'Admin kann sich nicht selbst löschen wenn letzter Admin (Fehlermeldung)',
                      'Benutzerverwaltung für alle sichtbar — Gast/Mitarbeiter sehen nur eigenen Account und können sich selbst löschen',
                      'QR-Druck: position: fixed, 2,5 cm Code, Text im Flex-Block — kein Seitenumbruch',
                      'Igelkarte scrollt bei Öffnen sofort nach oben (useRef + scrollIntoView)',
                      'Datenbank-Export: Radiobuttons „Alle Daten" / „Gefilterte Daten"',
                      'Alle Felder editierbar (Fundort, Finder, Telefon, E-Mail, Adresse, Aufnahmedatum, Gewicht) + Änderungshistorie',
                      'QR-Scanner: echte Kamera via jsQR-Library mit Permission-Request',
                    ]},
                    { version: '1.8.27', label: 'UI-Redesign', items: ['Neues Dashboard-Layout mit kollapierbaren Sektionen', 'Verwaltungsbereich mit Igel-aufnehmen & QR-Scan', 'Status- und Betreuer-Filter als Pill-Buttons', 'Auth-Screens komplett überarbeitet (kein Gradient, kein Emoji)', 'Igelkarten neu gestaltet mit Status-Badge', 'Changelog & CSV-Import neu designt'] },
                    { version: '1.8.26', label: 'QR-Code System', items: ['QR-Code Button im 3-Punkte-Menü', 'Modal mit QR-Code (180×180px)', 'Direkt-URL zur Igelkarte', 'Druck-Funktion'] },
                    { version: '1.8.22', label: 'Kontaktdaten', items: ['Telefon mit Länderauswahl-Dropdown', 'E-Mail-Feld mit Syntax-Validierung', 'Anklickbare Kontaktlinks'] },
                    { version: '1.8.21', label: 'Adress-Autocomplete', items: ['Live-Vorschläge via Nominatim (OpenStreetMap)', 'Deutschland-fokussiert', 'Debounced Search (800ms)'] },
                    { version: '1.8.13', label: 'Sicherheit', items: ['Deleted-User Bug behoben', 'Invite-Closure-System', 'Gelöschte User können sich nicht neu anmelden'] },
                    { version: '1.4.x', label: 'Design-System', items: ['Minimalistisches schwarz/weiß Design', 'Sidebar-Navigation', 'SVG Icons', 'Audit-Log'] },
                    { version: '1.0', label: 'Initial', items: ['Firebase Cloud-Synchronisation', 'User-Authentifizierung & Rollensystem', 'Igel-Verwaltung CRUD', 'CSV Import/Export'] },
                  ].map(entry => (
                    <div key={entry.version} className="border border-gray-100 rounded-xl p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xs font-mono text-gray-400">v{entry.version}</span>
                        <span className="text-xs font-medium text-gray-900">{entry.label}</span>
                      </div>
                      <div className="space-y-1">
                        {entry.items.map((item, i) => (
                          <p key={i} className="text-xs text-gray-500 flex items-start gap-1.5">
                            <span className="text-gray-300 mt-0.5">–</span>
                            {item}
                          </p>
                        ))}
                      </div>
                    </div>
                  ))}

                </div>
              </div>

              {/* Credits */}
              <div className="border-t border-gray-100 pt-4 text-center">
                <p className="text-xs text-gray-400">Entwickelt für Igelpflegestationen · Firebase &amp; React</p>
              </div>

            </div>
          </div>
        </div>
      );
    };

    // User Profile Component
    const UserProfile = ({ userData, onClose }) => {
      const [name, setName] = useState(userData.name);
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [saving, setSaving] = useState(false);

      const handleSaveName = async () => {
        if (!name.trim()) {
          setError('Name darf nicht leer sein');
          return;
        }

        setSaving(true);
        setError('');
        try {
          await db.collection('users').doc(auth.currentUser.uid).update({
            name: name.trim()
          });
          setSuccess('Name gespeichert!');
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          setError('Fehler beim Speichern: ' + err.message);
        }
        setSaving(false);
      };

      const handleChangePassword = async () => {
        setError('');
        setSuccess('');

        if (!currentPassword || !newPassword || !confirmPassword) {
          setError('Bitte alle Felder ausfüllen');
          return;
        }

        if (newPassword !== confirmPassword) {
          setError('Neue Passwörter stimmen nicht überein');
          return;
        }

        if (newPassword.length < 6) {
          setError('Neues Passwort muss mind. 6 Zeichen haben');
          return;
        }

        setSaving(true);

        try {
          // Re-authenticate user
          const credential = firebase.auth.EmailAuthProvider.credential(
            auth.currentUser.email,
            currentPassword
          );
          await auth.currentUser.reauthenticateWithCredential(credential);

          // Update password
          await auth.currentUser.updatePassword(newPassword);

          setSuccess('Passwort erfolgreich geändert!');
          setCurrentPassword('');
          setNewPassword('');
          setConfirmPassword('');
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          if (err.code === 'auth/wrong-password') {
            setError('Aktuelles Passwort ist falsch');
          } else {
            setError('Fehler: ' + err.message);
          }
        }
        setSaving(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto shadow-xl">

            {/* Header – identical to UserManagement */}
            <div className="flex items-center justify-between p-5 border-b border-gray-100">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Mein Profil</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-5">

              {/* Account Info */}
              <div className="bg-gray-50 rounded-xl p-4">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Account</p>
                <div className="space-y-2">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-500">E-Mail</span>
                    <span className="text-sm font-medium text-gray-900">{userData.email}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-500">Rolle</span>
                    <span className="text-sm font-medium text-gray-900">{
                      userData.role === 'admin' ? 'Administrator' :
                      userData.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'
                    }</span>
                  </div>
                </div>
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Name */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Name ändern</p>
                <div className="space-y-3">
                  <input
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                  />
                  <button
                    onClick={handleSaveName}
                    disabled={saving || name === userData.name}
                    className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
                  >
                    {saving ? 'Speichert...' : 'Name speichern'}
                  </button>
                </div>
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Password */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Passwort ändern</p>
                <div className="space-y-3">
                  <input
                    type="password"
                    placeholder="Aktuelles Passwort"
                    value={currentPassword}
                    onChange={(e) => setCurrentPassword(e.target.value)}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                  />
                  <input
                    type="password"
                    placeholder="Neues Passwort (mind. 6 Zeichen)"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                  />
                  <input
                    type="password"
                    placeholder="Neues Passwort bestätigen"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                  />
                  <button
                    onClick={handleChangePassword}
                    disabled={saving}
                    className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all"
                  >
                    {saving ? 'Ändert...' : 'Passwort ändern'}
                  </button>
                </div>
              </div>

              {/* Messages */}
              {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-xl text-sm">
                  {error}
                </div>
              )}
              {success && (
                <div className="bg-gray-50 text-gray-700 p-3 rounded-xl text-sm border border-gray-200">
                  ✓ {success}
                </div>
              )}

            </div>
          </div>
        </div>
      );
    };

    // =============================================
    // QR SCANNER MODAL (Real camera via jsQR)
    // =============================================
    const QRScannerModal = ({ hedgehogs, onFound, onClose }) => {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [error, setError] = useState('');
      const [scanning, setScanning] = useState(false);
      const streamRef = useRef(null);
      const rafRef = useRef(null);

      useEffect(() => {
        startCamera();
        return () => stopCamera();
      }, []);

      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          streamRef.current = stream;
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            videoRef.current.play();
            setScanning(true);
            rafRef.current = requestAnimationFrame(tick);
          }
        } catch (e) {
          setError('Kamera-Zugriff verweigert. Bitte Kamera-Berechtigung in den Browser-Einstellungen aktivieren.');
        }
      };

      const stopCamera = () => {
        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
      };

      const tick = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        if (!video || !canvas || video.readyState !== video.HAVE_ENOUGH_DATA) {
          rafRef.current = requestAnimationFrame(tick);
          return;
        }
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          // Parse igel ID from QR URL: #igel-IGL-xxx
          const match = code.data.match(/#igel-(IGL-\d+)/);
          if (match) {
            const igelId = match[1];
            const found = hedgehogs.find(h => h.igelId === igelId);
            if (found) { stopCamera(); onFound(found); return; }
          }
          // Fallback: try to match by full igelId string
          const found2 = hedgehogs.find(h => code.data.includes(h.igelId));
          if (found2) { stopCamera(); onFound(found2); return; }
          setError('QR-Code erkannt, aber kein passender Igel gefunden.');
        }
        rafRef.current = requestAnimationFrame(tick);
      };

      return (
        <div className="fixed inset-0 bg-black z-50 flex flex-col">
          <div className="flex items-center justify-between p-4 bg-black/80">
            <h2 className="text-sm font-semibold text-white">QR-Code scannen</h2>
            <button onClick={onClose} className="text-white/70 hover:text-white w-8 h-8 flex items-center justify-center">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div className="flex-1 relative flex items-center justify-center bg-black">
            <video ref={videoRef} className="w-full h-full object-cover" playsInline muted />
            <canvas ref={canvasRef} className="hidden" />
            {/* Scan frame overlay */}
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div className="w-56 h-56 relative">
                <div className="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white rounded-tl-lg"/>
                <div className="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white rounded-tr-lg"/>
                <div className="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white rounded-bl-lg"/>
                <div className="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white rounded-br-lg"/>
              </div>
            </div>
          </div>
          <div className="p-4 bg-black/80 text-center">
            {error
              ? <p className="text-xs text-red-400">{error}</p>
              : <p className="text-xs text-white/60">QR-Code auf Igelkarte in den Rahmen halten</p>
            }
          </div>
        </div>
      );
    };

    // =============================================
    // SETTINGS DIALOG
    // =============================================
    const SettingsDialog = ({ settings, onUpdate, onClose }) => {
      const Toggle = ({ checked, onChange }) => (
        <div className={`toggle-track ${checked ? 'on' : ''}`} onClick={() => onChange(!checked)}>
          <div className="toggle-thumb"/>
        </div>
      );

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
            <div className="flex items-center justify-between p-5 border-b border-gray-100">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Einstellungen</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div className="p-5 space-y-1">
              <p className="text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-3">QR-Code</p>
              <div className="flex items-center justify-between py-3 border-b border-gray-50">
                <div>
                  <p className="text-sm font-medium text-gray-900">Druckabfrage bei Erfassung</p>
                  <p className="text-xs text-gray-400 mt-0.5">Nach dem Speichern eines neuen Igels zum QR-Druck fragen</p>
                </div>
                <Toggle
                  checked={!!settings.qrPrintOnCreate}
                  onChange={(v) => onUpdate('qrPrintOnCreate', v)}
                />
              </div>
              <div className="pt-4">
                <p className="text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-3">Igelkarte</p>
                <div className="flex items-center justify-between py-3 border-b border-gray-50">
                  <div>
                    <p className="text-sm font-medium text-gray-900">Direkt im Bearbeitungsmodus öffnen</p>
                    <p className="text-xs text-gray-400 mt-0.5">Igelkarte beim Öffnen oder QR-Scan sofort bearbeitbar</p>
                  </div>
                  <Toggle
                    checked={!!settings.openInEditMode}
                    onChange={(v) => onUpdate('openInEditMode', v)}
                  />
                </div>
              </div>
            </div>
            <div className="p-5 pt-3">
              <button onClick={onClose} className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">
                Schließen
              </button>
            </div>
          </div>
        </div>
      );
    };

    // User Management
    const UserManagement = ({ users, userData: currentUserData, onClose }) => {
      const [showInvite, setShowInvite] = useState(false);
      const [email, setEmail] = useState('');
      const [userName, setUserName] = useState('');
      const [role, setRole] = useState('mitarbeiter');
      const [link, setLink] = useState('');
      const [loading, setLoading] = useState(false);
      const [roleModal, setRoleModal] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [suspendConfirm, setSuspendConfirm] = useState(null);
      const [copyFeedback, setCopyFeedback] = useState(false);
      const [selfRoleConfirm, setSelfRoleConfirm] = useState(null);

      const isAdminUser = currentUserData?.role === 'admin';
      const currentUid = auth.currentUser?.uid;

      // For non-admins: only show own user
      const visibleUsers = isAdminUser
        ? users.filter(u => !u.deleted)
        : users.filter(u => !u.deleted && u.id === currentUid);

      const generateInvite = async () => {
        if (!userName || !email) { alert('Bitte Name und E-Mail eingeben'); return; }
        setLoading(true);
        try {
          const code = Math.random().toString(36).substring(2, 15);
          await db.collection('invites').add({
            code, email, userName, role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: auth.currentUser.uid,
            used: false
          });
          setLink(`${window.location.origin}${window.location.pathname}`);
        } catch (err) { alert('Fehler beim Erstellen: ' + err.message); }
        setLoading(false);
      };

      const copyLink = () => {
        navigator.clipboard.writeText(link);
        setCopyFeedback(true);
        setTimeout(() => setCopyFeedback(false), 1500);
      };

      const shareViaWhatsApp = () => {
        const text = `Du wurdest zur Igelpflegestation eingeladen.\n\nÖffne diesen Link:\n${link}\n\nKlicke auf "Passwort vergessen oder Einladung erhalten" und gib diese E-Mail ein:\n${email}\n\nDu erhältst eine E-Mail. Klicke den Link darin, setze dein Passwort und kehre dann zur App zurück, um dich einzuloggen.`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
      };

      const shareViaEmail = () => {
        const subject = 'Einladung zur Igelpflegestation';
        const body = `Hallo,\n\ndu wurdest zur Igelpflegestation eingeladen.\n\nÖffne diesen Link:\n${link}\n\nKlicke auf "Passwort vergessen oder Einladung erhalten" und gib deine E-Mail ein:\n${email}\n\nDu erhältst eine E-Mail mit einem Link. Klicke diesen, setze dein Passwort und kehre danach zur App zurück. Dort kannst du dich nun einloggen.\n\nViele Grüße\nDein Igelpflege-Team`;
        window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };

      const changeRole = (u) => {
        const isSelf = u.id === currentUid;
        setRoleModal({ userId: u.id, currentRole: u.role, selectedRole: u.role, userName: u.name, isSelf });
      };

      const saveRole = async () => {
        if (!roleModal) return;
        // If changing own role away from admin
        if (roleModal.isSelf && roleModal.selectedRole !== 'admin') {
          const otherAdmins = users.filter(u => u.role === 'admin' && u.id !== roleModal.userId && !u.deleted);
          if (otherAdmins.length === 0) {
            alert('Es muss mindestens ein weiterer Administrator verbleiben.');
            return;
          }
          setSelfRoleConfirm({ userId: roleModal.userId, newRole: roleModal.selectedRole });
          setRoleModal(null);
          return;
        }
        try {
          await db.collection('users').doc(roleModal.userId).update({ role: roleModal.selectedRole });
        } catch (err) { alert('Fehler: ' + err.message); }
        setRoleModal(null);
      };

      const confirmSelfRoleChange = async () => {
        if (!selfRoleConfirm) return;
        try {
          await db.collection('users').doc(selfRoleConfirm.userId).update({ role: selfRoleConfirm.newRole });
          setSelfRoleConfirm(null);
          onClose();
          await auth.signOut();
        } catch (err) { alert('Fehler: ' + err.message); }
      };

      const deleteUser = (u) => {
        const isSelf = u.id === currentUid;
        if (!isAdminUser && !isSelf) return;
        if (isAdminUser && isSelf) {
          const otherAdmins = users.filter(u2 => u2.role === 'admin' && u2.id !== currentUid && !u2.deleted);
          if (otherAdmins.length === 0) {
            alert('Du kannst dich nicht löschen, da du der einzige Administrator bist.');
            return;
          }
        }
        setDeleteConfirm({ userId: u.id, userName: u.name, isSelf });
      };

      const confirmDeleteUser = async () => {
        if (!deleteConfirm) return;
        const { userId, isSelf } = deleteConfirm;
        setDeleteConfirm(null);
        try {
          const userDoc = await db.collection('users').doc(userId).get();
          const userEmail = userDoc.exists ? userDoc.data().email : null;
          await db.collection('users').doc(userId).delete();
          if (userEmail) {
            const openInvites = await db.collection('invites').where('email', '==', userEmail).where('used', '==', false).get();
            const batch = db.batch();
            openInvites.docs.forEach(doc => batch.update(doc.ref, { used: true, usedAt: firebase.firestore.FieldValue.serverTimestamp(), closedByAdmin: true }));
            await batch.commit();
          }
          if (isSelf) { onClose(); await auth.signOut(); }
        } catch (err) { alert('Fehler beim Löschen: ' + err.message); }
      };

      const suspendUser = (u) => setSuspendConfirm({ userId: u.id, userName: u.name, currentActive: u.active });

      const confirmSuspendUser = async () => {
        if (!suspendConfirm) return;
        const { userId, currentActive } = suspendConfirm;
        setSuspendConfirm(null);
        try {
          const notification = currentActive
            ? { type: 'account_suspended', message: 'Dein Account wurde gesperrt.', timestamp: firebase.firestore.FieldValue.serverTimestamp() }
            : { type: 'account_activated', message: 'Dein Account wurde aktiviert.', timestamp: firebase.firestore.FieldValue.serverTimestamp() };
          await db.collection('users').doc(userId).update({ active: !currentActive, notification });
        } catch (err) { alert('Fehler: ' + err.message); }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-xl">
            <div className="flex items-center justify-between p-5 border-b border-gray-100">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Benutzerverwaltung</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-5">
              {/* Einladen — only for admins */}
              {isAdminUser && (
                <div>
                  <button
                    onClick={() => { setShowInvite(!showInvite); setLink(''); }}
                    className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all"
                  >
                    {showInvite ? 'Abbrechen' : 'Benutzer einladen'}
                  </button>

                  {showInvite && (
                    <div className="mt-4 space-y-3">
                      <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                        <p className="text-xs font-medium text-gray-500 uppercase tracking-wide">Neue Einladung</p>
                        <input type="text" placeholder="Name" value={userName} onChange={(e) => setUserName(e.target.value)}
                          className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
                        <input type="email" placeholder="E-Mail-Adresse" value={email} onChange={(e) => setEmail(e.target.value)}
                          className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400" />
                        <select value={role} onChange={(e) => setRole(e.target.value)}
                          className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white">
                          <option value="mitarbeiter">Mitarbeiter</option>
                          <option value="gast">Gast (nur lesen)</option>
                          <option value="admin">Administrator</option>
                        </select>
                        <button onClick={generateInvite} disabled={loading}
                          className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-300 transition-all">
                          {loading ? 'Erstelle...' : 'Einladungslink generieren'}
                        </button>
                      </div>

                      {link && (
                        <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide">Link teilen</p>
                          <div className="flex gap-2">
                            <input type="text" value={link} readOnly
                              className="flex-1 bg-white border border-gray-200 rounded-xl px-3 py-2.5 text-xs text-gray-600" />
                            <button onClick={copyLink}
                              className={`px-3 py-2 border rounded-xl transition-all flex items-center justify-center ${copyFeedback ? 'border-gray-900 bg-gray-900 text-white' : 'border-gray-200 text-gray-600 hover:bg-gray-100'}`}
                              title="Link kopieren">
                              {copyFeedback
                                ? <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                                : <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                              }
                            </button>
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <button onClick={shareViaWhatsApp}
                              className="py-2.5 border border-gray-200 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">WhatsApp</button>
                            <button onClick={shareViaEmail}
                              className="py-2.5 border border-gray-200 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">E-Mail</button>
                          </div>
                          <p className="text-xs text-gray-400">
                            Der User öffnet den Link, klickt "Passwort vergessen oder Einladung erhalten", gibt seine E-Mail ein, setzt sein Passwort und loggt sich danach ein.
                          </p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {isAdminUser && <div className="border-t border-gray-100"></div>}

              {/* User List */}
              <div className="space-y-3">
                {!isAdminUser && (
                  <div className="bg-gray-50 rounded-xl p-3">
                    <p className="text-xs text-gray-500">Du siehst nur deinen eigenen Account.</p>
                  </div>
                )}
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Benutzer ({visibleUsers.length})
                </p>
                {visibleUsers.map(u => {
                  const isSelf = u.id === currentUid;
                  return (
                    <div key={u.id} className="border border-gray-100 rounded-xl p-4">
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <p className="font-semibold text-gray-900 text-sm">{u.name} {isSelf && <span className="text-[10px] text-gray-400">(Du)</span>}</p>
                          <p className="text-xs text-gray-500 mt-0.5">{u.email}</p>
                          <p className="text-xs text-gray-400 mt-1">
                            {u.role === 'admin' ? 'Administrator' : u.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}
                          </p>
                        </div>
                        {isAdminUser && (
                          <button onClick={() => suspendUser(u)}
                            className={`text-xs px-2 py-1 rounded-full font-medium ${u.active ? 'bg-gray-100 text-gray-600 hover:bg-gray-200' : 'bg-gray-100 text-red-500 hover:bg-gray-200'} transition-all`}>
                            {u.active ? 'Aktiv' : 'Gesperrt'}
                          </button>
                        )}
                      </div>
                      <div className="flex gap-3 pt-2 border-t border-gray-50">
                        {isAdminUser && (
                          <button onClick={() => changeRole(u)} className="text-xs text-gray-600 hover:text-gray-900 font-medium transition-all">
                            Rolle ändern
                          </button>
                        )}
                        {isAdminUser && <span className="text-gray-200">|</span>}
                        <button onClick={() => deleteUser(u)}
                          className={`text-xs font-medium transition-all ${isSelf ? 'text-red-500 hover:text-red-700' : isAdminUser ? 'text-red-500 hover:text-red-700' : 'text-gray-300 cursor-not-allowed'}`}
                          disabled={!isAdminUser && !isSelf}>
                          {isSelf ? 'Account löschen' : 'Löschen'}
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Role Modal */}
          {roleModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <h2 className="text-base font-semibold text-gray-900">Rolle ändern — {roleModal.userName}</h2>
                  <button onClick={() => setRoleModal(null)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-2">
                  {roleModal.isSelf && (
                    <div className="bg-gray-50 rounded-xl p-3 mb-2">
                      <p className="text-xs text-gray-500">Du änderst deine eigene Rolle. Du wirst danach ausgeloggt.</p>
                    </div>
                  )}
                  {[
                    { value: 'admin', label: 'Administrator', desc: 'Vollzugriff' },
                    { value: 'mitarbeiter', label: 'Mitarbeiter', desc: 'Erfassen & bearbeiten' },
                    { value: 'gast', label: 'Gast', desc: 'Nur lesen' },
                  ].map(r => (
                    <button key={r.value} onClick={() => setRoleModal({ ...roleModal, selectedRole: r.value })}
                      className={`w-full text-left px-4 py-3 rounded-xl border transition-all ${roleModal.selectedRole === r.value ? 'border-gray-900 bg-gray-50' : 'border-gray-200 hover:bg-gray-50'}`}>
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm font-medium text-gray-900">{r.label}</p>
                          <p className="text-xs text-gray-400 mt-0.5">{r.desc}</p>
                        </div>
                        {roleModal.selectedRole === r.value && (
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-gray-900">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        )}
                      </div>
                    </button>
                  ))}
                  <div className="grid grid-cols-2 gap-3 pt-2">
                    <button onClick={() => setRoleModal(null)} className="py-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all">Abbrechen</button>
                    <button onClick={saveRole} className="py-3 bg-gray-900 text-white rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">Speichern</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Self role change confirm */}
          {selfRoleConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <h2 className="text-base font-semibold text-gray-900 mb-2">Rolle ändern &amp; ausloggen</h2>
                <p className="text-sm text-gray-500 mb-4">Deine Rolle wird auf <span className="font-medium text-gray-900">{selfRoleConfirm.newRole === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}</span> geändert. Du wirst danach ausgeloggt und hast keine Admin-Berechtigung mehr.</p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={confirmSelfRoleChange} className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">Ja, fortfahren</button>
                  <button onClick={() => setSelfRoleConfirm(null)} className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {/* Delete confirm */}
          {deleteConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <h2 className="text-base font-semibold text-gray-900 mb-2">{deleteConfirm.isSelf ? 'Account löschen' : 'Benutzer löschen'}</h2>
                <p className="text-sm text-gray-500 mb-4">
                  {deleteConfirm.isSelf
                    ? 'Deinen eigenen Account wirklich löschen? Du wirst ausgeloggt.'
                    : <><span className="font-medium text-gray-900">{deleteConfirm.userName}</span> wirklich löschen?</>}
                </p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={confirmDeleteUser} className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">Löschen</button>
                  <button onClick={() => setDeleteConfirm(null)} className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {/* Suspend confirm */}
          {suspendConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <h2 className="text-base font-semibold text-gray-900 mb-2">Benutzer {suspendConfirm.currentActive ? 'sperren' : 'entsperren'}</h2>
                <p className="text-sm text-gray-500 mb-4"><span className="font-medium text-gray-900">{suspendConfirm.userName}</span> wirklich {suspendConfirm.currentActive ? 'sperren' : 'entsperren'}?</p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={confirmSuspendUser} className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">{suspendConfirm.currentActive ? 'Sperren' : 'Entsperren'}</button>
                  <button onClick={() => setSuspendConfirm(null)} className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">Abbrechen</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const AddHedgehogForm = ({ userData, users, settings, onClose }) => {
      const [form, setForm] = useState({
        name: '',
        aufnahmedatum: new Date().toISOString().split('T')[0],
        status: 'aufnahme',
        fundort: '',
        finderName: '',
        finderCountryCode: '+49',
        finderTelefon: '',
        finderEmail: '',
        finderAdresse: '',
        geschlecht: '',
        alterSchaetzung: '',
        gewichtAktuell: '',
        betreuer: userData.name,
        notizen: '',
        ueberwinterungAktiv: false,
        ueberwinterungStart: '',
        ueberwinterungGewicht: ''
      });
      const [errors, setErrors] = useState({});
      const [saving, setSaving] = useState(false);
      const [addressSuggestions, setAddressSuggestions] = useState([]);
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [addressLoading, setAddressLoading] = useState(false);
      const [savedHedgehog, setSavedHedgehog] = useState(null); // For QR print prompt

      // Debounce timer ref
      const debounceTimer = useRef(null);

      const searchAddress = async (query) => {
        if (query.length < 3) {
          setAddressSuggestions([]);
          setShowSuggestions(false);
          return;
        }

        setAddressLoading(true);
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&countrycodes=de&limit=5`,
            {
              headers: {
                'User-Agent': 'IgelpflegestationPro/1.0'
              }
            }
          );
          const data = await response.json();
          setAddressSuggestions(data);
          setShowSuggestions(data.length > 0);
        } catch (err) {
          console.error('Address search error:', err);
          setAddressSuggestions([]);
        }
        setAddressLoading(false);
      };

      const handleAddressChange = (value) => {
        setForm({...form, finderAdresse: value});
        
        // Clear previous timer
        if (debounceTimer.current) {
          clearTimeout(debounceTimer.current);
        }

        // Set new timer
        debounceTimer.current = setTimeout(() => {
          searchAddress(value);
        }, 800);
      };

      const selectAddress = (suggestion) => {
        setForm({...form, finderAdresse: suggestion.display_name});
        setShowSuggestions(false);
        setAddressSuggestions([]);
      };

      const validate = () => {
        const newErrors = {};
        
        if (!form.name.trim()) newErrors.name = 'Name erforderlich';
        if (!form.aufnahmedatum) newErrors.aufnahmedatum = 'Aufnahmedatum erforderlich';
        if (!form.fundort.trim()) newErrors.fundort = 'Fundort erforderlich';
        if (!form.finderName.trim()) newErrors.finderName = 'Finder Name erforderlich';
        if (!form.finderTelefon.trim()) newErrors.finderTelefon = 'Telefonnummer erforderlich';
        if (form.finderTelefon && !/^\d+$/.test(form.finderTelefon.replace(/\s/g, ''))) {
          newErrors.finderTelefon = 'Nur Zahlen erlaubt';
        }
        if (form.finderEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.finderEmail)) {
          newErrors.finderEmail = 'Ungültige E-Mail-Adresse';
        }
        // finderAdresse is optional
        if (!form.geschlecht) newErrors.geschlecht = 'Geschlecht erforderlich';
        if (!form.alterSchaetzung) newErrors.alterSchaetzung = 'Alter erforderlich';
        if (!form.gewichtAktuell) newErrors.gewichtAktuell = 'Gewicht erforderlich';
        if (!form.betreuer) newErrors.betreuer = 'Betreuer erforderlich';

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      const handleSubmit = async () => {
        if (!validate()) {
          alert('Bitte alle Pflichtfelder ausfüllen!');
          return;
        }

        setSaving(true);
        
        try {
          const igelId = `IGL-${Date.now()}`;
          
          // Only save relevant fields (exclude form-only fields)
          const hedgehogData = {
            igelId,
            name: form.name,
            aufnahmedatum: form.aufnahmedatum,
            status: form.status,
            fundort: form.fundort,
            finderName: form.finderName,
            finderKontakt: `${form.finderCountryCode} ${form.finderTelefon}${form.finderEmail ? ' / ' + form.finderEmail : ''}`,
            finderCountryCode: form.finderCountryCode,
            finderTelefon: form.finderTelefon,
            finderEmail: form.finderEmail || '',
            finderAdresse: form.finderAdresse || '',
            geschlecht: form.geschlecht,
            alterSchaetzung: form.alterSchaetzung,
            gewichtAktuell: form.gewichtAktuell ? parseFloat(form.gewichtAktuell) : 0,
            betreuer: form.betreuer,
            notizen: form.notizen,
            gewichtsverlauf: form.gewichtAktuell ? [{
              datum: form.aufnahmedatum,
              gewicht: parseFloat(form.gewichtAktuell),
              notiz: 'Aufnahme',
              erfasstVon: userData.name,
              erfasstAm: new Date().toISOString()
            }] : [],
            diagnosen: [],
            behandlungen: [],
            statusHistory: [{
              status: form.status,
              datum: new Date().toISOString(),
              geaendertVon: userData.name
            }],
            erstelltVon: userData.name,
            erstelltVonId: auth.currentUser.uid,
            erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
            zuletztBearbeitetVon: userData.name,
            zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // Add ueberwinterung only if active
          if (form.ueberwinterungAktiv && form.status === 'ueberwinterung') {
            hedgehogData.ueberwinterung = {
              aktiv: true,
              startdatum: form.ueberwinterungStart || form.aufnahmedatum,
              gewichtStart: form.ueberwinterungGewicht || form.gewichtAktuell,
              notizen: ''
            };
          }
          
          await db.collection('hedgehogs').add(hedgehogData);
          if (settings?.qrPrintOnCreate) {
            setSavedHedgehog({ ...hedgehogData, id: 'new' });
          } else {
            onClose();
          }
        } catch (err) {
          alert('Fehler beim Speichern: ' + err.message);
          setSaving(false);
        }
      };

      const activeUsers = users.filter(u => u.active && !u.deleted);

      // QR print prompt after save
      if (savedHedgehog) {
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-6 text-center space-y-4">
              <div className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mx-auto">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                  <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
              </div>
              <div>
                <h2 className="text-base font-semibold text-gray-900">QR-Code drucken?</h2>
                <p className="text-xs text-gray-500 mt-1">{savedHedgehog.name} wurde gespeichert. Jetzt QR-Code ausdrucken?</p>
              </div>
              <div id="qr-print-area" className="hidden">
                <div className="qr-print-inner">
                  <div id="qrcode-container-add"></div>
                  <div style={{textAlign:'center', marginTop:'4px'}}>
                    <div style={{fontSize:'8pt', fontWeight:'bold', fontFamily:'monospace'}}>{savedHedgehog.igelId}</div>
                    <div style={{fontSize:'7pt', fontFamily:'sans-serif'}}>{savedHedgehog.name}</div>
                  </div>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => {
                    const container = document.getElementById('qrcode-container-add');
                    if (container) {
                      container.innerHTML = '';
                      const qrUrl = `${window.location.origin}${window.location.pathname}#igel-${savedHedgehog.igelId}`;
                      new QRCode(container, { text: qrUrl, width: 80, height: 80, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
                    }
                    document.getElementById('qr-print-area').classList.remove('hidden');
                    setTimeout(() => { window.print(); document.getElementById('qr-print-area').classList.add('hidden'); onClose(); }, 300);
                  }}
                  className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all"
                >
                  Drucken
                </button>
                <button onClick={onClose} className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                  Überspringen
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end slide-in">
          <div className="bg-white rounded-t-2xl w-full max-h-[92vh] overflow-y-auto shadow-xl">

            {/* Header – same as UserManagement */}
            <div className="sticky top-0 bg-white flex items-center justify-between p-5 border-b border-gray-100">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <circle cx="12" cy="8" r="4"/>
                  <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">Neuer Igel</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-4">

              {/* Basis */}
              <input type="text" placeholder="Name" value={form.name}
                onChange={(e) => setForm({...form, name: e.target.value})}
                className={`w-full border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.name ? 'border-red-400' : 'border-gray-200'}`} />

              <div className="grid grid-cols-2 gap-3">
                <select value={form.geschlecht} onChange={(e) => setForm({...form, geschlecht: e.target.value})}
                  className={`border rounded-xl px-4 py-3 text-sm bg-white focus:outline-none focus:border-gray-400 ${errors.geschlecht ? 'border-red-400' : 'border-gray-200'}`}>
                  <option value="">Geschlecht</option>
                  <option value="männlich">Männlich</option>
                  <option value="weiblich">Weiblich</option>
                </select>
                <input type="number" placeholder="Alter (Wochen)" value={form.alterSchaetzung}
                  onChange={(e) => setForm({...form, alterSchaetzung: e.target.value})}
                  className={`border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.alterSchaetzung ? 'border-red-400' : 'border-gray-200'}`} />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <input type="date" value={form.aufnahmedatum}
                  onChange={(e) => setForm({...form, aufnahmedatum: e.target.value})}
                  className={`border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.aufnahmedatum ? 'border-red-400' : 'border-gray-200'}`} />
                <input type="number" placeholder="Gewicht (g)" value={form.gewichtAktuell}
                  onChange={(e) => setForm({...form, gewichtAktuell: e.target.value})}
                  className={`border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.gewichtAktuell ? 'border-red-400' : 'border-gray-200'}`} />
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Status & Betreuer */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Status & Betreuung</p>
                <div className="space-y-3">
                  <select value={form.status} onChange={(e) => setForm({...form, status: e.target.value})}
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm bg-white focus:outline-none focus:border-gray-400">
                    <option value="aufnahme">Aufnahme</option>
                    <option value="pflege">In Pflege</option>
                    <option value="ueberwinterung">Überwinterung</option>
                    <option value="auswilderung_bereit">Auswilderungsbereit</option>
                    <option value="ausgewildert">Ausgewildert</option>
                    <option value="verstorben">Verstorben</option>
                  </select>
                  <select value={form.betreuer} onChange={(e) => setForm({...form, betreuer: e.target.value})}
                    className={`w-full border rounded-xl px-4 py-3 text-sm bg-white focus:outline-none focus:border-gray-400 ${errors.betreuer ? 'border-red-400' : 'border-gray-200'}`}>
                    {activeUsers.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                  </select>
                </div>
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Fundort */}
              <input type="text" placeholder="Fundort" value={form.fundort}
                onChange={(e) => setForm({...form, fundort: e.target.value})}
                className={`w-full border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.fundort ? 'border-red-400' : 'border-gray-200'}`} />

              {/* Finder */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Finder</p>
                <div className="space-y-3">
                  <input type="text" placeholder="Name" value={form.finderName}
                    onChange={(e) => setForm({...form, finderName: e.target.value})}
                    className={`w-full border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.finderName ? 'border-red-400' : 'border-gray-200'}`} />
                  
                  {/* Telefonnummer mit Ländercode */}
                  <div className="flex gap-2">
                    <select 
                      value={form.finderCountryCode} 
                      onChange={(e) => setForm({...form, finderCountryCode: e.target.value})}
                      className="w-24 border border-gray-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white"
                    >
                      <option value="+49">🇩🇪 +49</option>
                      <option value="+43">🇦🇹 +43</option>
                      <option value="+41">🇨🇭 +41</option>
                      <option value="+33">🇫🇷 +33</option>
                      <option value="+31">🇳🇱 +31</option>
                      <option value="+32">🇧🇪 +32</option>
                      <option value="+48">🇵🇱 +48</option>
                      <option value="+420">🇨🇿 +420</option>
                    </select>
                    <input 
                      type="tel" 
                      placeholder="Telefonnummer" 
                      value={form.finderTelefon}
                      onChange={(e) => setForm({...form, finderTelefon: e.target.value.replace(/[^\d\s]/g, '')})}
                      className={`flex-1 border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.finderTelefon ? 'border-red-400' : 'border-gray-200'}`}
                    />
                  </div>

                  {/* E-Mail */}
                  <input 
                    type="email" 
                    placeholder="E-Mail (optional)" 
                    value={form.finderEmail}
                    onChange={(e) => setForm({...form, finderEmail: e.target.value})}
                    className={`w-full border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 ${errors.finderEmail ? 'border-red-400' : 'border-gray-200'}`}
                  />
                  
                  {/* Adresse mit Autocomplete */}
                  <div className="relative">
                    <input 
                      type="text" 
                      placeholder="Adresse (optional)" 
                      value={form.finderAdresse}
                      onChange={(e) => handleAddressChange(e.target.value)}
                      onFocus={() => form.finderAdresse && searchAddress(form.finderAdresse)}
                      className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                    />
                    {addressLoading && (
                      <div className="absolute right-3 top-1/2 -translate-y-1/2">
                        <div className="w-4 h-4 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></div>
                      </div>
                    )}
                    {showSuggestions && addressSuggestions.length > 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                        {addressSuggestions.map((suggestion, i) => (
                          <button
                            key={i}
                            type="button"
                            onClick={() => selectAddress(suggestion)}
                            className="w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-50 last:border-0 transition-all"
                          >
                            <p className="text-sm font-medium text-gray-900">
                              {suggestion.address?.road && suggestion.address?.house_number 
                                ? `${suggestion.address.road} ${suggestion.address.house_number}` 
                                : suggestion.display_name.split(',')[0]
                              }
                            </p>
                            <p className="text-xs text-gray-400 mt-0.5">
                              {suggestion.address?.postcode && suggestion.address?.city
                                ? `${suggestion.address.postcode} ${suggestion.address.city}`
                                : suggestion.display_name.split(',').slice(1, 3).join(', ')
                              }
                            </p>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="border-t border-gray-100"></div>

              {/* Notizen */}
              <textarea placeholder="Notizen" value={form.notizen}
                onChange={(e) => setForm({...form, notizen: e.target.value})}
                className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 min-h-24 resize-none" />

              {/* Submit */}
              <button onClick={handleSubmit} disabled={saving}
                className="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 rounded-xl text-sm font-medium transition-all disabled:bg-gray-300 disabled:cursor-not-allowed">
                {saving ? 'Speichert...' : 'Igel aufnehmen'}
              </button>

            </div>
          </div>
        </div>
      );
    };

    // Hedgehog Detail View
    const HedgehogDetail = ({ hedgehog, userData, users, onBack, onUpdate, initialEditMode }) => {
      const isGuest = userData?.role === 'gast';
      const [edit, setEdit] = useState(!!initialEditMode && !isGuest);
      const [data, setData] = useState(hedgehog);
      const [originalData] = useState(hedgehog);
      const [isDirty, setIsDirty] = useState(false);
      const [showUnsavedModal, setShowUnsavedModal] = useState(false);
      const [showMenu, setShowMenu] = useState(false);
      const [showQR, setShowQR] = useState(false);
      const [showWeightModal, setShowWeightModal] = useState(false);
      const [showDiagnosisModal, setShowDiagnosisModal] = useState(false);
      const [showTreatmentModal, setShowTreatmentModal] = useState(false);
      const [showMedModal, setShowMedModal] = useState(false);
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [newWeightVal, setNewWeightVal] = useState('');
      const [newDiagnosisVal, setNewDiagnosisVal] = useState('');
      const [newTreatmentVal, setNewTreatmentVal] = useState('');
      const [modalSaving, setModalSaving] = useState(false);
      const [medStammdaten, setMedStammdaten] = useState({ gruppen: [], behandlungen: [], arten: [], haeufigkeiten: [] });
      const emptyMedForm = () => ({
        gruppeId: '', behandlungId: '',
        artId: '', haeufigkeitId: '',
        praeparat: '',           // Konkretes Präparat z.B. "Panacur 10%"
        menge: '', einheit: '',  // Strukturiert: 0.5 + ml
        datum: new Date().toISOString().split('T')[0],
        enddatum: '',            // Optionales Enddatum (Behandlungsdauer)
        aktiv: true,             // Aktive/abgeschlossene Medikation
        notiz: ''
      });
      const [medForm, setMedForm] = useState(emptyMedForm());
      const [medFormError, setMedFormError] = useState('');
      const topRef = useRef(null);

      // Scroll to top on open
      useEffect(() => {
        topRef.current?.scrollIntoView({ behavior: 'instant' });
      }, []);

      const updateField = (field, value) => {
        setData(d => ({ ...d, [field]: value }));
        setIsDirty(true);
      };

      const handleBack = () => {
        if (isDirty) { setShowUnsavedModal(true); } else { onBack(); }
      };

      const saveChanges = async () => {
        // Build change history entries for changed fields
        const fieldLabels = {
          name: 'Name', status: 'Status', aufnahmedatum: 'Aufnahmedatum',
          fundort: 'Fundort', finderName: 'Finder Name', finderKontakt: 'Finder Kontakt',
          geschlecht: 'Geschlecht', alterSchaetzung: 'Alter', gewichtAktuell: 'Gewicht aktuell',
          betreuer: 'Betreuer', notizen: 'Notizen', finderEmail: 'Finder E-Mail',
          finderAdresse: 'Finder Adresse'
        };
        const newHistory = [...(data.changeHistory || [])];
        Object.keys(fieldLabels).forEach(field => {
          const oldVal = String(originalData[field] || '');
          const newVal = String(data[field] || '');
          if (oldVal !== newVal) {
            newHistory.push({
              field: fieldLabels[field],
              oldValue: oldVal,
              newValue: newVal,
              changedBy: userData.name,
              changedAt: new Date().toISOString()
            });
          }
        });
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          ...data,
          changeHistory: newHistory,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setEdit(false);
        setIsDirty(false);
        onUpdate({ ...data, changeHistory: newHistory });
      };

      const addWeight = async () => {
        if (!newWeightVal || isNaN(parseFloat(newWeightVal))) return;
        setModalSaving(true);
        const newEntry = {
          datum: new Date().toISOString().split('T')[0],
          gewicht: parseFloat(newWeightVal),
          notiz: '',
          erfasstVon: userData.name,
          erfasstAm: new Date().toISOString()
        };
        const updated = {
          ...data,
          gewichtsverlauf: [...(data.gewichtsverlauf || []), newEntry],
          gewichtAktuell: newWeightVal
        };
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          gewichtsverlauf: updated.gewichtsverlauf,
          gewichtAktuell: newWeightVal,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setData(updated);
        setNewWeightVal('');
        setShowWeightModal(false);
        setModalSaving(false);
      };

      const addDiagnosis = async () => {
        if (!newDiagnosisVal.trim()) return;
        setModalSaving(true);
        const newDiag = {
          datum: new Date().toISOString().split('T')[0],
          diagnose: newDiagnosisVal.trim(),
          erfasstVon: userData.name,
          erfasstAm: new Date().toISOString()
        };
        const updated = { ...data, diagnosen: [...(data.diagnosen || []), newDiag] };
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          diagnosen: updated.diagnosen,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setData(updated);
        setNewDiagnosisVal('');
        setShowDiagnosisModal(false);
        setModalSaving(false);
      };

      const deleteHedgehog = async () => {
        try {
          await db.collection('hedgehogs').doc(hedgehog.id).delete();
          setShowDeleteModal(false);
          onBack();
        } catch (err) {
          alert('Fehler beim Löschen: ' + err.message);
        }
      };

      const addTreatment = async () => {
        if (!newTreatmentVal.trim()) return;
        setModalSaving(true);
        const newTreat = {
          datum: new Date().toISOString().split('T')[0],
          behandlung: newTreatmentVal.trim(),
          durchgefuehrtVon: userData.name,
          durchgefuehrtAm: new Date().toISOString()
        };
        const updated = { ...data, behandlungen: [...(data.behandlungen || []), newTreat] };
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          behandlungen: updated.behandlungen,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setData(updated);
        setNewTreatmentVal('');
        setShowTreatmentModal(false);
        setModalSaving(false);
      };

      const changeStatus = async (newStatus) => {
        const statusEntry = {
          status: newStatus,
          datum: new Date().toISOString(),
          geaendertVon: userData.name
        };

        await db.collection('hedgehogs').doc(hedgehog.id).update({
          status: newStatus,
          statusHistory: firebase.firestore.FieldValue.arrayUnion(statusEntry),
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });

        setData({ ...data, status: newStatus });
      };

      const activeUsers = users.filter(u => u.active);

      // Load med stammdaten
      React.useEffect(() => {
        const config = [
          { key: 'gruppen',       col: 'med_gruppen',       sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'behandlungen',  col: 'med_behandlungen',  sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'arten',         col: 'med_arten',         sort: (a,b) => (a.name||'').localeCompare(b.name||'','de') },
          { key: 'haeufigkeiten', col: 'med_haeufigkeiten', sort: (a,b) => (a.sortOrder||0)-(b.sortOrder||0) },
        ];
        const unsubs = config.map(({ key, col, sort }) =>
          db.collection(col).onSnapshot(
            snap => {
              const docs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort(sort);
              setMedStammdaten(prev => ({ ...prev, [key]: docs }));
            },
            err => console.warn(`Med ${col}:`, err.code)
          )
        );
        return () => unsubs.forEach(u => u());
      }, []);

      const addMedikation = async () => {
        // Validation
        if (!medForm.behandlungId) { setMedFormError('Behandlung ist erforderlich.'); return; }
        if (medForm.enddatum && medForm.enddatum < medForm.datum) { setMedFormError('Enddatum darf nicht vor dem Startdatum liegen.'); return; }
        const heute = new Date().toISOString().split('T')[0];
        if (medForm.datum > heute) { setMedFormError('Datum darf nicht in der Zukunft liegen.'); return; }
        setMedFormError('');
        setModalSaving(true);
        try {
          const behandlung = medStammdaten.behandlungen.find(b => b.id === medForm.behandlungId) || {};
          const art = medStammdaten.arten.find(a => a.id === medForm.artId) || {};
          const haeufigkeit = medStammdaten.haeufigkeiten.find(h => h.id === medForm.haeufigkeitId) || {};
          const gruppe = medStammdaten.gruppen.find(g => g.id === (medForm.gruppeId || behandlung.gruppeId)) || {};

          const newMed = {
            datum: medForm.datum,
            enddatum: medForm.enddatum || '',
            aktiv: medForm.enddatum ? medForm.enddatum >= heute : true,
            gruppeId: gruppe.id || '',
            gruppeName: gruppe.name || '',
            behandlungId: medForm.behandlungId,
            behandlungName: behandlung.name || '',
            artId: medForm.artId || '',
            artName: art.name || '',
            haeufigkeitId: medForm.haeufigkeitId || '',
            haeufigkeitName: haeufigkeit.name || '',
            praeparat: medForm.praeparat?.trim() || '',
            menge: medForm.menge?.trim() || '',
            einheit: medForm.einheit || '',
            notiz: medForm.notiz?.trim() || '',
            erfasstVon: userData.name,
            erfasstAm: new Date().toISOString()
          };

          const updated = { ...data, medikationen: [...(data.medikationen || []), newMed] };
          // Save ref to medikationen collection (for stammdaten usage checks)
          const medRef = await db.collection('medikationen').add({ ...newMed, igelId: hedgehog.id });
          // Store ref id in the entry for later cleanup
          newMed._medRefId = medRef.id;
          updated.medikationen[updated.medikationen.length - 1] = newMed;
          await db.collection('hedgehogs').doc(hedgehog.id).update({
            medikationen: updated.medikationen,
            zuletztBearbeitetVon: userData.name,
            zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
          });
          setData(updated);
          setMedForm(emptyMedForm());
          setShowMedModal(false);
        } catch(e) { console.error(e); setMedFormError('Fehler beim Speichern: ' + e.message); }
        setModalSaving(false);
      };

      const deleteMedikation = async (idx) => {
        const entry = (data.medikationen || [])[idx];
        const updated = { ...data, medikationen: (data.medikationen || []).filter((_,i) => i !== idx) };
        try {
          // Also remove from medikationen collection (fix: was missing before)
          if (entry?._medRefId) {
            await db.collection('medikationen').doc(entry._medRefId).delete();
          } else {
            // Fallback: find by igelId + behandlungId + datum
            const snap = await db.collection('medikationen')
              .where('igelId', '==', hedgehog.id)
              .where('behandlungId', '==', entry?.behandlungId || '')
              .where('datum', '==', entry?.datum || '')
              .get();
            const batch = db.batch();
            snap.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
          }
          await db.collection('hedgehogs').doc(hedgehog.id).update({
            medikationen: updated.medikationen,
            zuletztBearbeitetVon: userData.name,
            zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
          });
          setData(updated);
        } catch(e) { console.error(e); }
      };

      const toggleMedAktiv = async (idx) => {
        const meds = [...(data.medikationen || [])];
        meds[idx] = { ...meds[idx], aktiv: !meds[idx].aktiv };
        const updated = { ...data, medikationen: meds };
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          medikationen: meds,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setData(updated);
      };

      const fieldClass = "w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 bg-white";
      const statusLabel = { aufnahme: 'Aufnahme', pflege: 'In Pflege', ueberwinterung: 'Überwinterung', auswilderung_bereit: 'Auswilderungsbereit', ausgewildert: 'Ausgewildert', verstorben: 'Verstorben' };

      // Generate QR Code when modal opens
      useEffect(() => {
        if (showQR && typeof QRCode !== 'undefined') {
          const container = document.getElementById('qrcode-container');
          if (container) {
            container.innerHTML = ''; // Clear previous QR code
            const qrUrl = `${window.location.origin}${window.location.pathname}#igel-${data.igelId}`;
            new QRCode(container, {
              text: qrUrl,
              width: 180,
              height: 180,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        }
      }, [showQR, data.igelId]);

      return (
        <div className="min-h-screen bg-gray-50">
          <div ref={topRef} />

          {/* Unsaved Changes Modal */}
          {showUnsavedModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl p-5">
                <h2 className="text-base font-semibold text-gray-900 mb-2">Ungespeicherte Änderungen</h2>
                <p className="text-sm text-gray-500 mb-4">Es gibt ungespeicherte Änderungen. Was möchtest du tun?</p>
                <div className="space-y-2">
                  <button onClick={async () => { await saveChanges(); setShowUnsavedModal(false); onBack(); }} className="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">Speichern &amp; zurück</button>
                  <button onClick={() => { setShowUnsavedModal(false); onBack(); }} className="w-full border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">Verwerfen &amp; zurück</button>
                  <button onClick={() => setShowUnsavedModal(false)} className="w-full text-gray-400 py-2 text-sm">Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {/* Header – minimalistisch, weiß */}
          <div className="bg-white border-b border-gray-100 p-4 sticky top-0 z-40">
            <div className="flex justify-between items-center">
              <button onClick={handleBack} className="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>
                Zurück
              </button>
              <span className="text-sm font-semibold text-gray-900">{data.name || 'Igel'}</span>
              {isGuest ? <div className="w-8"/> : (
                <button onClick={() => setShowMenu(!showMenu)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
              )}
            </div>
          </div>

          {/* Dropdown Menu */}
          {showMenu && (
            <div className="fixed right-4 top-16 bg-white rounded-xl shadow-xl z-50 overflow-hidden border border-gray-100 w-44">
              {edit ? (
                <>
                  <button onClick={saveChanges} className="w-full px-4 py-3 text-left hover:bg-gray-50 text-gray-900 text-sm font-medium flex items-center gap-2 transition-all">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Speichern
                  </button>
                  <button onClick={() => setEdit(false)} className="w-full px-4 py-3 text-left hover:bg-gray-50 text-gray-500 text-sm flex items-center gap-2 border-t border-gray-100 transition-all">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    Abbrechen
                  </button>
                </>
              ) : (
                <>
                  <button onClick={() => { setEdit(true); setShowMenu(false); }} className="w-full px-4 py-3 text-left hover:bg-gray-50 text-gray-900 text-sm font-medium flex items-center gap-2 transition-all">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Bearbeiten
                  </button>
                  <button onClick={() => { setShowQR(true); setShowMenu(false); }} className="w-full px-4 py-3 text-left hover:bg-gray-50 text-gray-900 text-sm font-medium flex items-center gap-2 border-t border-gray-100 transition-all">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    QR-Code
                  </button>
                  <button onClick={() => { setShowDeleteModal(true); setShowMenu(false); }} className="w-full px-4 py-3 text-left hover:bg-gray-50 text-red-500 text-sm flex items-center gap-2 border-t border-gray-100 transition-all">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    Löschen
                  </button>
                </>
              )}
            </div>
          )}

          <div className="p-4 space-y-3 pb-20">

            {/* Meta-Info */}
            <div className="bg-gray-50 rounded-xl p-4">
              <div className="space-y-1">
                <div className="flex justify-between">
                  <span className="text-xs text-gray-400">ID</span>
                  <span className="text-xs font-mono text-gray-600">{data.igelId}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-xs text-gray-400">Aufnahme</span>
                  <span className="text-xs text-gray-600">{data.aufnahmedatum}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-xs text-gray-400">Erfasst von</span>
                  <span className="text-xs text-gray-600">{data.erstelltVon}</span>
                </div>
                {data.zuletztBearbeitetVon && (
                  <div className="flex justify-between">
                    <span className="text-xs text-gray-400">Zuletzt bearbeitet</span>
                    <span className="text-xs text-gray-600">{data.zuletztBearbeitetVon}</span>
                  </div>
                )}
              </div>
            </div>

            {/* Basisdaten */}
            <div className="bg-white rounded-xl border border-gray-100 p-4">
              <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Basisdaten</p>
              <div className="space-y-3">
                {edit ? (
                  <>
                    <input type="text" value={data.name} placeholder="Name"
                      onChange={(e) => updateField('name', e.target.value)} className={fieldClass} />
                    <select value={data.geschlecht} onChange={(e) => updateField('geschlecht', e.target.value)} className={fieldClass}>
                      <option value="">Geschlecht</option>
                      <option value="männlich">Männlich</option>
                      <option value="weiblich">Weiblich</option>
                    </select>
                    <input type="text" value={data.alterSchaetzung} placeholder="Alter (Wochen)"
                      onChange={(e) => updateField('alterSchaetzung', e.target.value)} className={fieldClass} />
                    <input type="number" value={data.gewichtAktuell || ''} placeholder="Gewicht aktuell (g)"
                      onChange={(e) => updateField('gewichtAktuell', e.target.value)} className={fieldClass} />
                    <input type="date" value={data.aufnahmedatum || ''}
                      onChange={(e) => updateField('aufnahmedatum', e.target.value)} className={fieldClass} />
                    <select value={data.betreuer} onChange={(e) => updateField('betreuer', e.target.value)} className={fieldClass}>
                      {activeUsers.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                    </select>
                    <select value={data.status} onChange={(e) => { updateField('status', e.target.value); changeStatus(e.target.value); }} className={fieldClass}>
                      <option value="aufnahme">Aufnahme</option>
                      <option value="pflege">In Pflege</option>
                      <option value="ueberwinterung">Überwinterung</option>
                      <option value="auswilderung_bereit">Auswilderungsbereit</option>
                      <option value="ausgewildert">Ausgewildert</option>
                      <option value="verstorben">Verstorben</option>
                    </select>
                  </>
                ) : (
                  <div className="space-y-2">
                    {[
                      ['Name', data.name],
                      ['Geschlecht', data.geschlecht],
                      ['Alter', data.alterSchaetzung ? `${data.alterSchaetzung} Wochen` : null],
                      ['Betreuer', data.betreuer],
                      ['Status', statusLabel[data.status] || data.status],
                    ].map(([label, value]) => (
                      <div key={label} className="flex justify-between items-baseline">
                        <span className="text-sm text-gray-400">{label}</span>
                        <span className="text-sm font-medium text-gray-900">{value || '–'}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Fundort & Finder */}
            <div className="bg-white rounded-xl border border-gray-100 p-4">
              <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Fundort & Finder</p>
              {edit ? (
                <div className="space-y-3">
                  <input type="text" value={data.fundort || ''} placeholder="Fundort"
                    onChange={(e) => updateField('fundort', e.target.value)} className={fieldClass} />
                  <input type="text" value={data.finderName || ''} placeholder="Finder Name"
                    onChange={(e) => updateField('finderName', e.target.value)} className={fieldClass} />
                  <input type="text" value={data.finderTelefon || ''} placeholder="Telefon"
                    onChange={(e) => updateField('finderTelefon', e.target.value)} className={fieldClass} />
                  <input type="email" value={data.finderEmail || ''} placeholder="E-Mail"
                    onChange={(e) => updateField('finderEmail', e.target.value)} className={fieldClass} />
                  <input type="text" value={data.finderAdresse || ''} placeholder="Adresse"
                    onChange={(e) => updateField('finderAdresse', e.target.value)} className={fieldClass} />
                </div>
              ) : (
              <div className="space-y-2">
                {[
                  ['Ort', data.fundort],
                  ['Finder', data.finderName],
                ].map(([label, value]) => (
                  <div key={label} className="flex justify-between items-baseline">
                    <span className="text-sm text-gray-400">{label}</span>
                    <span className="text-sm font-medium text-gray-900">{value || '–'}</span>
                  </div>
                ))}
                {/* Telefon - anklickbar */}
                {(data.finderTelefon || data.finderKontakt) && (
                  <div className="flex justify-between items-baseline">
                    <span className="text-sm text-gray-400">Telefon</span>
                    <a 
                      href={`tel:${data.finderCountryCode || '+49'}${data.finderTelefon || data.finderKontakt}`}
                      className="text-sm font-medium text-gray-900 underline underline-offset-2"
                    >
                      {data.finderCountryCode || '+49'} {data.finderTelefon || data.finderKontakt}
                    </a>
                  </div>
                )}
                {/* Email - anklickbar */}
                {data.finderEmail && (
                  <div className="flex justify-between items-baseline">
                    <span className="text-sm text-gray-400">E-Mail</span>
                    <a 
                      href={`mailto:${data.finderEmail}`}
                      className="text-sm font-medium text-gray-900 underline underline-offset-2"
                    >
                      {data.finderEmail}
                    </a>
                  </div>
                )}
                {data.finderAdresse && (
                  <div className="flex justify-between items-baseline">
                    <span className="text-sm text-gray-400">Adresse</span>
                    <a
                      href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.finderAdresse)}`}
                      target="_blank" rel="noopener noreferrer"
                      className="text-sm font-medium text-gray-900 underline underline-offset-2"
                    >
                      {data.finderAdresse}
                    </a>
                  </div>
                )}
              </div>
              )}
            </div>

            {/* Gewicht */}
            <div className="bg-white rounded-xl border border-gray-100 p-4">
              <div className="flex items-center justify-between mb-3">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide">Gewicht</p>
                {edit && (
                  <button onClick={() => setShowWeightModal(true)} className="text-xs font-medium text-gray-900 border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-50 transition-all">
                    + Messung
                  </button>
                )}
              </div>
              <div className="space-y-2">
                {(data.gewichtsverlauf || []).slice().reverse().map((w, i) => (
                  <div key={i} className="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                    <span className="text-sm font-semibold text-gray-900">{w.gewicht} g</span>
                    <div className="text-right">
                      <div className="text-xs text-gray-400">{w.datum}</div>
                      <div className="text-xs text-gray-400">{w.erfasstVon}</div>
                    </div>
                  </div>
                ))}
                {(!data.gewichtsverlauf || data.gewichtsverlauf.length === 0) && (
                  <p className="text-sm text-gray-400 py-2">Noch keine Messungen</p>
                )}
              </div>
            </div>

            {/* Gesundheit */}
            <div className="bg-white rounded-xl border border-gray-100 p-4">
              <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Gesundheit</p>

              <div className="mb-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">Diagnosen</span>
                  {edit && (
                    <button onClick={() => setShowDiagnosisModal(true)} className="text-xs font-medium text-gray-900 border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-50 transition-all">
                      + Diagnose
                    </button>
                  )}
                </div>
                <div className="space-y-2">
                  {(data.diagnosen || []).map((d, i) => (
                    <div key={i} className="border border-gray-100 rounded-xl p-3">
                      <p className="text-sm text-gray-900">{d.diagnose}</p>
                      <p className="text-xs text-gray-400 mt-1">{d.datum} · {d.erfasstVon}</p>
                    </div>
                  ))}
                  {(!data.diagnosen || data.diagnosen.length === 0) && (
                    <p className="text-sm text-gray-400">Keine Diagnosen</p>
                  )}
                </div>
              </div>

              <div className="border-t border-gray-100 pt-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-gray-700">Medikation</span>
                    {(data.medikationen || []).filter(m => m.aktiv !== false).length > 0 && (
                      <span className="text-[10px] font-semibold px-1.5 py-0.5 rounded-full bg-gray-900 text-white">
                        {(data.medikationen || []).filter(m => m.aktiv !== false).length} aktiv
                      </span>
                    )}
                  </div>
                  {edit && !isGuest && (
                    <button onClick={() => { setMedForm(emptyMedForm()); setMedFormError(''); setShowMedModal(true); }}
                      className="text-xs font-medium text-gray-900 border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-50 transition-all flex items-center gap-1">
                      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14"/></svg>
                      Medikation
                    </button>
                  )}
                </div>
                {(() => {
                  const meds = [...(data.medikationen || [])].sort((a,b) => {
                    // Aktive zuerst, dann nach Datum absteigend
                    if ((a.aktiv !== false) !== (b.aktiv !== false)) return (b.aktiv !== false) ? 1 : -1;
                    return (b.datum || '').localeCompare(a.datum || '');
                  });
                  const aktive = meds.filter(m => m.aktiv !== false);
                  const abgeschlossene = meds.filter(m => m.aktiv === false);

                  if (meds.length === 0) return <p className="text-sm text-gray-400">Keine Medikationen erfasst</p>;

                  const MedCard = ({ m, i, realIdx }) => (
                    <div className={`border rounded-xl p-3 transition-all ${m.aktiv === false ? 'border-gray-100 bg-gray-50 opacity-70' : 'border-gray-200 bg-white'}`}>
                      <div className="flex items-start justify-between gap-2">
                        <div className="min-w-0 flex-1">
                          {/* Zeile 1: Behandlung + Badge */}
                          <div className="flex items-center gap-2 flex-wrap">
                            <p className="text-sm font-semibold text-gray-900">{m.behandlungName}</p>
                            {m.aktiv === false
                              ? <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-gray-100 text-gray-500">abgeschlossen</span>
                              : <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-gray-900 text-white">aktiv</span>
                            }
                          </div>
                          {/* Zeile 2: Gruppe */}
                          {m.gruppeName && <p className="text-xs text-gray-400">{m.gruppeName}</p>}
                          {/* Zeile 3: Präparat */}
                          {m.praeparat && <p className="text-xs font-medium text-gray-600 mt-0.5">{m.praeparat}</p>}
                          {/* Zeile 4: Art · Menge+Einheit · Häufigkeit */}
                          <div className="flex flex-wrap gap-x-2 gap-y-0.5 mt-1">
                            {m.artName && (
                              <span className="text-xs text-gray-500 flex items-center gap-1">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
                                {m.artName}
                              </span>
                            )}
                            {(m.menge || m.einheit) && (
                              <span className="text-xs text-gray-500">{m.menge}{m.einheit ? ' ' + m.einheit : ''}</span>
                            )}
                            {m.haeufigkeitName && (
                              <span className="text-xs text-gray-500 flex items-center gap-1">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                {m.haeufigkeitName}
                              </span>
                            )}
                          </div>
                          {/* Zeile 5: Zeitraum */}
                          <p className="text-xs text-gray-400 mt-1">
                            {m.datum}{m.enddatum ? ` – ${m.enddatum}` : ''}
                          </p>
                          {/* Zeile 6: Notiz */}
                          {m.notiz && <p className="text-xs text-gray-400 italic mt-0.5">{m.notiz}</p>}
                          {/* Zeile 7: Erfasser */}
                          <p className="text-[10px] text-gray-300 mt-0.5">{m.erfasstVon}</p>
                        </div>
                        {/* Aktionen */}
                        {edit && !isGuest && (
                          <div className="flex flex-col gap-1 flex-shrink-0">
                            <button onClick={() => toggleMedAktiv(realIdx)} title={m.aktiv === false ? 'Als aktiv markieren' : 'Als abgeschlossen markieren'}
                              className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-700 transition-all">
                              {m.aktiv === false
                                ? <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                : <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>
                              }
                            </button>
                            <button onClick={() => deleteMedikation(realIdx)}
                              className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 text-gray-300 hover:text-red-400 transition-all">
                              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // Find real index in original array
                  const findRealIdx = (m) => (data.medikationen || []).findIndex(x => x === m);

                  return (
                    <div className="space-y-2">
                      {aktive.map(m => <MedCard key={findRealIdx(m)} m={m} realIdx={findRealIdx(m)} />)}
                      {abgeschlossene.length > 0 && aktive.length > 0 && (
                        <div className="flex items-center gap-3 py-1">
                          <div className="h-px flex-1 bg-gray-100"/>
                          <span className="text-[10px] text-gray-400 uppercase tracking-wide">abgeschlossen</span>
                          <div className="h-px flex-1 bg-gray-100"/>
                        </div>
                      )}
                      {abgeschlossene.map(m => <MedCard key={findRealIdx(m)} m={m} realIdx={findRealIdx(m)} />)}
                    </div>
                  );
                })()}
              </div>
            </div>

            {/* Status-Historie */}
            {data.statusHistory && data.statusHistory.length > 0 && (
              <div className="bg-white rounded-xl border border-gray-100 p-4">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Status-Verlauf</p>
                <div className="space-y-2">
                  {data.statusHistory.map((s, i) => (
                    <div key={i} className="flex justify-between items-baseline py-1 border-b border-gray-50 last:border-0">
                      <span className="text-sm font-medium text-gray-900">{statusLabel[s.status] || s.status}</span>
                      <span className="text-xs text-gray-400">{s.geaendertVon}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Notizen */}
            <div className="bg-white rounded-xl border border-gray-100 p-4">
              <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Notizen</p>
              {edit ? (
                <textarea value={data.notizen} onChange={(e) => updateField('notizen', e.target.value)}
                  className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 min-h-24 resize-none" />
              ) : (
                <p className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{data.notizen || <span className="text-gray-400">Keine Notizen</span>}</p>
              )}
            </div>

            {/* Änderungshistorie */}
            {(data.changeHistory || []).length > 0 && (
              <div className="bg-white rounded-xl border border-gray-100 p-4">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Änderungshistorie</p>
                <div className="space-y-3">
                  {[...(data.changeHistory || [])].reverse().map((entry, i) => (
                    <div key={i} className="text-xs border-b border-gray-50 pb-3 last:border-0 last:pb-0">
                      <p className="font-semibold text-gray-900">{entry.field}</p>
                      <p className="text-gray-400 mt-0.5">Vorher: <span className="text-gray-600">{entry.oldValue || '–'}</span></p>
                      <p className="text-gray-400">Nachher: <span className="text-gray-900 font-medium">{entry.newValue || '–'}</span></p>
                      <p className="text-gray-400 mt-0.5">{entry.changedBy} · {new Date(entry.changedAt).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' })}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

          </div>

          {/* Weight Modal */}
          {showWeightModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <h2 className="text-base font-semibold text-gray-900">Gewicht erfassen</h2>
                  <button onClick={() => setShowWeightModal(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-4">
                  <input
                    type="number"
                    placeholder="Gewicht in Gramm"
                    value={newWeightVal}
                    onChange={(e) => setNewWeightVal(e.target.value)}
                    autoFocus
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400"
                  />
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={addWeight} disabled={modalSaving || !newWeightVal}
                      className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      {modalSaving ? 'Speichert...' : 'Speichern'}
                    </button>
                    <button onClick={() => { setShowWeightModal(false); setNewWeightVal(''); }}
                      className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Diagnosis Modal */}
          {showDiagnosisModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <h2 className="text-base font-semibold text-gray-900">Diagnose erfassen</h2>
                  <button onClick={() => setShowDiagnosisModal(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="p-5 space-y-4">
                  <textarea
                    placeholder="Diagnose..."
                    value={newDiagnosisVal}
                    onChange={(e) => setNewDiagnosisVal(e.target.value)}
                    autoFocus
                    className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-gray-400 min-h-20 resize-none"
                  />
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={addDiagnosis} disabled={modalSaving || !newDiagnosisVal.trim()}
                      className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      {modalSaving ? 'Speichert...' : 'Speichern'}
                    </button>
                    <button onClick={() => { setShowDiagnosisModal(false); setNewDiagnosisVal(''); }}
                      className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Medikation Modal */}
          {showMedModal && (() => {
            const heute = new Date().toISOString().split('T')[0];
            const EINHEITEN = ['ml', 'mg', 'Tablette(n)', 'Tropfen', 'Kapsel(n)', 'g', 'IE', 'Sprühstoß'];
            const filteredBehandlungen = medForm.gruppeId
              ? medStammdaten.behandlungen.filter(b => b.gruppeId === medForm.gruppeId)
              : medStammdaten.behandlungen;
            const noStammdaten = medStammdaten.behandlungen.length === 0;
            return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl flex flex-col" style={{maxHeight:'92vh'}}>

                {/* Header */}
                <div className="flex items-center justify-between p-5 border-b border-gray-100 flex-shrink-0">
                  <div className="flex items-center gap-3">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">Medikation erfassen</h2>
                  </div>
                  <button onClick={() => setShowMedModal(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>

                {noStammdaten ? (
                  <div className="p-5">
                    <div className="bg-gray-50 rounded-xl p-4 text-center">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-gray-300 mx-auto mb-3">
                        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                      </svg>
                      <p className="text-sm font-medium text-gray-600 mb-1">Keine Stammdaten vorhanden</p>
                      <p className="text-xs text-gray-400">Bitte zuerst unter Datenbank → Medikation mindestens eine Gruppe und Behandlung anlegen.</p>
                    </div>
                    <button onClick={() => setShowMedModal(false)} className="w-full mt-4 border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">Schließen</button>
                  </div>
                ) : (
                <>
                <div className="flex-1 overflow-y-auto p-5 space-y-4">

                  {/* Abschnitt: Zeitraum */}
                  <div>
                    <p className="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Zeitraum</p>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <p className="text-xs font-medium text-gray-500 mb-1.5">Von *</p>
                        <input type="date" value={medForm.datum} max={heute}
                          onChange={e => setMedForm({...medForm, datum: e.target.value})}
                          className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white"/>
                      </div>
                      <div>
                        <p className="text-xs font-medium text-gray-500 mb-1.5">Bis (opt.)</p>
                        <input type="date" value={medForm.enddatum} min={medForm.datum}
                          onChange={e => setMedForm({...medForm, enddatum: e.target.value})}
                          className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white"/>
                      </div>
                    </div>
                  </div>

                  {/* Abschnitt: Behandlung */}
                  <div className="border-t border-gray-50 pt-4">
                    <p className="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Behandlung</p>

                    {/* Gruppe als Filter */}
                    <div className="mb-3">
                      <p className="text-xs font-medium text-gray-500 mb-1.5">Gruppe (Filter)</p>
                      <select value={medForm.gruppeId}
                        onChange={e => setMedForm({...medForm, gruppeId: e.target.value, behandlungId: ''})}
                        className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white">
                        <option value="">Alle Gruppen</option>
                        {medStammdaten.gruppen.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                      </select>
                    </div>

                    {/* Behandlung Pflicht */}
                    <div>
                      <p className="text-xs font-medium text-gray-500 mb-1.5">Behandlung *</p>
                      <select value={medForm.behandlungId}
                        onChange={e => setMedForm({...medForm, behandlungId: e.target.value})}
                        className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white">
                        <option value="">Behandlung wählen…</option>
                        {filteredBehandlungen.map(b => <option key={b.id} value={b.id}>{b.name}{b.gruppeName ? ` (${b.gruppeName})` : ''}</option>)}
                      </select>
                      {medForm.gruppeId && filteredBehandlungen.length === 0 && (
                        <p className="text-xs text-amber-600 mt-1 px-1">Keine Behandlungen in dieser Gruppe vorhanden.</p>
                      )}
                    </div>
                  </div>

                  {/* Abschnitt: Präparat */}
                  <div className="border-t border-gray-50 pt-4">
                    <p className="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Präparat & Dosierung</p>

                    <div className="mb-3">
                      <p className="text-xs font-medium text-gray-500 mb-1.5">Präparatname (opt.)</p>
                      <input type="text" placeholder="z. B. Panacur 10%, Baytril 2.5%"
                        value={medForm.praeparat}
                        onChange={e => setMedForm({...medForm, praeparat: e.target.value})}
                        className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white"/>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-3">
                      <div>
                        <p className="text-xs font-medium text-gray-500 mb-1.5">Menge</p>
                        <input type="number" placeholder="0.5" min="0" step="0.01"
                          value={medForm.menge}
                          onChange={e => {
                            const v = e.target.value;
                            if (v === '' || parseFloat(v) >= 0) setMedForm({...medForm, menge: v});
                          }}
                          className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white"/>
                      </div>
                      <div>
                        <p className="text-xs font-medium text-gray-500 mb-1.5">Einheit</p>
                        <select value={medForm.einheit}
                          onChange={e => setMedForm({...medForm, einheit: e.target.value})}
                          className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white">
                          <option value="">—</option>
                          {EINHEITEN.map(e => <option key={e} value={e}>{e}</option>)}
                        </select>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs font-medium text-gray-500 mb-1.5">Art</p>
                      <select value={medForm.artId}
                        onChange={e => setMedForm({...medForm, artId: e.target.value})}
                        className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white">
                        <option value="">—</option>
                        {medStammdaten.arten.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                      </select>
                    </div>
                  </div>

                  {/* Abschnitt: Verabreichung */}
                  <div className="border-t border-gray-50 pt-4">
                    <p className="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Verabreichung</p>
                    <div>
                      <p className="text-xs font-medium text-gray-500 mb-1.5">Häufigkeit</p>
                      <select value={medForm.haeufigkeitId}
                        onChange={e => setMedForm({...medForm, haeufigkeitId: e.target.value})}
                        className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 bg-white">
                        <option value="">—</option>
                        {medStammdaten.haeufigkeiten.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
                      </select>
                    </div>
                  </div>

                  {/* Notiz */}
                  <div className="border-t border-gray-50 pt-4">
                    <p className="text-xs font-medium text-gray-500 mb-1.5">Notiz / Besonderheiten</p>
                    <textarea placeholder="Optionale Anmerkung, Reaktionen, Dosierungsanpassungen…"
                      value={medForm.notiz}
                      onChange={e => setMedForm({...medForm, notiz: e.target.value})}
                      className="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-gray-400 min-h-16 resize-none"/>
                  </div>

                  {medFormError && (
                    <div className="bg-red-50 rounded-xl px-4 py-3">
                      <p className="text-xs text-red-600">{medFormError}</p>
                    </div>
                  )}
                </div>

                <div className="p-5 pt-3 border-t border-gray-100 flex-shrink-0">
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={addMedikation} disabled={modalSaving || !medForm.behandlungId}
                      className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all">
                      {modalSaving ? 'Speichert…' : 'Speichern'}
                    </button>
                    <button onClick={() => setShowMedModal(false)}
                      className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
                </>
                )}
              </div>
            </div>
            );
          })()}

          {/* Delete Confirm Modal */}
          {showDeleteModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl">
                <div className="p-5">
                  <h2 className="text-base font-semibold text-gray-900 mb-2">Igel löschen</h2>
                  <p className="text-sm text-gray-500 mb-4">
                    Möchtest du <span className="font-medium text-gray-900">{data.name}</span> wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={deleteHedgehog}
                      className="bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700 transition-all">
                      Löschen
                    </button>
                    <button onClick={() => setShowDeleteModal(false)}
                      className="border border-gray-200 text-gray-600 py-3 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all">
                      Abbrechen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
          {showQR && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4" onClick={() => setShowQR(false)}>
              <div className="bg-white rounded-2xl w-full max-w-sm shadow-xl" onClick={(e) => e.stopPropagation()} id="qr-print-area">
                <div className="flex items-center justify-between p-5 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                      <rect x="3" y="3" width="7" height="7"/>
                      <rect x="14" y="3" width="7" height="7"/>
                      <rect x="14" y="14" width="7" height="7"/>
                      <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <h2 className="text-base font-semibold text-gray-900">QR-Code</h2>
                  </div>
                  <button onClick={() => setShowQR(false)} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all no-print">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>

                <div className="p-6 flex flex-col items-center space-y-4">
                  {/* QR Code */}
                  <div id="qrcode-container" className="bg-white p-3 rounded-xl border border-gray-200"></div>
                  
                  {/* Igel Info */}
                  <div className="text-center space-y-1">
                    <p className="text-sm font-semibold text-gray-900">{data.name || 'Unbenannt'}</p>
                    <p className="text-xs text-gray-500">
                      {data.alterSchaetzung ? `${data.alterSchaetzung} Wochen` : 'Alter unbekannt'}
                      {data.geschlecht && `, ${data.geschlecht}`}
                    </p>
                    <p className="text-xs font-mono text-gray-400">{data.igelId}</p>
                  </div>

                  {/* Buttons */}
                  <div className="grid grid-cols-2 gap-3 w-full pt-2 no-print">
                    <button
                      onClick={() => window.print()}
                      className="py-3 bg-gray-900 text-white rounded-xl text-sm font-medium hover:bg-gray-700 transition-all"
                    >
                      Drucken
                    </button>
                    <button
                      onClick={() => setShowQR(false)}
                      className="py-3 border border-gray-200 text-gray-600 rounded-xl text-sm font-medium hover:bg-gray-50 transition-all"
                    >
                      Schließen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Design Specification Modal
    const DESIGN_SPEC = `# Design System — Igelpflege Pro
## Minimalistisch · Schwarz/Weiß · Professionell

---

## 1. Philosophie
Kein Farb-Noise. Keine Gradienten. Keine Emojis als UI-Elemente.
Angelehnt am Claude App Interface: clean, typografisch, funktional.

---

## 2. Farben
Hintergrund App:       bg-gray-50   #f9fafb
Hintergrund Cards:     bg-white     #ffffff
Hintergrund Sections:  bg-gray-50   #f9fafb
Text Primär:           text-gray-900  #111827
Text Sekundär:         text-gray-500  #6b7280
Text Meta:             text-gray-400  #9ca3af
Rahmen Standard:       border-gray-200  #e5e7eb
Rahmen Subtil:         border-gray-100  #f3f4f6
Button Primär:         bg-gray-900  #111827
Button Hover:          bg-gray-700  #374151
Button Disabled:       bg-gray-200, text-gray-400
Fehler:                text-red-500 / bg-red-50
Kein Blau, kein Grün für UI-Elemente.

---

## 3. Typografie
Section-Label:   text-xs font-medium text-gray-500 uppercase tracking-wide
Primärtext:      text-sm font-medium text-gray-900
Sekundärtext:    text-sm text-gray-700
Meta/Timestamp:  text-xs text-gray-400
Dialog-Titel:    text-base font-semibold text-gray-900
Hinweistext:     text-xs text-gray-500

---

## 4. Abstände & Radius
Dialog Padding:     p-5
Card Padding:       p-4
Zwischen Sections:  space-y-5
Zwischen Items:     space-y-3
Radius Dialoge:     rounded-2xl
Radius Cards:       rounded-xl
Radius Felder:      rounded-xl
Radius Buttons:     rounded-xl
Trennlinie:         <div className="border-t border-gray-100"></div>

---

## 5. Eingabefelder
className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm
           focus:outline-none focus:border-gray-400 bg-white"
Mit Fehler: border-red-400
NICHT: rounded-lg, px-3, py-1, text-xs

---

## 6. Buttons
Primär:    bg-gray-900 text-white py-3 rounded-xl text-sm font-medium hover:bg-gray-700
Sekundär:  border border-gray-200 text-gray-600 py-3 rounded-xl hover:bg-gray-50
Destruktiv: text-xs text-red-500 hover:text-red-700 font-medium (nur Text)
Mini-Aktion: text-xs border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-50
Zwei nebeneinander: grid grid-cols-2 gap-3

---

## 7. Dialog-Grundstruktur
<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div className="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto shadow-xl">
    <div className="flex items-center justify-between p-5 border-b border-gray-100">
      <div className="flex items-center gap-3">
        <svg className="text-gray-700"> ... </svg>
        <h2 className="text-base font-semibold text-gray-900">Titel</h2>
      </div>
      <button className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center
                         justify-center rounded-full hover:bg-gray-100 transition-all">
        <svg><!-- X --></svg>
      </button>
    </div>
    <div className="p-5 space-y-5"> ... </div>
  </div>
</div>

---

## 8. Bottom Sheet (von unten)
<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end slide-in">
  <div className="bg-white rounded-t-2xl w-full max-h-[92vh] overflow-y-auto shadow-xl">
    <div className="sticky top-0 bg-white flex items-center justify-between
                    p-5 border-b border-gray-100"> ... </div>
    <div className="p-5 space-y-4"> ... </div>
  </div>
</div>

---

## 9. Key-Value Zeilen (Detailansicht)
<div className="flex justify-between items-baseline">
  <span className="text-sm text-gray-400">Label</span>
  <span className="text-sm font-medium text-gray-900">{value || '–'}</span>
</div>

---

## 10. Info-Box
<div className="bg-gray-50 rounded-xl p-4">
  <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Titel</p>
  <div className="space-y-2">
    <div className="flex justify-between items-center">
      <span className="text-sm text-gray-500">Label</span>
      <span className="text-sm font-medium text-gray-900">{value}</span>
    </div>
  </div>
</div>

---

## 11. Auswahl-Modal (statt prompt/select)
Jede Option = eigene Card mit Titel + Beschreibung + Checkmark.
Ausgewählt: border-gray-900 bg-gray-50
Nicht ausgewählt: border-gray-200 hover:bg-gray-50
Checkmark: <polyline points="20 6 9 17 4 12"/> strokeWidth="2.5"

---

## 12. User-Card
<div className="border border-gray-100 rounded-xl p-4">
  Name: font-semibold text-gray-900 text-sm
  Email: text-xs text-gray-500
  Rolle: text-xs text-gray-400
  Status-Badge: text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600
  Aktionen: text-xs text-gray-600 | text-xs text-red-500 (Löschen)
  Trennlinie: border-t border-gray-50
</div>

---

## 13. Header / Navbar
App-Navbar:      bg-gradient-to-r from-blue-500 to-blue-700 (bleibt blau)
Dialog-Header:   flex items-center justify-between p-5 border-b border-gray-100
Detail-Header:   bg-white border-b border-gray-100 p-4 sticky top-0 z-40

---

## 14. Icons
Nur SVG. Keine Emojis als UI-Icons.
Größe Standard: width="18" height="18"
Größe Header:   width="20" height="20"
Stil: fill="none" stroke="currentColor" strokeWidth="2"

---

## 15. Was NIE verwenden
bg-gradient (außer App-Navbar)
Emojis als Icons (💊 ⚖️ 📍 🦔)
rounded-lg px-3 py-1 text-xs (Felder zu klein)
prompt() / confirm()
font-bold h2/h3 als Sektionen
bg-blue-50 / bg-red-50 als Info-Boxen
text-blue-600 für Links
shadow-2xl

---

## 16. Muster-Prompt für neue Seiten
"Baue [Seitenname] im Igelpflege Pro Design System:
- Weißer Dialog-Header: border-b border-gray-100, SVG-Icon + text-base font-semibold
- X-Button: w-8 h-8 rounded-full hover:bg-gray-100
- Section-Labels: text-xs uppercase tracking-wide text-gray-500 mb-3
- Cards: bg-white rounded-xl border border-gray-100 p-4
- Felder: border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-gray-400
- Primär-Button: bg-gray-900 rounded-xl py-3 text-sm font-medium
- Key/Value: flex justify-between, label text-sm text-gray-400, value text-sm font-medium text-gray-900
- Trennlinien: border-t border-gray-100
- Kein Blau, kein Grün, keine Emojis als Icons"`;

    const DesignSpec = ({ onClose }) => {
      const [copied, setCopied] = useState(false);

      const handleCopy = () => {
        navigator.clipboard.writeText(DESIGN_SPEC).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        });
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-xl">

            {/* Header */}
            <div className="flex items-center justify-between p-5 border-b border-gray-100 sticky top-0 bg-white rounded-t-2xl">
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
                <h2 className="text-base font-semibold text-gray-900">App Spezifikation</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <div className="p-5 space-y-4">

              {/* Info */}
              <div className="bg-gray-50 rounded-xl p-4">
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Design System</p>
                <p className="text-xs text-gray-400">Minimalistisch · Schwarz/Weiß · Igelpflege Pro</p>
              </div>

              {/* Copy Button */}
              <button
                onClick={handleCopy}
                className={`w-full py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2 ${
                  copied
                    ? 'bg-gray-100 text-gray-600'
                    : 'bg-gray-900 text-white hover:bg-gray-700'
                }`}
              >
                {copied ? (
                  <>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Kopiert!
                  </>
                ) : (
                  <>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Spezifikation kopieren
                  </>
                )}
              </button>

              <div className="border-t border-gray-100"></div>

              {/* Content preview */}
              <div>
                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Inhalt</p>
                <pre className="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap bg-gray-50 rounded-xl p-4 overflow-x-auto">
                  {DESIGN_SPEC}
                </pre>
              </div>

            </div>
          </div>
        </div>
      );
    };

    // Render
    // Render App
    ReactDOM.render(<App />, document.getElementById('root'));

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
