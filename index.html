<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Igelpflegestation Pro</title>
  <link rel="manifest" href="manifest.json">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: contain; }
    input, textarea, select { font-size: 16px !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyD1LbzZGypzSYvRC-RRNvT2JUTpPRMM8E4",
      authDomain: "igelstation-3c3db.firebaseapp.com",
      projectId: "igelstation-3c3db",
      storageBucket: "igelstation-3c3db.firebasestorage.app",
      messagingSenderId: "695889743897",
      appId: "1:695889743897:web:6ca27f35d25639c66b9a88"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Main App
    const App = () => {
      const [user, setUser] = useState(null);
      const [userData, setUserData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [needsSetup, setNeedsSetup] = useState(null);

      useEffect(() => {
        const init = async () => {
          // First check if admin exists
          try {
            const snapshot = await db.collection('users').where('role', '==', 'admin').get();
            setNeedsSetup(snapshot.empty);
          } catch (err) {
            console.error('Admin check error:', err);
            setNeedsSetup(false);
          }

          // Then check auth state
          auth.onAuthStateChanged(async (authUser) => {
            if (authUser) {
              const doc = await db.collection('users').doc(authUser.uid).get();
              if (doc.exists) {
                const data = doc.data();
                
                // Check if user is deleted
                if (data.deleted) {
                  await auth.signOut();
                  alert('Dein Account wurde gel√∂scht.');
                  window.location.reload();
                  return;
                }
                
                // Check if user is suspended
                if (!data.active) {
                  await auth.signOut();
                  alert('Dein Account wurde gesperrt. Bitte kontaktiere den Administrator.');
                  window.location.reload();
                  return;
                }
                
                setUser(authUser);
                setUserData(data);
                
                // Check for notifications
                if (data.notification) {
                  // Show notification
                  setTimeout(() => {
                    alert(data.notification.message);
                    // Clear notification after showing
                    db.collection('users').doc(authUser.uid).update({
                      notification: firebase.firestore.FieldValue.delete()
                    });
                  }, 500);
                }
              }
            } else {
              setUser(null);
              setUserData(null);
            }
            setLoading(false);
          });
        };
        
        init();
      }, []);

      if (loading || needsSetup === null) {
        return <LoadingScreen />;
      }

      // Check for invite code
      const params = new URLSearchParams(window.location.search);
      const inviteCode = params.get('invite');

      // If user is already logged in and there's an invite code, redirect to clean homepage
      if (user && inviteCode) {
        window.location.href = window.location.origin + window.location.pathname;
        return <LoadingScreen />;
      }

      if (inviteCode && !user) {
        return <InviteRegistration inviteCode={inviteCode} />;
      }

      // Show admin setup if no admin exists
      if (needsSetup && !user) {
        return <AdminSetup />;
      }

      if (!user) {
        return <LoginScreen />;
      }

      return <MainApp user={user} userData={userData} />;
    };

    // Loading Screen
    const LoadingScreen = () => (
      <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center">
        <div className="text-white text-center">
          <div className="text-6xl mb-4">ü¶î</div>
          <div className="text-xl">L√§dt...</div>
        </div>
      </div>
    );

    // Login Screen
    const LoginScreen = () => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPasswordSetup, setShowPasswordSetup] = useState(false);
      const [showPasswordReset, setShowPasswordReset] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          if (err.code === 'auth/user-not-found') {
            setError('Kein Account gefunden. Bitte "Passwort einrichten" nutzen.');
          } else if (err.code === 'auth/wrong-password') {
            setError('Falsches Passwort');
          } else {
            setError('Login fehlgeschlagen. Bitte Zugangsdaten pr√ºfen.');
          }
        }
        setLoading(false);
      };

      if (showPasswordSetup) {
        return <PasswordSetup onBack={() => setShowPasswordSetup(false)} />;
      }

      if (showPasswordReset) {
        return <PasswordReset onBack={() => setShowPasswordReset(false)} />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <div className="text-7xl mb-4">ü¶î</div>
              <h1 className="text-3xl font-bold mb-2">Igelpflegestation Pro</h1>
              <p className="text-gray-600">Cloud-Tierpflege-Software</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-4">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="E-Mail"
                required
                className="w-full border rounded-lg px-4 py-3"
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Passwort"
                required
                className="w-full border rounded-lg px-4 py-3"
              />
              {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}
              <button 
                type="submit" 
                disabled={loading}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-400">
                {loading ? 'Anmelden...' : 'Anmelden'}
              </button>
            </form>

            <div className="mt-6 space-y-2 text-center text-sm">
              <button
                onClick={() => setShowPasswordSetup(true)}
                className="text-blue-600 hover:text-blue-800 font-medium block w-full"
              >
                üìß Noch nicht registriert? Passwort einrichten
              </button>
              <button
                onClick={() => setShowPasswordReset(true)}
                className="text-gray-600 hover:text-gray-800 block w-full"
              >
                üîë Passwort vergessen?
              </button>
            </div>

            <div className="mt-6 pt-6 border-t">
              <p className="text-xs text-gray-500 text-center">
                Version 1.2.2 ‚Ä¢ Igelpflegestation Pro
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Password Setup Component
    const PasswordSetup = ({ onBack }) => {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [inviteFound, setInviteFound] = useState(null);
      const [inviteData, setInviteData] = useState(null);

      const checkInvite = async () => {
        if (!email) {
          setError('Bitte E-Mail eingeben');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const snapshot = await db.collection('invites')
            .where('email', '==', email)
            .where('used', '==', false)
            .limit(1)
            .get();

          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            setInviteData({ ...data, docId: snapshot.docs[0].id });
            setInviteFound(true);
          } else {
            setInviteFound(false);
            setError('Keine Einladung f√ºr diese E-Mail gefunden. Bitte kontaktiere deinen Administrator.');
          }
        } catch (err) {
          setError('Fehler beim Pr√ºfen: ' + err.message);
        }
        setLoading(false);
      };

      const handleRegister = async (e) => {
        e.preventDefault();

        if (!name.trim()) {
          setError('Bitte Namen eingeben');
          return;
        }

        if (password !== confirm) {
          setError('Passw√∂rter stimmen nicht √ºberein');
          return;
        }

        if (password.length < 6) {
          setError('Passwort muss mindestens 6 Zeichen haben');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const userCred = await auth.createUserWithEmailAndPassword(email, password);
          
          await db.collection('users').doc(userCred.user.uid).set({
            name: name.trim(),
            email: email,
            role: inviteData.role,
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          await db.collection('invites').doc(inviteData.docId).update({ 
            used: true,
            usedAt: firebase.firestore.FieldValue.serverTimestamp(),
            usedBy: userCred.user.uid
          });

          // Clean redirect to homepage without invite code
          window.location.href = window.location.origin + window.location.pathname;
        } catch (err) {
          if (err.code === 'auth/email-already-in-use') {
            setError('Diese E-Mail ist bereits registriert. Nutze "Passwort vergessen" zum Zur√ºcksetzen.');
          } else {
            setError('Registrierung fehlgeschlagen: ' + err.message);
          }
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="flex items-center mb-6">
              <button onClick={onBack} className="text-gray-600 hover:text-gray-800">
                ‚Üê Zur√ºck
              </button>
              <h2 className="text-2xl font-bold ml-4">Passwort einrichten</h2>
            </div>

            {!inviteFound ? (
              <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                  <strong>üìß Bist du eingeladen worden?</strong><br/>
                  Gib deine E-Mail-Adresse ein, die dein Administrator verwendet hat.
                </div>

                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="E-Mail-Adresse"
                  className="w-full border rounded-lg px-4 py-3"
                />

                {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}

                <button
                  onClick={checkInvite}
                  disabled={loading}
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400"
                >
                  {loading ? 'Pr√ºfe...' : 'E-Mail pr√ºfen'}
                </button>
              </div>
            ) : (
              <form onSubmit={handleRegister} className="space-y-4">
                <div className="bg-green-50 p-4 rounded-lg text-sm">
                  <strong>‚úÖ Einladung gefunden!</strong><br/>
                  E-Mail: {email}<br/>
                  Rolle: {inviteData.role === 'admin' ? 'Administrator' : inviteData.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1">Dein Name</label>
                  <input
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Vor- und Nachname"
                    required
                    className="w-full border rounded-lg px-4 py-3"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1">Passwort festlegen</label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Mindestens 6 Zeichen"
                    required
                    className="w-full border rounded-lg px-4 py-3"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1">Passwort best√§tigen</label>
                  <input
                    type="password"
                    value={confirm}
                    onChange={(e) => setConfirm(e.target.value)}
                    placeholder="Passwort wiederholen"
                    required
                    className="w-full border rounded-lg px-4 py-3"
                  />
                </div>

                {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-400"
                >
                  {loading ? 'Erstelle Account...' : 'Account erstellen'}
                </button>
              </form>
            )}
          </div>
        </div>
      );
    };

    // Password Reset Component
    const PasswordReset = ({ onBack }) => {
      const [email, setEmail] = useState('');
      const [sent, setSent] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleReset = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await auth.sendPasswordResetEmail(email);
          setSent(true);
        } catch (err) {
          if (err.code === 'auth/user-not-found') {
            setError('Keine Account mit dieser E-Mail gefunden');
          } else {
            setError('Fehler: ' + err.message);
          }
        }
        setLoading(false);
      };

      if (sent) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
              <div className="text-6xl mb-4">‚úÖ</div>
              <h2 className="text-2xl font-bold mb-4">E-Mail versendet!</h2>
              <p className="text-gray-600 mb-6">
                Wir haben dir einen Link zum Zur√ºcksetzen deines Passworts an <strong>{email}</strong> gesendet.
              </p>
              <p className="text-sm text-gray-500 mb-6">
                Pr√ºfe auch deinen Spam-Ordner, falls die E-Mail nicht ankommt.
              </p>
              <button
                onClick={onBack}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
              >
                Zur√ºck zum Login
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="flex items-center mb-6">
              <button onClick={onBack} className="text-gray-600 hover:text-gray-800">
                ‚Üê Zur√ºck
              </button>
              <h2 className="text-2xl font-bold ml-4">Passwort zur√ºcksetzen</h2>
            </div>

            <div className="bg-orange-50 p-4 rounded-lg text-sm text-orange-800 mb-6">
              <strong>üîë Passwort vergessen?</strong><br/>
              Gib deine E-Mail-Adresse ein und wir senden dir einen Link zum Zur√ºcksetzen.
            </div>

            <form onSubmit={handleReset} className="space-y-4">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="E-Mail-Adresse"
                required
                className="w-full border rounded-lg px-4 py-3"
              />

              {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 disabled:bg-gray-400"
              >
                {loading ? 'Sende E-Mail...' : 'Passwort zur√ºcksetzen'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // Admin Setup
    const AdminSetup = () => {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');

      const handleSetup = async (e) => {
        e.preventDefault();
        if (password !== confirm) {
          setError('Passw√∂rter stimmen nicht √ºberein');
          return;
        }
        if (password.length < 6) {
          setError('Passwort muss mind. 6 Zeichen haben');
          return;
        }

        try {
          const userCred = await auth.createUserWithEmailAndPassword(email, password);
          await db.collection('users').doc(userCred.user.uid).set({
            name, email,
            role: 'admin',
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          window.location.reload();
        } catch (err) {
          setError(err.message);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <div className="text-7xl mb-4">üîê</div>
              <h1 className="text-3xl font-bold mb-2">Admin-Setup</h1>
              <p className="text-gray-600">Ersten Administrator erstellen</p>
            </div>

            <form onSubmit={handleSetup} className="space-y-4">
              <input type="text" value={name} onChange={(e) => setName(e.target.value)} 
                placeholder="Name" required className="w-full border rounded-lg px-4 py-3" />
              <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} 
                placeholder="E-Mail" required className="w-full border rounded-lg px-4 py-3" />
              <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} 
                placeholder="Passwort (mind. 6 Zeichen)" required className="w-full border rounded-lg px-4 py-3" />
              <input type="password" value={confirm} onChange={(e) => setConfirm(e.target.value)} 
                placeholder="Passwort best√§tigen" required className="w-full border rounded-lg px-4 py-3" />
              {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}
              <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                Admin erstellen
              </button>
            </form>
          </div>
        </div>
      );
    };

    // Invite Registration
    const InviteRegistration = ({ inviteCode }) => {
      const [inviteData, setInviteData] = useState(null);
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(true);
      const [registering, setRegistering] = useState(false);

      useEffect(() => {
        const loadInvite = async () => {
          try {
            const snapshot = await db.collection('invites')
              .where('code', '==', inviteCode)
              .where('used', '==', false)
              .limit(1)
              .get();
            
            if (!snapshot.empty) {
              const data = snapshot.docs[0].data();
              setInviteData({ ...data, docId: snapshot.docs[0].id });
            } else {
              setError('Einladung ung√ºltig oder bereits verwendet');
            }
          } catch (err) {
            console.error('Invite load error:', err);
            setError('Fehler beim Laden der Einladung: ' + err.message);
          }
          setLoading(false);
        };
        loadInvite();
      }, [inviteCode]);

      const handleRegister = async (e) => {
        e.preventDefault();
        
        if (!name.trim()) {
          setError('Bitte Namen eingeben');
          return;
        }
        
        if (password !== confirm) {
          setError('Passw√∂rter stimmen nicht √ºberein');
          return;
        }
        
        if (password.length < 6) {
          setError('Passwort muss mindestens 6 Zeichen haben');
          return;
        }

        setRegistering(true);
        setError('');

        try {
          // Create auth user
          const userCred = await auth.createUserWithEmailAndPassword(inviteData.email, password);
          
          // Add to users collection
          await db.collection('users').doc(userCred.user.uid).set({
            name: name.trim(),
            email: inviteData.email,
            role: inviteData.role,
            active: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Mark invite as used
          await db.collection('invites').doc(inviteData.docId).update({ 
            used: true,
            usedAt: firebase.firestore.FieldValue.serverTimestamp(),
            usedBy: userCred.user.uid
          });
          
          // Clean redirect to homepage (remove invite code from URL)
          window.location.href = window.location.origin + window.location.pathname;
        } catch (err) {
          console.error('Registration error:', err);
          if (err.code === 'auth/email-already-in-use') {
            setError('Diese E-Mail ist bereits registriert');
          } else {
            setError('Registrierung fehlgeschlagen: ' + err.message);
          }
          setRegistering(false);
        }
      };

      if (loading) {
        return <LoadingScreen />;
      }

      if (error && !inviteData) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl p-8 text-center max-w-md">
              <div className="text-6xl mb-4">‚ùå</div>
              <h2 className="text-2xl font-bold mb-2">Fehler</h2>
              <p className="text-gray-600 mb-4">{error}</p>
              <a href={window.location.origin + window.location.pathname} 
                className="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg">
                Zur Startseite
              </a>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <div className="text-7xl mb-4">üéâ</div>
              <h1 className="text-3xl font-bold mb-2">Willkommen!</h1>
              <p className="text-gray-600">Du wurdest zur Igelpflegestation eingeladen</p>
            </div>

            <div className="bg-blue-50 p-4 rounded-lg mb-6">
              <p className="text-sm"><strong>E-Mail:</strong> {inviteData?.email}</p>
              <p className="text-sm"><strong>Rolle:</strong> {
                inviteData?.role === 'admin' ? 'Administrator' :
                inviteData?.role === 'mitarbeiter' ? 'Mitarbeiter' :
                'Gast (nur lesen)'
              }</p>
            </div>

            <form onSubmit={handleRegister} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Dein Name</label>
                <input 
                  type="text" 
                  value={name} 
                  onChange={(e) => setName(e.target.value)} 
                  placeholder="Vor- und Nachname" 
                  required 
                  className="w-full border rounded-lg px-4 py-3" 
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-1">Passwort festlegen</label>
                <input 
                  type="password" 
                  value={password} 
                  onChange={(e) => setPassword(e.target.value)} 
                  placeholder="Mindestens 6 Zeichen" 
                  required 
                  className="w-full border rounded-lg px-4 py-3" 
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-1">Passwort best√§tigen</label>
                <input 
                  type="password" 
                  value={confirm} 
                  onChange={(e) => setConfirm(e.target.value)} 
                  placeholder="Passwort wiederholen" 
                  required 
                  className="w-full border rounded-lg px-4 py-3" 
                />
              </div>
              
              {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{error}</div>}
              
              <button 
                type="submit" 
                disabled={registering}
                className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400">
                {registering ? 'Erstelle Account...' : 'Account erstellen'}
              </button>
            </form>

            <div className="mt-6 p-4 bg-green-50 rounded-lg">
              <p className="text-xs text-green-800">
                üí° <strong>Tipp:</strong> Nach der Registrierung kannst du die App auf deinem Homescreen installieren!
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Main App
    const MainApp = ({ user, userData }) => {
      const [hedgehogs, setHedgehogs] = useState([]);
      const [users, setUsers] = useState([]);
      const [view, setView] = useState('overview');
      const [selected, setSelected] = useState(null);
      const [search, setSearch] = useState('');
      const [filter, setFilter] = useState('alle');
      const [showUserMgmt, setShowUserMgmt] = useState(false);
      const [showAddForm, setShowAddForm] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showChangelog, setShowChangelog] = useState(false);

      const isAdmin = userData?.role === 'admin';

      // Load hedgehogs
      useEffect(() => {
        const unsubscribe = db.collection('hedgehogs')
          .orderBy('aufnahmedatum', 'desc')
          .onSnapshot(snapshot => {
            setHedgehogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });
        return () => unsubscribe();
      }, []);

      // Load users (admin only)
      useEffect(() => {
        if (!isAdmin) return;
        const unsubscribe = db.collection('users').onSnapshot(snapshot => {
          setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
      }, [isAdmin]);

      const statusOptions = [
        { value: 'aufnahme', label: 'Aufnahme', color: 'bg-red-100 text-red-800' },
        { value: 'pflege', label: 'In Pflege', color: 'bg-yellow-100 text-yellow-800' },
        { value: 'ueberwinterung', label: '√úberwinterung', color: 'bg-blue-100 text-blue-800' },
        { value: 'auswilderung_bereit', label: 'Bereit', color: 'bg-green-100 text-green-800' },
        { value: 'ausgewildert', label: 'Ausgewildert', color: 'bg-gray-100 text-gray-800' },
        { value: 'verstorben', label: 'Verstorben', color: 'bg-black text-white' }
      ];

      const getStatus = (val) => statusOptions.find(s => s.value === val) || {};

      const filteredHedgehogs = hedgehogs.filter(h => {
        const matchSearch = (h.name || '').toLowerCase().includes(search.toLowerCase()) ||
                           (h.igelId || '').toLowerCase().includes(search.toLowerCase()) ||
                           (h.fundort || '').toLowerCase().includes(search.toLowerCase());
        const matchFilter = filter === 'alle' || h.status === filter;
        return matchSearch && matchFilter;
      });

      if (view === 'detail' && selected) {
        return <HedgehogDetail 
          hedgehog={selected} 
          userData={userData}
          users={users}
          onBack={() => { setView('overview'); setSelected(null); }}
          onUpdate={(updated) => setSelected(updated)}
        />;
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Header */}
          <div className="bg-blue-600 text-white p-4 sticky top-0 z-40">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-2xl font-bold">ü¶î Igelpflege Pro</h1>
                <p className="text-sm text-blue-100">{userData?.name} {isAdmin && 'üëë'} ‚Ä¢ v1.2.2</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowChangelog(true)} 
                  className="bg-blue-500 px-3 py-2 rounded hover:bg-blue-400 text-sm" title="Changelog">
                  ‚ÑπÔ∏è
                </button>
                <button onClick={() => setShowProfile(true)} 
                  className="bg-blue-500 px-3 py-2 rounded hover:bg-blue-400 text-sm">
                  üë§
                </button>
                {isAdmin && (
                  <button onClick={() => setShowUserMgmt(true)} 
                    className="bg-blue-500 px-3 py-2 rounded hover:bg-blue-400 text-sm">
                    üë•
                  </button>
                )}
                <button onClick={() => auth.signOut()} 
                  className="bg-blue-500 px-3 py-2 rounded hover:bg-blue-400">
                  ‚Ü™Ô∏è
                </button>
              </div>
            </div>
          </div>

          {/* Stats */}
          <div className="p-4 grid grid-cols-2 gap-3">
            <div className="bg-blue-50 p-4 rounded-lg">
              <div className="text-sm text-gray-600">Gesamt</div>
              <div className="text-2xl font-bold">{hedgehogs.length}</div>
            </div>
            <div className="bg-yellow-50 p-4 rounded-lg">
              <div className="text-sm text-gray-600">In Pflege</div>
              <div className="text-2xl font-bold">{hedgehogs.filter(h => h.status === 'pflege').length}</div>
            </div>
            <div className="bg-blue-50 p-4 rounded-lg">
              <div className="text-sm text-gray-600">√úberwinterung</div>
              <div className="text-2xl font-bold">{hedgehogs.filter(h => h.status === 'ueberwinterung').length}</div>
            </div>
            <div className="bg-green-50 p-4 rounded-lg">
              <div className="text-sm text-gray-600">Ausgewildert</div>
              <div className="text-2xl font-bold">{hedgehogs.filter(h => h.status === 'ausgewildert').length}</div>
            </div>
          </div>

          {/* Search & Filter */}
          <div className="px-4 pb-4 space-y-3">
            <input
              type="text"
              placeholder="üîç Suchen..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full px-4 py-2 border rounded-lg"
            />
            <select value={filter} onChange={(e) => setFilter(e.target.value)} 
              className="w-full px-4 py-2 border rounded-lg">
              <option value="alle">Alle Status</option>
              {statusOptions.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
            </select>
            <button onClick={() => setShowAddForm(true)} 
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">
              ‚ûï Neuer Igel
            </button>
          </div>

          {/* List */}
          <div className="px-4 space-y-3 pb-20">
            {filteredHedgehogs.map(h => (
              <div key={h.id} onClick={() => { setSelected(h); setView('detail'); }}
                className="bg-white rounded-lg shadow p-4">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold text-lg">{h.name || 'Unbenannt'}</h3>
                    <p className="text-sm text-gray-500 font-mono">{h.igelId}</p>
                  </div>
                  <span className={`px-2 py-1 text-xs rounded ${getStatus(h.status).color}`}>
                    {getStatus(h.status).label}
                  </span>
                </div>
                <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                  <div>üìÖ {h.aufnahmedatum}</div>
                  <div>‚öñÔ∏è {h.gewichtAktuell ? `${h.gewichtAktuell}g` : '-'}</div>
                  <div className="col-span-2">üìç {h.fundort || '-'}</div>
                  {h.betreuer && <div className="col-span-2 text-blue-600">üë§ {h.betreuer}</div>}
                  {h.erstelltVon && <div className="col-span-2 text-xs text-gray-500">Aufgenommen: {h.erstelltVon}</div>}
                </div>
              </div>
            ))}
            {filteredHedgehogs.length === 0 && (
              <div className="text-center py-12 text-gray-500">
                <div className="text-6xl mb-4">ü¶î</div>
                <p>Keine Igel gefunden</p>
              </div>
            )}
          </div>

          {/* User Management Modal */}
          {showUserMgmt && isAdmin && (
            <UserManagement users={users} onClose={() => setShowUserMgmt(false)} />
          )}

          {/* User Profile Modal */}
          {showProfile && (
            <UserProfile userData={userData} onClose={() => setShowProfile(false)} />
          )}

          {/* Changelog Modal */}
          {showChangelog && (
            <Changelog onClose={() => setShowChangelog(false)} />
          )}

          {/* Add Form */}
          {showAddForm && (
            <AddHedgehogForm 
              userData={userData} 
              users={users}
              onClose={() => setShowAddForm(false)} 
            />
          )}
        </div>
      );
    };

    // Changelog Component
    const Changelog = ({ onClose }) => {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between">
              <h2 className="text-2xl font-bold">‚ÑπÔ∏è √úber die App</h2>
              <button onClick={onClose} className="text-2xl">‚úï</button>
            </div>

            <div className="p-6 space-y-6">
              {/* Version Info */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-bold text-lg mb-2">ü¶î Igelpflegestation Pro</h3>
                <p className="text-sm text-gray-700">Version 1.2.2</p>
                <p className="text-xs text-gray-500 mt-1">Cloud-basierte Tierpflege-Software</p>
              </div>

              {/* Changelog */}
              <div>
                <h3 className="font-bold text-lg mb-3">üìù √Ñnderungsprotokoll</h3>
                
                {/* v1.2.2 */}
                <div className="mb-4 border-l-4 border-blue-500 pl-4">
                  <div className="font-semibold text-blue-600">Version 1.2.2</div>
                  <ul className="text-sm text-gray-700 mt-2 space-y-1">
                    <li>‚Ä¢ Admin kann User l√∂schen</li>
                    <li>‚Ä¢ Verbesserte User-Sperrung</li>
                    <li>‚Ä¢ In-App Benachrichtigungen</li>
                    <li>‚Ä¢ Changelog/About-Seite</li>
                  </ul>
                </div>

                {/* v1.2.1 */}
                <div className="mb-4 border-l-4 border-green-500 pl-4">
                  <div className="font-semibold text-green-600">Version 1.2.1</div>
                  <ul className="text-sm text-gray-700 mt-2 space-y-1">
                    <li>‚Ä¢ Saubere URL nach Registrierung</li>
                    <li>‚Ä¢ Keine Redirect-Loops</li>
                  </ul>
                </div>

                {/* v1.2 */}
                <div className="mb-4 border-l-4 border-purple-500 pl-4">
                  <div className="font-semibold text-purple-600">Version 1.2</div>
                  <ul className="text-sm text-gray-700 mt-2 space-y-1">
                    <li>‚Ä¢ "Passwort einrichten" Flow</li>
                    <li>‚Ä¢ "Passwort vergessen" Funktion</li>
                    <li>‚Ä¢ E-Mail Einladungs-Pr√ºfung</li>
                  </ul>
                </div>

                {/* v1.1 */}
                <div className="mb-4 border-l-4 border-orange-500 pl-4">
                  <div className="font-semibold text-orange-600">Version 1.1</div>
                  <ul className="text-sm text-gray-700 mt-2 space-y-1">
                    <li>‚Ä¢ WhatsApp & E-Mail Share</li>
                    <li>‚Ä¢ User-Profil mit Bearbeitung</li>
                    <li>‚Ä¢ Admin kann Rollen √§ndern</li>
                    <li>‚Ä¢ Eingeladene setzen eigenen Namen</li>
                  </ul>
                </div>

                {/* v1.0 */}
                <div className="border-l-4 border-gray-500 pl-4">
                  <div className="font-semibold text-gray-600">Version 1.0 (Phase 1)</div>
                  <ul className="text-sm text-gray-700 mt-2 space-y-1">
                    <li>‚Ä¢ Firebase Cloud-Synchronisation</li>
                    <li>‚Ä¢ Benutzerverwaltung & Einladungen</li>
                    <li>‚Ä¢ Audit-Trail (wer/wann)</li>
                    <li>‚Ä¢ Standardansprechpartner</li>
                    <li>‚Ä¢ Igel-Verwaltung komplett</li>
                  </ul>
                </div>
              </div>

              {/* Credits */}
              <div className="bg-gray-50 p-4 rounded-lg text-center">
                <p className="text-xs text-gray-600">
                  Entwickelt mit ‚ù§Ô∏è f√ºr Igelpflegestationen<br/>
                  Powered by Firebase & React
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // User Profile Component
    const UserProfile = ({ userData, onClose }) => {
      const [name, setName] = useState(userData.name);
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [saving, setSaving] = useState(false);

      const handleSaveName = async () => {
        if (!name.trim()) {
          setError('Name darf nicht leer sein');
          return;
        }

        setSaving(true);
        setError('');
        try {
          await db.collection('users').doc(auth.currentUser.uid).update({
            name: name.trim()
          });
          setSuccess('Name gespeichert!');
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          setError('Fehler beim Speichern: ' + err.message);
        }
        setSaving(false);
      };

      const handleChangePassword = async () => {
        setError('');
        setSuccess('');

        if (!currentPassword || !newPassword || !confirmPassword) {
          setError('Bitte alle Felder ausf√ºllen');
          return;
        }

        if (newPassword !== confirmPassword) {
          setError('Neue Passw√∂rter stimmen nicht √ºberein');
          return;
        }

        if (newPassword.length < 6) {
          setError('Neues Passwort muss mind. 6 Zeichen haben');
          return;
        }

        setSaving(true);

        try {
          // Re-authenticate user
          const credential = firebase.auth.EmailAuthProvider.credential(
            auth.currentUser.email,
            currentPassword
          );
          await auth.currentUser.reauthenticateWithCredential(credential);

          // Update password
          await auth.currentUser.updatePassword(newPassword);

          setSuccess('Passwort erfolgreich ge√§ndert!');
          setCurrentPassword('');
          setNewPassword('');
          setConfirmPassword('');
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          if (err.code === 'auth/wrong-password') {
            setError('Aktuelles Passwort ist falsch');
          } else {
            setError('Fehler: ' + err.message);
          }
        }
        setSaving(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between">
              <h2 className="text-2xl font-bold">üë§ Mein Profil</h2>
              <button onClick={onClose} className="text-2xl">‚úï</button>
            </div>

            <div className="p-6 space-y-6">
              {/* Account Info */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-bold mb-2">Account-Informationen</h3>
                <div className="space-y-1 text-sm">
                  <div><strong>E-Mail:</strong> {userData.email}</div>
                  <div><strong>Rolle:</strong> {
                    userData.role === 'admin' ? 'üëë Administrator' :
                    userData.role === 'mitarbeiter' ? 'üíº Mitarbeiter' :
                    'üëÅÔ∏è Gast (nur lesen)'
                  }</div>
                </div>
              </div>

              {/* Edit Name */}
              <div>
                <h3 className="font-bold mb-3">Name √§ndern</h3>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full border rounded-lg px-4 py-2 mb-3"
                />
                <button
                  onClick={handleSaveName}
                  disabled={saving || name === userData.name}
                  className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                >
                  {saving ? 'Speichert...' : 'Name speichern'}
                </button>
              </div>

              {/* Change Password */}
              <div>
                <h3 className="font-bold mb-3">Passwort √§ndern</h3>
                <div className="space-y-3">
                  <input
                    type="password"
                    placeholder="Aktuelles Passwort"
                    value={currentPassword}
                    onChange={(e) => setCurrentPassword(e.target.value)}
                    className="w-full border rounded-lg px-4 py-2"
                  />
                  <input
                    type="password"
                    placeholder="Neues Passwort (mind. 6 Zeichen)"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    className="w-full border rounded-lg px-4 py-2"
                  />
                  <input
                    type="password"
                    placeholder="Neues Passwort best√§tigen"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    className="w-full border rounded-lg px-4 py-2"
                  />
                  <button
                    onClick={handleChangePassword}
                    disabled={saving}
                    className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400"
                  >
                    {saving ? '√Ñndert...' : 'Passwort √§ndern'}
                  </button>
                </div>
              </div>

              {/* Messages */}
              {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                  {error}
                </div>
              )}
              {success && (
                <div className="bg-green-50 text-green-600 p-3 rounded-lg text-sm">
                  ‚úì {success}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // User Management
    const UserManagement = ({ users, onClose }) => {
      const [showInvite, setShowInvite] = useState(false);
      const [email, setEmail] = useState('');
      const [role, setRole] = useState('mitarbeiter');
      const [link, setLink] = useState('');
      const [loading, setLoading] = useState(false);

      const generateInvite = async () => {
        if (!email) {
          alert('Bitte E-Mail eingeben');
          return;
        }
        
        setLoading(true);
        try {
          const code = Math.random().toString(36).substring(2, 15);
          await db.collection('invites').add({
            code, 
            email, 
            role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: auth.currentUser.uid,
            used: false
          });
          const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${code}`;
          setLink(inviteLink);
        } catch (err) {
          alert('Fehler beim Erstellen: ' + err.message);
        }
        setLoading(false);
      };

      const shareViaWhatsApp = () => {
        const text = `Hey! Du wurdest zur Igelpflegestation eingeladen. ü¶î\n\nRegistriere dich hier und installiere die App:\n${link}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
      };

      const shareViaEmail = () => {
        const subject = 'Einladung zur Igelpflegestation';
        const body = `Hallo!\n\nDu wurdest zur Igelpflegestation eingeladen. ü¶î\n\nBitte registriere dich hier und installiere die App auf deinem Smartphone:\n\n${link}\n\nViele Gr√º√üe\nDein Team`;
        window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };

      const changeRole = async (userId, currentRole) => {
        const newRole = prompt('Neue Rolle:\n\nadmin = Administrator\nmitarbeiter = Mitarbeiter\ngast = Gast (nur lesen)', currentRole);
        if (newRole && ['admin', 'mitarbeiter', 'gast'].includes(newRole)) {
          await db.collection('users').doc(userId).update({ role: newRole });
        }
      };

      const deleteUser = async (userId, userName) => {
        if (!window.confirm(`Benutzer "${userName}" wirklich L√ñSCHEN?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!`)) {
          return;
        }

        try {
          // Mark user as deleted and add notification
          await db.collection('users').doc(userId).update({
            deleted: true,
            deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
            notification: {
              type: 'account_deleted',
              message: 'Dein Account wurde vom Administrator gel√∂scht.',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }
          });
          
          alert(`Benutzer "${userName}" wurde gel√∂scht.`);
        } catch (err) {
          alert('Fehler beim L√∂schen: ' + err.message);
        }
      };

      const suspendUser = async (userId, userName, currentActive) => {
        const action = currentActive ? 'sperren' : 'entsperren';
        if (!window.confirm(`Benutzer "${userName}" wirklich ${action}?`)) {
          return;
        }

        try {
          const notification = currentActive ? {
            type: 'account_suspended',
            message: 'Dein Account wurde vom Administrator gesperrt. Bitte kontaktiere den Administrator.',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          } : {
            type: 'account_activated',
            message: 'Dein Account wurde wieder aktiviert.',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          await db.collection('users').doc(userId).update({ 
            active: !currentActive,
            notification
          });
        } catch (err) {
          alert('Fehler: ' + err.message);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between">
              <h2 className="text-2xl font-bold">üë• Benutzerverwaltung</h2>
              <button onClick={onClose} className="text-2xl">‚úï</button>
            </div>

            <div className="p-6 space-y-6">
              <button onClick={() => setShowInvite(!showInvite)} 
                className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold">
                ‚ûï Benutzer einladen
              </button>

              {showInvite && (
                <div className="bg-green-50 p-4 rounded-lg space-y-3">
                  <h3 className="font-bold">Einladung erstellen</h3>
                  <input 
                    type="email" 
                    placeholder="E-Mail des neuen Benutzers" 
                    value={email} 
                    onChange={(e) => setEmail(e.target.value)} 
                    className="w-full border rounded-lg px-3 py-2" 
                  />
                  <select value={role} onChange={(e) => setRole(e.target.value)} 
                    className="w-full border rounded-lg px-3 py-2">
                    <option value="mitarbeiter">Mitarbeiter (kann alles bearbeiten)</option>
                    <option value="gast">Gast (nur lesen)</option>
                    <option value="admin">Administrator (volle Rechte)</option>
                  </select>
                  <button onClick={generateInvite} disabled={loading}
                    className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                    {loading ? 'Erstelle...' : 'Einladungslink generieren'}
                  </button>

                  {link && (
                    <div className="bg-white p-4 rounded border space-y-3">
                      <p className="text-sm font-semibold">‚úÖ Einladung erstellt!</p>
                      <div className="flex gap-2">
                        <input type="text" value={link} readOnly 
                          className="flex-1 bg-gray-50 px-3 py-2 rounded text-sm" />
                        <button onClick={() => navigator.clipboard.writeText(link)} 
                          className="bg-blue-600 text-white px-4 py-2 rounded text-sm whitespace-nowrap">
                          üìã Kopieren
                        </button>
                      </div>
                      
                      <div className="flex gap-2">
                        <button onClick={shareViaWhatsApp}
                          className="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600 flex items-center justify-center gap-2">
                          <span className="text-xl">üì±</span> WhatsApp
                        </button>
                        <button onClick={shareViaEmail}
                          className="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2">
                          <span className="text-xl">üìß</span> E-Mail
                        </button>
                      </div>

                      <p className="text-xs text-gray-600">
                        üí° Der eingeladene Benutzer kann seinen Namen und Passwort selbst festlegen.
                      </p>
                    </div>
                  )}
                </div>
              )}

              <div>
                <h3 className="font-bold mb-3">Benutzer ({users.length})</h3>
                <div className="space-y-2">
                  {users.filter(u => !u.deleted).map(u => (
                    <div key={u.id} className="bg-white border rounded-lg p-4">
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                          <div className="font-semibold">{u.name} {u.role === 'admin' && 'üëë'}</div>
                          <div className="text-sm text-gray-600">{u.email}</div>
                          <div className="text-xs text-gray-500 mt-1">
                            Rolle: {u.role === 'admin' ? 'Administrator' : u.role === 'mitarbeiter' ? 'Mitarbeiter' : 'Gast'}
                          </div>
                        </div>
                        <button onClick={() => suspendUser(u.id, u.name, u.active)} 
                          className={`px-3 py-1 rounded text-sm ${u.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                          {u.active ? '‚úì Aktiv' : 'üö´ Gesperrt'}
                        </button>
                      </div>
                      <div className="flex gap-2 mt-3">
                        <button onClick={() => changeRole(u.id, u.role)}
                          className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                          üîÑ Rolle √§ndern
                        </button>
                        <button onClick={() => deleteUser(u.id, u.name)}
                          className="text-sm text-red-600 hover:text-red-800 flex items-center gap-1">
                          üóëÔ∏è L√∂schen
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Add Hedgehog Form
    const AddHedgehogForm = ({ userData, users, onClose }) => {
      const [form, setForm] = useState({
        name: '',
        aufnahmedatum: new Date().toISOString().split('T')[0],
        status: 'aufnahme',
        fundort: '',
        finderName: '',
        finderKontakt: '',
        geschlecht: '',
        alterSchaetzung: '',
        gewichtAktuell: '',
        betreuer: userData.name,
        notizen: ''
      });

      const handleSubmit = async () => {
        const igelId = `IGL-${Date.now()}`;
        await db.collection('hedgehogs').add({
          ...form,
          igelId,
          gewichtsverlauf: form.gewichtAktuell ? [{
            datum: form.aufnahmedatum,
            gewicht: parseFloat(form.gewichtAktuell),
            notiz: 'Aufnahme',
            erfasstVon: userData.name,
            erfasstAm: firebase.firestore.FieldValue.serverTimestamp()
          }] : [],
          diagnosen: [],
          behandlungen: [],
          statusHistory: [{
            status: 'aufnahme',
            datum: firebase.firestore.FieldValue.serverTimestamp(),
            geaendertVon: userData.name
          }],
          erstelltVon: userData.name,
          erstelltVonId: auth.currentUser.uid,
          erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        onClose();
      };

      const activeUsers = users.filter(u => u.active);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
          <div className="bg-white rounded-t-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between">
              <h2 className="text-xl font-bold">Neuer Igel</h2>
              <button onClick={onClose} className="text-2xl">‚úï</button>
            </div>

            <div className="p-4 space-y-4">
              <input type="text" placeholder="Name" value={form.name} 
                onChange={(e) => setForm({...form, name: e.target.value})} 
                className="w-full border rounded-lg px-3 py-2" />

              <div className="grid grid-cols-2 gap-3">
                <select value={form.geschlecht} onChange={(e) => setForm({...form, geschlecht: e.target.value})} 
                  className="border rounded-lg px-3 py-2">
                  <option value="">Geschlecht</option>
                  <option value="m√§nnlich">M√§nnlich</option>
                  <option value="weiblich">Weiblich</option>
                </select>
                <input type="text" placeholder="Alter" value={form.alterSchaetzung} 
                  onChange={(e) => setForm({...form, alterSchaetzung: e.target.value})} 
                  className="border rounded-lg px-3 py-2" />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <input type="date" value={form.aufnahmedatum} 
                  onChange={(e) => setForm({...form, aufnahmedatum: e.target.value})} 
                  className="border rounded-lg px-3 py-2" />
                <input type="number" placeholder="Gewicht (g)" value={form.gewichtAktuell} 
                  onChange={(e) => setForm({...form, gewichtAktuell: e.target.value})} 
                  className="border rounded-lg px-3 py-2" />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Betreuer (Standardansprechpartner)</label>
                <select value={form.betreuer} onChange={(e) => setForm({...form, betreuer: e.target.value})} 
                  className="w-full border rounded-lg px-3 py-2">
                  {activeUsers.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                </select>
              </div>

              <input type="text" placeholder="Fundort" value={form.fundort} 
                onChange={(e) => setForm({...form, fundort: e.target.value})} 
                className="w-full border rounded-lg px-3 py-2" />

              <div className="grid grid-cols-2 gap-3">
                <input type="text" placeholder="Finder Name" value={form.finderName} 
                  onChange={(e) => setForm({...form, finderName: e.target.value})} 
                  className="border rounded-lg px-3 py-2" />
                <input type="text" placeholder="Finder Kontakt" value={form.finderKontakt} 
                  onChange={(e) => setForm({...form, finderKontakt: e.target.value})} 
                  className="border rounded-lg px-3 py-2" />
              </div>

              <textarea placeholder="Notizen" value={form.notizen} 
                onChange={(e) => setForm({...form, notizen: e.target.value})} 
                className="w-full border rounded-lg px-3 py-2 min-h-20" />

              <button onClick={handleSubmit} 
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">
                Igel aufnehmen
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Hedgehog Detail View
    const HedgehogDetail = ({ hedgehog, userData, users, onBack, onUpdate }) => {
      const [edit, setEdit] = useState(false);
      const [data, setData] = useState(hedgehog);
      const [showMenu, setShowMenu] = useState(false);

      const saveChanges = async () => {
        await db.collection('hedgehogs').doc(hedgehog.id).update({
          ...data,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        setEdit(false);
        onUpdate(data);
      };

      const addWeight = async () => {
        const weight = prompt('Gewicht in Gramm:');
        if (!weight) return;
        
        const newEntry = {
          datum: new Date().toISOString().split('T')[0],
          gewicht: parseFloat(weight),
          notiz: '',
          erfasstVon: userData.name,
          erfasstAm: firebase.firestore.FieldValue.serverTimestamp()
        };

        const updated = {
          ...data,
          gewichtsverlauf: [...(data.gewichtsverlauf || []), newEntry],
          gewichtAktuell: weight
        };

        await db.collection('hedgehogs').doc(hedgehog.id).update({
          gewichtsverlauf: updated.gewichtsverlauf,
          gewichtAktuell: weight,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });

        setData(updated);
      };

      const addDiagnosis = async () => {
        const diag = prompt('Diagnose:');
        if (!diag) return;

        const newDiag = {
          datum: new Date().toISOString().split('T')[0],
          diagnose: diag,
          erfasstVon: userData.name,
          erfasstAm: firebase.firestore.FieldValue.serverTimestamp()
        };

        const updated = {
          ...data,
          diagnosen: [...(data.diagnosen || []), newDiag]
        };

        await db.collection('hedgehogs').doc(hedgehog.id).update({
          diagnosen: updated.diagnosen,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });

        setData(updated);
      };

      const addTreatment = async () => {
        const treat = prompt('Behandlung:');
        if (!treat) return;

        const newTreat = {
          datum: new Date().toISOString().split('T')[0],
          behandlung: treat,
          durchgefuehrtVon: userData.name,
          durchgefuehrtAm: firebase.firestore.FieldValue.serverTimestamp()
        };

        const updated = {
          ...data,
          behandlungen: [...(data.behandlungen || []), newTreat]
        };

        await db.collection('hedgehogs').doc(hedgehog.id).update({
          behandlungen: updated.behandlungen,
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });

        setData(updated);
      };

      const changeStatus = async (newStatus) => {
        const statusEntry = {
          status: newStatus,
          datum: firebase.firestore.FieldValue.serverTimestamp(),
          geaendertVon: userData.name
        };

        await db.collection('hedgehogs').doc(hedgehog.id).update({
          status: newStatus,
          statusHistory: firebase.firestore.FieldValue.arrayUnion(statusEntry),
          zuletztBearbeitetVon: userData.name,
          zuletztBearbeitetAm: firebase.firestore.FieldValue.serverTimestamp()
        });

        setData({ ...data, status: newStatus });
      };

      const activeUsers = users.filter(u => u.active);

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="bg-blue-600 text-white p-4 sticky top-0 z-40">
            <div className="flex justify-between items-center">
              <button onClick={onBack}>‚Üê Zur√ºck</button>
              <h1 className="font-bold truncate mx-2">{data.name || 'Igel'}</h1>
              <button onClick={() => setShowMenu(!showMenu)}>‚ò∞</button>
            </div>
          </div>

          {showMenu && (
            <div className="absolute right-4 top-16 bg-white rounded-lg shadow-lg z-50">
              {edit ? (
                <>
                  <button onClick={saveChanges} className="w-full px-4 py-3 text-left hover:bg-gray-50">üíæ Speichern</button>
                  <button onClick={() => setEdit(false)} className="w-full px-4 py-3 text-left hover:bg-gray-50">‚úï Abbrechen</button>
                </>
              ) : (
                <button onClick={() => setEdit(true)} className="w-full px-4 py-3 text-left hover:bg-gray-50">‚úèÔ∏è Bearbeiten</button>
              )}
            </div>
          )}

          <div className="p-4 space-y-4 pb-20">
            {/* Info Box */}
            <div className="bg-blue-50 p-4 rounded-lg text-sm">
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <strong>ID:</strong> {data.igelId}
                </div>
                <div>
                  <strong>Status:</strong> {data.status}
                </div>
                <div className="col-span-2">
                  <strong>Betreuer:</strong> {data.betreuer || '-'}
                </div>
                <div className="col-span-2 text-xs text-gray-600">
                  Erstellt: {data.erstelltVon} am {data.aufnahmedatum}
                </div>
                {data.zuletztBearbeitetVon && (
                  <div className="col-span-2 text-xs text-gray-600">
                    Zuletzt bearbeitet: {data.zuletztBearbeitetVon}
                  </div>
                )}
              </div>
            </div>

            {/* Basisdaten */}
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="font-bold mb-3">Basisdaten</h2>
              <div className="space-y-2">
                <div>
                  <strong>Name:</strong>
                  {edit ? (
                    <input type="text" value={data.name} onChange={(e) => setData({...data, name: e.target.value})} 
                      className="w-full border rounded px-2 py-1 mt-1" />
                  ) : (
                    <span className="ml-2">{data.name || '-'}</span>
                  )}
                </div>
                <div>
                  <strong>Geschlecht:</strong>
                  {edit ? (
                    <select value={data.geschlecht} onChange={(e) => setData({...data, geschlecht: e.target.value})} 
                      className="w-full border rounded px-2 py-1 mt-1">
                      <option value="">-</option>
                      <option value="m√§nnlich">M√§nnlich</option>
                      <option value="weiblich">Weiblich</option>
                    </select>
                  ) : (
                    <span className="ml-2">{data.geschlecht || '-'}</span>
                  )}
                </div>
                <div>
                  <strong>Alter:</strong>
                  {edit ? (
                    <input type="text" value={data.alterSchaetzung} onChange={(e) => setData({...data, alterSchaetzung: e.target.value})} 
                      className="w-full border rounded px-2 py-1 mt-1" />
                  ) : (
                    <span className="ml-2">{data.alterSchaetzung || '-'}</span>
                  )}
                </div>
                <div>
                  <strong>Betreuer:</strong>
                  {edit ? (
                    <select value={data.betreuer} onChange={(e) => setData({...data, betreuer: e.target.value})} 
                      className="w-full border rounded px-2 py-1 mt-1">
                      {activeUsers.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                    </select>
                  ) : (
                    <span className="ml-2">{data.betreuer || '-'}</span>
                  )}
                </div>
                <div>
                  <strong>Status √§ndern:</strong>
                  {edit && (
                    <select value={data.status} onChange={(e) => changeStatus(e.target.value)} 
                      className="w-full border rounded px-2 py-1 mt-1">
                      <option value="aufnahme">Aufnahme</option>
                      <option value="pflege">In Pflege</option>
                      <option value="ueberwinterung">√úberwinterung</option>
                      <option value="auswilderung_bereit">Bereit</option>
                      <option value="ausgewildert">Ausgewildert</option>
                      <option value="verstorben">Verstorben</option>
                    </select>
                  )}
                </div>
              </div>
            </div>

            {/* Fundort */}
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="font-bold mb-3">üìç Fundort</h2>
              <div className="space-y-2 text-sm">
                <div><strong>Ort:</strong> {data.fundort || '-'}</div>
                <div><strong>Finder:</strong> {data.finderName || '-'}</div>
                <div><strong>Kontakt:</strong> {data.finderKontakt || '-'}</div>
              </div>
            </div>

            {/* Gewicht */}
            <div className="bg-white rounded-lg shadow p-4">
              <div className="flex justify-between mb-3">
                <h2 className="font-bold">‚öñÔ∏è Gewicht</h2>
                {edit && <button onClick={addWeight} className="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ Messung</button>}
              </div>
              <div className="space-y-2">
                {(data.gewichtsverlauf || []).slice().reverse().map((w, i) => (
                  <div key={i} className="bg-gray-50 p-2 rounded flex justify-between text-sm">
                    <span className="font-semibold">{w.gewicht}g</span>
                    <div className="text-right">
                      <div className="text-gray-600">{w.datum}</div>
                      <div className="text-xs text-blue-600">{w.erfasstVon}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Gesundheit */}
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="font-bold mb-3">üíä Gesundheit</h2>
              
              <div className="mb-4">
                <div className="flex justify-between mb-2">
                  <strong className="text-sm">Diagnosen</strong>
                  {edit && <button onClick={addDiagnosis} className="bg-blue-600 text-white px-2 py-1 rounded text-xs">+</button>}
                </div>
                <div className="space-y-2">
                  {(data.diagnosen || []).map((d, i) => (
                    <div key={i} className="bg-red-50 p-2 rounded text-sm">
                      <div className="text-xs text-gray-600">{d.datum} ‚Ä¢ {d.erfasstVon}</div>
                      <div>{d.diagnose}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div>
                <div className="flex justify-between mb-2">
                  <strong className="text-sm">Behandlungen</strong>
                  {edit && <button onClick={addTreatment} className="bg-green-600 text-white px-2 py-1 rounded text-xs">+</button>}
                </div>
                <div className="space-y-2">
                  {(data.behandlungen || []).map((t, i) => (
                    <div key={i} className="bg-green-50 p-2 rounded text-sm">
                      <div className="text-xs text-gray-600">{t.datum} ‚Ä¢ {t.durchgefuehrtVon}</div>
                      <div>{t.behandlung}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Status Historie */}
            {data.statusHistory && data.statusHistory.length > 0 && (
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="font-bold mb-3">üìã Status-Historie</h2>
                <div className="space-y-2">
                  {data.statusHistory.map((s, i) => (
                    <div key={i} className="text-sm bg-gray-50 p-2 rounded">
                      <strong>{s.status}</strong>
                      <div className="text-xs text-gray-600">
                        Ge√§ndert von: {s.geaendertVon}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Notizen */}
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="font-bold mb-3">üìù Notizen</h2>
              {edit ? (
                <textarea value={data.notizen} onChange={(e) => setData({...data, notizen: e.target.value})} 
                  className="w-full border rounded px-3 py-2 min-h-24" />
              ) : (
                <p className="text-sm whitespace-pre-wrap">{data.notizen || 'Keine Notizen'}</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
