<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="Verwaltung und Dokumentation der Igelpflege">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Igelpflege">
  <title>Igelpflegestation</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232563eb'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eü¶î%3C/text%3E%3C/svg%3E">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }

    .install-prompt {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    input, textarea, select {
      font-size: 16px !important; /* Verhindert Auto-Zoom auf iOS */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Plus, Search, Calendar, Weight, Activity, MapPin, User, FileText, ArrowRight, Trash2, Edit2, Save, X, LogOut, Download, Menu } = lucide;

    const IgelPflegestationPWA = () => {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [currentUser, setCurrentUser] = useState(null);
      const [showInstallPrompt, setShowInstallPrompt] = useState(false);
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      
      const [hedgehogs, setHedgehogs] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterStatus, setFilterStatus] = useState('alle');
      const [activeView, setActiveView] = useState('overview');
      const [selectedHedgehog, setSelectedHedgehog] = useState(null);
      const [editMode, setEditMode] = useState(false);
      const [showAddForm, setShowAddForm] = useState(false);
      const [showMenu, setShowMenu] = useState(false);

      // Check login status on mount
      useEffect(() => {
        const checkLogin = async () => {
          try {
            if (window.storage) {
              const result = await window.storage.get('current-user');
              if (result && result.value) {
                const user = JSON.parse(result.value);
                setCurrentUser(user);
                setIsLoggedIn(true);
              }
            } else {
              // Fallback to localStorage
              const stored = localStorage.getItem('current-user');
              if (stored) {
                const user = JSON.parse(stored);
                setCurrentUser(user);
                setIsLoggedIn(true);
              }
            }
          } catch (error) {
            console.log('Nicht eingeloggt');
          }
        };
        checkLogin();
      }, []);

      // PWA Install prompt
      useEffect(() => {
        const handler = (e) => {
          e.preventDefault();
          setDeferredPrompt(e);
          setShowInstallPrompt(true);
        };

        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
      }, []);

      // Load hedgehogs data
      useEffect(() => {
        if (!isLoggedIn) return;
        
        const loadData = async () => {
          try {
            if (window.storage) {
              const result = await window.storage.get('hedgehogs-data', true);
              if (result && result.value) {
                setHedgehogs(JSON.parse(result.value));
              }
            } else {
              // Fallback to localStorage
              const stored = localStorage.getItem('hedgehogs-data');
              if (stored) {
                setHedgehogs(JSON.parse(stored));
              }
            }
          } catch (error) {
            console.log('Keine Daten gefunden');
          }
        };
        loadData();
      }, [isLoggedIn]);

      // Save hedgehogs data
      useEffect(() => {
        if (hedgehogs.length > 0 && isLoggedIn) {
          const saveData = async () => {
            try {
              if (window.storage) {
                await window.storage.set('hedgehogs-data', JSON.stringify(hedgehogs), true);
              } else {
                // Fallback to localStorage
                localStorage.setItem('hedgehogs-data', JSON.stringify(hedgehogs));
              }
            } catch (error) {
              console.error('Speicherfehler:', error);
              // Try localStorage as fallback
              try {
                localStorage.setItem('hedgehogs-data', JSON.stringify(hedgehogs));
              } catch (e) {
                console.error('Auch localStorage fehlgeschlagen:', e);
              }
            }
          };
          saveData();
        }
      }, [hedgehogs, isLoggedIn]);

      const handleInstallClick = async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        setDeferredPrompt(null);
        setShowInstallPrompt(false);
      };

      const handleLogin = async (email, name) => {
        const user = {
          email,
          name,
          loginTime: new Date().toISOString()
        };
        
        try {
          // Try to use storage, but fallback to sessionStorage if not available
          if (window.storage) {
            await window.storage.set('current-user', JSON.stringify(user));
          } else {
            // Fallback to localStorage
            localStorage.setItem('current-user', JSON.stringify(user));
          }
          setCurrentUser(user);
          setIsLoggedIn(true);
        } catch (error) {
          console.error('Login-Fehler:', error);
          // Even if storage fails, allow login (app will work without persistence)
          setCurrentUser(user);
          setIsLoggedIn(true);
        }
      };

      const handleLogout = async () => {
        try {
          if (window.storage) {
            await window.storage.delete('current-user');
          } else {
            localStorage.removeItem('current-user');
          }
          setCurrentUser(null);
          setIsLoggedIn(false);
          setActiveView('overview');
          setSelectedHedgehog(null);
        } catch (error) {
          console.error('Logout-Fehler:', error);
          // Force logout anyway
          setCurrentUser(null);
          setIsLoggedIn(false);
        }
      };

      const statusOptions = [
        { value: 'aufnahme', label: 'Aufnahme', color: 'bg-red-100 text-red-800' },
        { value: 'pflege', label: 'In Pflege', color: 'bg-yellow-100 text-yellow-800' },
        { value: 'ueberwinterung', label: '√úberwinterung', color: 'bg-blue-100 text-blue-800' },
        { value: 'auswilderung_bereit', label: 'Bereit zur Auswilderung', color: 'bg-green-100 text-green-800' },
        { value: 'ausgewildert', label: 'Ausgewildert', color: 'bg-gray-100 text-gray-800' },
        { value: 'verstorben', label: 'Verstorben', color: 'bg-black text-white' }
      ];

      const [formData, setFormData] = useState({
        id: '',
        name: '',
        aufnahmedatum: new Date().toISOString().split('T')[0],
        status: 'aufnahme',
        fundort: '',
        finderName: '',
        finderKontakt: '',
        geschlecht: '',
        alterSchaetzung: '',
        gewichtAktuell: '',
        gewichtsverlauf: [],
        diagnosen: [],
        behandlungen: [],
        notizen: '',
        auswilderungsdatum: '',
        auswilderungsort: ''
      });

      const handleAddHedgehog = () => {
        const newId = `IGL-${Date.now()}`;
        const newHedgehog = {
          ...formData,
          id: newId,
          gewichtsverlauf: formData.gewichtAktuell ? [{
            datum: formData.aufnahmedatum,
            gewicht: parseFloat(formData.gewichtAktuell),
            notiz: 'Aufnahmegewicht'
          }] : [],
          erstelltAm: new Date().toISOString(),
          erstelltVon: currentUser.name
        };
        
        setHedgehogs([...hedgehogs, newHedgehog]);
        setShowAddForm(false);
        resetForm();
      };

      const resetForm = () => {
        setFormData({
          id: '',
          name: '',
          aufnahmedatum: new Date().toISOString().split('T')[0],
          status: 'aufnahme',
          fundort: '',
          finderName: '',
          finderKontakt: '',
          geschlecht: '',
          alterSchaetzung: '',
          gewichtAktuell: '',
          gewichtsverlauf: [],
          diagnosen: [],
          behandlungen: [],
          notizen: '',
          auswilderungsdatum: '',
          auswilderungsort: ''
        });
      };

      const handleUpdateHedgehog = () => {
        setHedgehogs(hedgehogs.map(h => 
          h.id === selectedHedgehog.id ? selectedHedgehog : h
        ));
        setEditMode(false);
      };

      const handleDeleteHedgehog = (id) => {
        if (window.confirm('M√∂chten Sie diesen Igel wirklich l√∂schen?')) {
          setHedgehogs(hedgehogs.filter(h => h.id !== id));
          setSelectedHedgehog(null);
          setActiveView('overview');
        }
      };

      const addWeightEntry = () => {
        if (!selectedHedgehog.gewichtAktuell) return;
        
        const newEntry = {
          datum: new Date().toISOString().split('T')[0],
          gewicht: parseFloat(selectedHedgehog.gewichtAktuell),
          notiz: ''
        };
        
        setSelectedHedgehog({
          ...selectedHedgehog,
          gewichtsverlauf: [...selectedHedgehog.gewichtsverlauf, newEntry]
        });
      };

      const addDiagnosis = () => {
        const diagnosis = prompt('Neue Diagnose eingeben:');
        if (diagnosis) {
          setSelectedHedgehog({
            ...selectedHedgehog,
            diagnosen: [...selectedHedgehog.diagnosen, {
              datum: new Date().toISOString().split('T')[0],
              diagnose: diagnosis
            }]
          });
        }
      };

      const addTreatment = () => {
        const treatment = prompt('Neue Behandlung eingeben:');
        if (treatment) {
          setSelectedHedgehog({
            ...selectedHedgehog,
            behandlungen: [...selectedHedgehog.behandlungen, {
              datum: new Date().toISOString().split('T')[0],
              behandlung: treatment
            }]
          });
        }
      };

      const filteredHedgehogs = hedgehogs.filter(h => {
        const matchesSearch = h.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                             h.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                             h.fundort.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = filterStatus === 'alle' || h.status === filterStatus;
        return matchesSearch && matchesStatus;
      });

      const getStatusColor = (status) => {
        return statusOptions.find(s => s.value === status)?.color || 'bg-gray-100';
      };

      const getStatusLabel = (status) => {
        return statusOptions.find(s => s.value === status)?.label || status;
      };

      // Login Screen
      if (!isLoggedIn) {
        return <LoginScreen onLogin={handleLogin} />;
      }

      // Install Prompt
      const InstallPrompt = () => {
        if (!showInstallPrompt) return null;

        return (
          <div className="fixed bottom-0 left-0 right-0 bg-blue-600 text-white p-4 shadow-lg install-prompt z-50">
            <div className="max-w-md mx-auto flex items-center justify-between">
              <div className="flex-1">
                <p className="font-semibold">App installieren</p>
                <p className="text-sm text-blue-100">Auf dem Homescreen speichern</p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={handleInstallClick}
                  className="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50"
                >
                  <Download className="w-5 h-5" />
                </button>
                <button
                  onClick={() => setShowInstallPrompt(false)}
                  className="text-white hover:text-blue-100"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
        );
      };

      const StatCard = ({ icon: Icon, label, value, color = "bg-blue-50" }) => (
        <div className={`${color} p-4 rounded-lg`}>
          <div className="flex items-center gap-2 text-gray-600 text-sm mb-1">
            <Icon className="w-4 h-4" />
            {label}
          </div>
          <div className="text-2xl font-bold">{value}</div>
        </div>
      );

      // Detail View
      if (activeView === 'detail' && selectedHedgehog) {
        return (
          <div className="min-h-screen bg-gray-50">
            <InstallPrompt />
            
            {/* Mobile Header */}
            <div className="bg-blue-600 text-white p-4 sticky top-0 z-40">
              <div className="flex items-center justify-between">
                <button
                  onClick={() => {
                    setActiveView('overview');
                    setSelectedHedgehog(null);
                    setEditMode(false);
                  }}
                  className="text-white"
                >
                  ‚Üê Zur√ºck
                </button>
                <h1 className="font-bold text-lg truncate mx-2">{selectedHedgehog.name || 'Igel'}</h1>
                <button onClick={() => setShowMenu(!showMenu)} className="text-white">
                  <Menu className="w-6 h-6" />
                </button>
              </div>
            </div>

            {/* Menu Dropdown */}
            {showMenu && (
              <div className="absolute right-4 top-16 bg-white rounded-lg shadow-lg z-50 overflow-hidden">
                {editMode ? (
                  <>
                    <button
                      onClick={() => { handleUpdateHedgehog(); setShowMenu(false); }}
                      className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-2"
                    >
                      <Save className="w-4 h-4" /> Speichern
                    </button>
                    <button
                      onClick={() => { setEditMode(false); setShowMenu(false); }}
                      className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-2"
                    >
                      <X className="w-4 h-4" /> Abbrechen
                    </button>
                  </>
                ) : (
                  <>
                    <button
                      onClick={() => { setEditMode(true); setShowMenu(false); }}
                      className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-2"
                    >
                      <Edit2 className="w-4 h-4" /> Bearbeiten
                    </button>
                    <button
                      onClick={() => { handleDeleteHedgehog(selectedHedgehog.id); setShowMenu(false); }}
                      className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-2 text-red-600"
                    >
                      <Trash2 className="w-4 h-4" /> L√∂schen
                    </button>
                  </>
                )}
              </div>
            )}

            <div className="p-4 pb-20 space-y-4">
              {/* Status Badge */}
              <div className={`inline-block px-3 py-1 rounded-full text-sm ${getStatusColor(selectedHedgehog.status)}`}>
                {getStatusLabel(selectedHedgehog.status)}
              </div>

              {/* Basisdaten */}
              <div className="bg-white rounded-lg shadow-sm p-4">
                <h2 className="text-lg font-bold mb-3">Basisdaten</h2>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    {editMode ? (
                      <input
                        type="text"
                        value={selectedHedgehog.name}
                        onChange={(e) => setSelectedHedgehog({...selectedHedgehog, name: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    ) : (
                      <p className="text-gray-900">{selectedHedgehog.name || '-'}</p>
                    )}
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Geschlecht</label>
                      {editMode ? (
                        <select
                          value={selectedHedgehog.geschlecht}
                          onChange={(e) => setSelectedHedgehog({...selectedHedgehog, geschlecht: e.target.value})}
                          className="w-full border rounded-lg px-3 py-2"
                        >
                          <option value="">Unbekannt</option>
                          <option value="m√§nnlich">M√§nnlich</option>
                          <option value="weiblich">Weiblich</option>
                        </select>
                      ) : (
                        <p className="text-gray-900">{selectedHedgehog.geschlecht || '-'}</p>
                      )}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Alter</label>
                      {editMode ? (
                        <input
                          type="text"
                          value={selectedHedgehog.alterSchaetzung}
                          onChange={(e) => setSelectedHedgehog({...selectedHedgehog, alterSchaetzung: e.target.value})}
                          className="w-full border rounded-lg px-3 py-2"
                        />
                      ) : (
                        <p className="text-gray-900">{selectedHedgehog.alterSchaetzung || '-'}</p>
                      )}
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    {editMode ? (
                      <select
                        value={selectedHedgehog.status}
                        onChange={(e) => setSelectedHedgehog({...selectedHedgehog, status: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      >
                        {statusOptions.map(opt => (
                          <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                      </select>
                    ) : (
                      <p className="text-gray-900">{getStatusLabel(selectedHedgehog.status)}</p>
                    )}
                  </div>
                </div>
              </div>

              {/* Fundortdaten */}
              <div className="bg-white rounded-lg shadow-sm p-4">
                <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
                  <MapPin className="w-5 h-5" /> Fundort
                </h2>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                    {editMode ? (
                      <input
                        type="text"
                        value={selectedHedgehog.fundort}
                        onChange={(e) => setSelectedHedgehog({...selectedHedgehog, fundort: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    ) : (
                      <p className="text-gray-900">{selectedHedgehog.fundort || '-'}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Finder</label>
                    {editMode ? (
                      <input
                        type="text"
                        value={selectedHedgehog.finderName}
                        onChange={(e) => setSelectedHedgehog({...selectedHedgehog, finderName: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    ) : (
                      <p className="text-gray-900">{selectedHedgehog.finderName || '-'}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Kontakt</label>
                    {editMode ? (
                      <input
                        type="text"
                        value={selectedHedgehog.finderKontakt}
                        onChange={(e) => setSelectedHedgehog({...selectedHedgehog, finderKontakt: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    ) : (
                      <p className="text-gray-900">{selectedHedgehog.finderKontakt || '-'}</p>
                    )}
                  </div>
                </div>
              </div>

              {/* Gewicht */}
              <div className="bg-white rounded-lg shadow-sm p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-bold flex items-center gap-2">
                    <Weight className="w-5 h-5" /> Gewicht
                  </h2>
                  {editMode && (
                    <button
                      onClick={addWeightEntry}
                      className="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm"
                    >
                      + Messung
                    </button>
                  )}
                </div>
                
                {editMode && (
                  <div className="mb-3 p-3 bg-blue-50 rounded-lg">
                    <label className="block text-sm font-medium mb-1">Aktuelles Gewicht (g)</label>
                    <input
                      type="number"
                      value={selectedHedgehog.gewichtAktuell}
                      onChange={(e) => setSelectedHedgehog({...selectedHedgehog, gewichtAktuell: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2"
                    />
                  </div>
                )}

                <div className="space-y-2">
                  {selectedHedgehog.gewichtsverlauf && selectedHedgehog.gewichtsverlauf.length > 0 ? (
                    selectedHedgehog.gewichtsverlauf.slice().reverse().map((entry, idx) => (
                      <div key={idx} className="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span className="font-semibold">{entry.gewicht}g</span>
                        <span className="text-sm text-gray-600">{entry.datum}</span>
                      </div>
                    ))
                  ) : (
                    <p className="text-gray-500 text-sm">Keine Messungen</p>
                  )}
                </div>
              </div>

              {/* Gesundheit */}
              <div className="bg-white rounded-lg shadow-sm p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-bold flex items-center gap-2">
                    <Activity className="w-5 h-5" /> Gesundheit
                  </h2>
                  {editMode && (
                    <div className="flex gap-2">
                      <button
                        onClick={addDiagnosis}
                        className="bg-blue-600 text-white px-2 py-1 rounded text-sm"
                      >
                        + Diagnose
                      </button>
                      <button
                        onClick={addTreatment}
                        className="bg-green-600 text-white px-2 py-1 rounded text-sm"
                      >
                        + Behandlung
                      </button>
                    </div>
                  )}
                </div>

                <div className="space-y-3">
                  <div>
                    <h3 className="font-semibold text-sm mb-2">Diagnosen</h3>
                    {selectedHedgehog.diagnosen && selectedHedgehog.diagnosen.length > 0 ? (
                      <div className="space-y-2">
                        {selectedHedgehog.diagnosen.map((d, idx) => (
                          <div key={idx} className="p-2 bg-red-50 rounded text-sm">
                            <div className="text-gray-600 text-xs">{d.datum}</div>
                            <div>{d.diagnose}</div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-500 text-sm">Keine Diagnosen</p>
                    )}
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm mb-2">Behandlungen</h3>
                    {selectedHedgehog.behandlungen && selectedHedgehog.behandlungen.length > 0 ? (
                      <div className="space-y-2">
                        {selectedHedgehog.behandlungen.map((t, idx) => (
                          <div key={idx} className="p-2 bg-green-50 rounded text-sm">
                            <div className="text-gray-600 text-xs">{t.datum}</div>
                            <div>{t.behandlung}</div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-500 text-sm">Keine Behandlungen</p>
                    )}
                  </div>
                </div>
              </div>

              {/* Notizen */}
              <div className="bg-white rounded-lg shadow-sm p-4">
                <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
                  <FileText className="w-5 h-5" /> Notizen
                </h2>
                {editMode ? (
                  <textarea
                    value={selectedHedgehog.notizen}
                    onChange={(e) => setSelectedHedgehog({...selectedHedgehog, notizen: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 min-h-24"
                  />
                ) : (
                  <p className="text-gray-700 whitespace-pre-wrap">{selectedHedgehog.notizen || 'Keine Notizen'}</p>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Overview (Main Screen)
      return (
        <div className="min-h-screen bg-gray-50 pb-20">
          <InstallPrompt />
          
          {/* Header */}
          <div className="bg-blue-600 text-white p-4 sticky top-0 z-40 shadow-md">
            <div className="flex items-center justify-between mb-3">
              <div>
                <h1 className="text-2xl font-bold">ü¶î Igelpflege</h1>
                <p className="text-blue-100 text-sm">Angemeldet als {currentUser.name}</p>
              </div>
              <button
                onClick={handleLogout}
                className="text-white hover:text-blue-100"
              >
                <LogOut className="w-6 h-6" />
              </button>
            </div>
          </div>

          <div className="p-4 space-y-4">
            {/* Statistics */}
            <div className="grid grid-cols-2 gap-3">
              <StatCard icon={Activity} label="Gesamt" value={hedgehogs.length} color="bg-blue-50" />
              <StatCard icon={Calendar} label="In Pflege" value={hedgehogs.filter(h => h.status === 'pflege').length} color="bg-yellow-50" />
              <StatCard icon={Weight} label="√úberwinterung" value={hedgehogs.filter(h => h.status === 'ueberwinterung').length} color="bg-blue-50" />
              <StatCard icon={ArrowRight} label="Ausgewildert" value={hedgehogs.filter(h => h.status === 'ausgewildert').length} color="bg-green-50" />
            </div>

            {/* Search & Filter */}
            <div className="bg-white rounded-lg shadow-sm p-4 space-y-3">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                <input
                  type="text"
                  placeholder="Suchen..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border rounded-lg"
                />
              </div>
              <select
                value={filterStatus}
                onChange={(e) => setFilterStatus(e.target.value)}
                className="w-full px-4 py-2 border rounded-lg"
              >
                <option value="alle">Alle Status</option>
                {statusOptions.map(opt => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>

            {/* Add Button */}
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 font-semibold shadow-md"
            >
              <Plus className="w-5 h-5" />
              Neuer Igel
            </button>

            {/* Hedgehog List */}
            <div className="space-y-3">
              {filteredHedgehogs.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <div className="text-6xl mb-4">ü¶î</div>
                  <p className="text-lg mb-2">Keine Igel gefunden</p>
                  <p className="text-sm">F√ºge deinen ersten Igel hinzu</p>
                </div>
              ) : (
                filteredHedgehogs.map(hedgehog => {
                  const latestWeight = hedgehog.gewichtsverlauf && hedgehog.gewichtsverlauf.length > 0
                    ? hedgehog.gewichtsverlauf[hedgehog.gewichtsverlauf.length - 1].gewicht
                    : hedgehog.gewichtAktuell || '-';

                  return (
                    <div
                      key={hedgehog.id}
                      onClick={() => {
                        setSelectedHedgehog(hedgehog);
                        setActiveView('detail');
                      }}
                      className="bg-white rounded-lg shadow-sm p-4 active:bg-gray-50"
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <h3 className="font-bold text-lg">{hedgehog.name || 'Unbenannt'}</h3>
                          <p className="text-sm text-gray-500 font-mono">{hedgehog.id}</p>
                        </div>
                        <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(hedgehog.status)}`}>
                          {getStatusLabel(hedgehog.status)}
                        </span>
                      </div>
                      <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                        <div>üìÖ {hedgehog.aufnahmedatum}</div>
                        <div>‚öñÔ∏è {latestWeight !== '-' ? `${latestWeight}g` : '-'}</div>
                        <div className="col-span-2">üìç {hedgehog.fundort || '-'}</div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>

          {/* Add Form Modal */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
              <div className="bg-white rounded-t-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
                  <h2 className="text-xl font-bold">Neuer Igel</h2>
                  <button onClick={() => { setShowAddForm(false); resetForm(); }}>
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name</label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) => setFormData({...formData, name: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Geschlecht</label>
                      <select
                        value={formData.geschlecht}
                        onChange={(e) => setFormData({...formData, geschlecht: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      >
                        <option value="">Unbekannt</option>
                        <option value="m√§nnlich">M√§nnlich</option>
                        <option value="weiblich">Weiblich</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Alter</label>
                      <input
                        type="text"
                        value={formData.alterSchaetzung}
                        onChange={(e) => setFormData({...formData, alterSchaetzung: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Aufnahmedatum</label>
                      <input
                        type="date"
                        value={formData.aufnahmedatum}
                        onChange={(e) => setFormData({...formData, aufnahmedatum: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Gewicht (g)</label>
                      <input
                        type="number"
                        value={formData.gewichtAktuell}
                        onChange={(e) => setFormData({...formData, gewichtAktuell: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Fundort</label>
                    <input
                      type="text"
                      value={formData.fundort}
                      onChange={(e) => setFormData({...formData, fundort: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">Finder Name</label>
                      <input
                        type="text"
                        value={formData.finderName}
                        onChange={(e) => setFormData({...formData, finderName: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Finder Kontakt</label>
                      <input
                        type="text"
                        value={formData.finderKontakt}
                        onChange={(e) => setFormData({...formData, finderKontakt: e.target.value})}
                        className="w-full border rounded-lg px-3 py-2"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Notizen</label>
                    <textarea
                      value={formData.notizen}
                      onChange={(e) => setFormData({...formData, notizen: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2 min-h-20"
                    />
                  </div>

                  <button
                    onClick={handleAddHedgehog}
                    className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold"
                  >
                    Igel aufnehmen
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Login Screen Component
    const LoginScreen = ({ onLogin }) => {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim() && email.trim()) {
          onLogin(email, name);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <div className="text-7xl mb-4">ü¶î</div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">Igelpflegestation</h1>
              <p className="text-gray-600">Melde dich an um fortzufahren</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Dein Name"
                  required
                  className="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="deine@email.de"
                  required
                  className="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
              >
                Anmelden
              </button>
            </form>

            <div className="mt-6 pt-6 border-t">
              <p className="text-xs text-gray-500 text-center">
                Deine Daten werden sicher auf diesem Ger√§t gespeichert
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('Service Worker registriert'))
          .catch(err => console.log('Service Worker Fehler:', err));
      });
    }

    // Render App
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<IgelPflegestationPWA />);
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    lucide.createIcons();
  </script>
</body>
</html>
